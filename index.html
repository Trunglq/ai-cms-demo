
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CMS Demo</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 250px; 
            min-width: 250px; 
            background-color: #f8f9fa; 
            padding: 20px;
            flex-shrink: 0;
            border-right: 1px solid #dee2e6;
        }
        .main-content { 
            flex-grow: 1; 
            padding: 20px;
            min-width: 0;
        }
        .list-group-item { 
            cursor: pointer; 
            border: none;
            border-radius: 8px !important;
            margin-bottom: 2px;
            transition: all 0.2s ease;
            color: #495057;
            font-weight: 400;
        }
        .list-group-item:hover {
            background-color: #e9ecef;
            color: #495057;
            transform: translateX(2px);
        }
        .list-group-item.active, .list-group-item:active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        .list-group-item i {
            width: 20px;
            text-align: center;
            opacity: 0.7;
        }
        .list-group-item:hover i, .list-group-item.active i {
            opacity: 1;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
        }
        .translation-output {
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .content-output {
            line-height: 1.6;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .content-output h3, .content-output h4, .content-output h5 {
            color: #0d6efd;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .content-output p {
            margin-bottom: 0.75rem;
            text-align: justify;
        }
        .content-output strong {
            color: #212529;
            font-weight: 600;
        }
        .hot-topic-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        .hot-topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: #0d6efd;
        }
        .hot-topic-card.selected {
            border: 2px solid #0d6efd !important;
            background-color: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(13, 110, 253, 0.15);
        }
        .hot-topic-card .badge {
            font-size: 10px;
        }
        .hot-topic-card .card-title {
            font-size: 14px;
            line-height: 1.3;
            margin-bottom: 8px;
        }
        .hot-topic-card .card-text {
            font-size: 11px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .hot-topic-card-main {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        .hot-topic-card-main:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #0d6efd;
        }
        .hot-topic-card-main .card-title {
            font-size: 15px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 10px;
            color: #212529;
        }
        .hot-topic-card-main .card-text {
            font-size: 13px;
            line-height: 1.4;
            color: #6c757d;
        }
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }
        /* Force horizontal layout for statistics cards - STRONGER CSS */
        #hotTopicsStats {
            display: block !important;
        }
        #hotTopicsStats .row {
            display: flex !important;
            flex-wrap: nowrap !important;
            gap: 0.75rem !important;
            justify-content: space-between !important;
        }
        #hotTopicsStats .col-6,
        #hotTopicsStats .col-md-3 {
            flex: 1 1 0% !important;
            min-width: 0 !important;
            padding: 0 !important;
        }
        @media (max-width: 991.98px) {
            #hotTopicsStats .row {
                flex-wrap: wrap !important;
            }
            #hotTopicsStats .col-6 {
                flex: 1 1 45% !important;
                margin-bottom: 0.75rem;
            }
        }
        /* Ensure card content is properly aligned */
        #hotTopicsStats .card {
            height: 100% !important;
            min-height: 80px !important;
        }
        #hotTopicsStats .d-flex {
            align-items: center !important;
            justify-content: flex-start !important;
            text-align: left !important;
        }
        #hotTopicsStats .card-body {
            padding: 0.75rem !important;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4 class="mb-3 text-center text-primary fw-bold"><i class="fas fa-cogs me-2"></i>Menu T√≠nh NƒÉng</h4>
        <div class="list-group">
            <a class="list-group-item list-group-item-action" data-feature="ai-write"><i class="fas fa-edit me-2"></i>AI vi·∫øt b√†i t·ª± ƒë·ªông</a>
            <a class="list-group-item list-group-item-action" data-feature="spell-check"><i class="fas fa-spell-check me-2 text-success"></i>Ki·ªÉm tra l·ªói ch√≠nh t·∫£</a>
            <a class="list-group-item list-group-item-action" data-feature="hot-topics"><i class="fas fa-fire me-2"></i>G·ª£i √Ω ch·ªß ƒë·ªÅ HOT</a>
            <a class="list-group-item list-group-item-action" data-feature="content-summary"><i class="fas fa-compress-alt me-2"></i>T√≥m t·∫Øt n·ªôi dung</a>
            <a class="list-group-item list-group-item-action" data-feature="tts"><i class="fas fa-volume-up me-2"></i>Text to Speech</a>
            <a class="list-group-item list-group-item-action" data-feature="stt"><i class="fas fa-microphone me-2"></i>Speech to Text</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-en-vi"><i class="fas fa-language me-2 text-success"></i>D·ªãch Anh sang Vi·ªát</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-vi-en"><i class="fas fa-exchange-alt me-2 text-success"></i>D·ªãch Vi·ªát sang Anh</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-url"><i class="fas fa-link me-2 text-success"></i>D·ªãch t·ª´ URL b√°o</a>
            <a class="list-group-item list-group-item-action" data-feature="publish"><i class="fas fa-rocket me-2"></i>Xu·∫•t b·∫£n ƒëa n·ªÅn t·∫£ng</a>
            <a class="list-group-item list-group-item-action" data-feature="score-article"><i class="fas fa-chart-bar me-2"></i>Ch·∫•m ƒëi·ªÉm b√†i b√°o</a>
            <a class="list-group-item list-group-item-action" data-feature="image-manage"><i class="fas fa-images me-2"></i>Qu·∫£n l√Ω ·∫£nh b·∫±ng AI</a>
        </div>
    </div>
    <div class="main-content" id="feature-content">
        <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi AI CMS Demo</h2>
        <p>Ch·ªçn m·ªôt t√≠nh nƒÉng t·ª´ menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // For local testing only: Paste your OpenAI key here. Remove or leave empty for production (uses serverless).
        const LOCAL_OPENAI_KEY = ''; // Paste 'sk-proj-...' here for local test. Do not commit!

        document.querySelectorAll('.list-group-item').forEach(item => {
            item.addEventListener('click', async function() {
                const feature = this.getAttribute('data-feature');
                const content = document.getElementById('feature-content');
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

                if (feature === 'translate-en-vi' || feature === 'translate-vi-en') {
                    const fromLang = feature === 'translate-en-vi' ? 'Anh' : 'Vi·ªát';
                    const toLang = feature === 'translate-en-vi' ? 'Vi·ªát' : 'Anh';
                    const direction = feature === 'translate-en-vi' ? 'en-vi' : 'vi-en';
                    const inputLabel = `Nh·∫≠p vƒÉn b·∫£n ti·∫øng ${fromLang}:`;
                    const outputLabel = `K·∫øt qu·∫£ d·ªãch (ti·∫øng ${toLang}):`;

                    content.innerHTML = `
                        <h2>D·ªãch ${fromLang} sang ${toLang}</h2>
                        <div class="mb-3">
                            <label for="inputText" class="form-label">${inputLabel}</label>
                            <textarea class="form-control" id="inputText" rows="5"></textarea>
                        </div>
                        <button id="translateBtn" class="btn btn-primary">D·ªãch</button>
                        <div class="mt-3" style="min-width: 0;">
                            <label class="form-label">${outputLabel}</label>
                            <div class="translation-output border p-3 bg-light" style="min-height: 100px; position: relative;">
                                <button id="copyBtn" class="btn btn-sm btn-outline-secondary copy-btn" style="display: none;" onclick="copyToClipboard()">
                                    üìã Copy
                                </button>
                                <div id="outputText"></div>
                            </div>
                        </div>
                    `;

                    // Add copy function to global scope
                    window.copyToClipboard = function() {
                        const outputText = document.getElementById('outputText').innerText;
                        if (outputText && outputText !== 'ƒêang d·ªãch...') {
                            navigator.clipboard.writeText(outputText).then(() => {
                                const copyBtn = document.getElementById('copyBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '‚úÖ ƒê√£ copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-secondary');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-secondary');
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy: ', err);
                                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
                            });
                        }
                    };

                    document.getElementById('translateBtn').addEventListener('click', async () => {
                        const input = document.getElementById('inputText').value;
                        if (!input) return alert('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!');
                        
                        // Show loading state
                        const outputElement = document.getElementById('outputText');
                        const copyBtn = document.getElementById('copyBtn');
                        outputElement.innerText = 'ƒêang d·ªãch...';
                        copyBtn.style.display = 'none';

                        try {
                            let response;
                            if (isLocal && LOCAL_OPENAI_KEY) {
                                // Local direct call for testing
                                response = await fetch('https://api.openai.com/v1/chat/completions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${LOCAL_OPENAI_KEY}`
                                    },
                                    body: JSON.stringify({
                                        model: 'gpt-3.5-turbo',
                                        messages: [{ role: 'user', content: `D·ªãch vƒÉn b·∫£n sau t·ª´ ti·∫øng ${fromLang} sang ti·∫øng ${toLang}: ${input}` }]
                                    })
                                });
                            } else {
                                // Production: Call serverless endpoint
                                response = await fetch('/api/translate', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ text: input, direction })
                                });
                            }

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const data = await response.json();
                            const translatedText = isLocal ? data.choices[0].message.content : data.translatedText;
                            outputElement.innerText = translatedText;
                            
                            // Show copy button after successful translation
                            if (translatedText && translatedText !== 'ƒêang d·ªãch...') {
                                copyBtn.style.display = 'block';
                            }
                        } catch (error) {
                            console.error(error);
                            outputElement.innerText = 'L·ªói khi d·ªãch. Vui l√≤ng th·ª≠ l·∫°i.';
                            copyBtn.style.display = 'none';
                            alert('L·ªói khi g·ªçi API: ' + error.message + ' (N·∫øu local, ki·ªÉm tra key v√† m·∫°ng)');
                        }
                    });
                } else if (feature === 'spell-check') {
                    content.innerHTML = `
                        <h2>Ki·ªÉm tra l·ªói ch√≠nh t·∫£</h2>
                        <div class="mb-3">
                            <label for="inputText" class="form-label">Nh·∫≠p vƒÉn b·∫£n c·∫ßn ki·ªÉm tra:</label>
                            <textarea class="form-control" id="inputText" rows="5"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <select id="languageSelect" class="form-select mb-3">
                                    <option value="vi">Ti·∫øng Vi·ªát</option>
                                    <option value="en">Ti·∫øng Anh</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select id="modeSelect" class="form-select mb-3">
                                    <option value="conservative">Ch·ªâ l·ªói th·ª±c s·ª±</option>
                                    <option value="comprehensive">G·ª£i √Ω + c·∫£i thi·ªán</option>
                                </select>
                            </div>
                        </div>
                        <button id="checkBtn" class="btn btn-primary">Ki·ªÉm tra</button>
                        
                        <!-- Results Section -->
                        <div class="mt-4" id="resultsSection" style="display: none;">
                            <!-- Status Alert -->
                            <div id="statusAlert" class="alert" role="alert"></div>
                            
                            <!-- Errors Section -->
                            <div id="errorsSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-danger mb-0">üî¥ L·ªói c·∫ßn s·ª≠a:</h5>
                                    <button id="fixAllBtn" class="btn btn-danger btn-sm" onclick="applyAllChanges('error')">
                                        üîß S·ª≠a t·∫•t c·∫£
                                    </button>
                                </div>
                                <div id="errorsList" class="mb-3"></div>
                            </div>
                            
                            <!-- Suggestions Section -->
                            <div id="suggestionsSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-info mb-0">üí° G·ª£i √Ω c·∫£i thi·ªán (t√πy ch·ªçn):</h5>
                                    <button id="applyAllSuggestionsBtn" class="btn btn-info btn-sm" onclick="applyAllChanges('suggestion')">
                                        üí° √Åp d·ª•ng t·∫•t c·∫£
                                    </button>
                                </div>
                                <div id="suggestionsList" class="mb-3"></div>
                            </div>
                            
                            <!-- Preview Section -->
                            <div id="previewSection" style="display: none;">
                                <h5>üìÑ Xem tr∆∞·ªõc k·∫øt qu·∫£:</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">VƒÉn b·∫£n g·ªëc:</label>
                                        <div id="originalText" class="border p-3 bg-light" style="min-height: 100px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label class="form-label">VƒÉn b·∫£n sau khi √°p d·ª•ng:</label>
                                            <button id="copyFinalTextBtn" class="btn btn-sm btn-outline-success" onclick="copyFinalText()" style="display: none;">
                                                üìã Copy k·∫øt qu·∫£
                                            </button>
                                        </div>
                                        <div id="finalText" class="border p-3 bg-light" style="min-height: 100px; position: relative;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Spell Check Logic with new UI
                    window.appliedChanges = new Set();
                    window.allErrors = [];
                    window.allSuggestions = [];
                    window.originalText = '';
                    
                    document.getElementById('checkBtn').addEventListener('click', async () => {
                        const input = document.getElementById('inputText').value;
                        const language = document.getElementById('languageSelect').value;
                        const mode = document.getElementById('modeSelect').value;
                        if (!input) return alert('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!');

                        const checkBtn = document.getElementById('checkBtn');
                        checkBtn.disabled = true;
                        checkBtn.textContent = 'ƒêang ki·ªÉm tra...';

                        try {
                            const response = await fetch('/api/spellcheck', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ text: input, language, mode })
                            });

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const result = await response.json();
                            
                            // Debug logging
                            console.log('Spell check result:', result);
                            
                            // Show results section
                            document.getElementById('resultsSection').style.display = 'block';
                            
                            // Store data globally
                            window.appliedChanges.clear();
                            window.allErrors = result.errors || [];
                            window.allSuggestions = result.suggestions || [];
                            window.originalText = input;
                            
                            // Show status
                            const statusAlert = document.getElementById('statusAlert');
                            if (!result.hasErrors && (!result.suggestions || result.suggestions.length === 0)) {
                                statusAlert.className = 'alert alert-success';
                                statusAlert.innerHTML = '‚úÖ <strong>Tuy·ªát v·ªùi!</strong> Kh√¥ng ph√°t hi·ªán l·ªói ch√≠nh t·∫£ ho·∫∑c ng·ªØ ph√°p n√†o.';
                                document.getElementById('errorsSection').style.display = 'none';
                                document.getElementById('suggestionsSection').style.display = 'none';
                                document.getElementById('previewSection').style.display = 'none';
                            } else {
                                statusAlert.className = 'alert alert-warning';
                                statusAlert.innerHTML = `üìù T√¨m th·∫•y ${result.errors?.length || 0} l·ªói v√† ${result.suggestions?.length || 0} g·ª£i √Ω c·∫£i thi·ªán.`;
                                
                                // Show errors
                                if (result.errors && result.errors.length > 0) {
                                    document.getElementById('errorsSection').style.display = 'block';
                                    displayChanges('errorsList', result.errors, 'error');
                                } else {
                                    document.getElementById('errorsSection').style.display = 'none';
                                }
                                
                                // Show suggestions
                                if (result.suggestions && result.suggestions.length > 0) {
                                    document.getElementById('suggestionsSection').style.display = 'block';
                                    displayChanges('suggestionsList', result.suggestions, 'suggestion');
                                } else {
                                    document.getElementById('suggestionsSection').style.display = 'none';
                                }
                                
                                // Show preview
                                document.getElementById('previewSection').style.display = 'block';
                                updatePreviewFromAppliedChanges();
                            }
                            
                        } catch (error) {
                            console.error(error);
                            document.getElementById('statusAlert').className = 'alert alert-danger';
                            document.getElementById('statusAlert').innerHTML = `‚ùå <strong>L·ªói:</strong> ${error.message}`;
                            document.getElementById('resultsSection').style.display = 'block';
                        } finally {
                            checkBtn.disabled = false;
                            checkBtn.textContent = 'Ki·ªÉm tra';
                        }
                    });

                    function displayChanges(containerId, changes, type) {
                        const container = document.getElementById(containerId);
                        const isError = type === 'error';
                        const bgColor = isError ? 'border-danger' : 'border-info';
                        const textColor = isError ? 'text-danger' : 'text-info';
                        
                        const html = changes.map((change, index) => {
                            const changeId = `${type}_${index}`;
                            return `
                                <div class="card mb-2 ${bgColor}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <span class="text-decoration-line-through text-muted">"${change.from}"</span>
                                                <span class="mx-2">‚Üí</span>
                                                <span class="${textColor} fw-bold">"${change.to}"</span>
                                                <br><small class="text-muted mt-1">
                                                    <span class="badge bg-secondary">${change.type || 'unknown'}</span> 
                                                    ${change.reason}
                                                </small>
                                            </div>
                                            <button class="btn btn-sm ${isError ? 'btn-danger' : 'btn-outline-info'}" 
                                                    onclick="toggleChange('${changeId}', '${change.from}', '${change.to}', this)">
                                                ${isError ? 'üîß S·ª≠a' : 'üí° √Åp d·ª•ng'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = html;
                    }
                    
                    // Apply all changes of a specific type
                    window.applyAllChanges = function(type) {
                        const changes = type === 'error' ? window.allErrors : window.allSuggestions;
                        changes.forEach((change, index) => {
                            const changeId = `${type}_${index}`;
                            window.appliedChanges.add(changeId);
                            
                            // Update button appearance
                            const button = document.querySelector(`[onclick*="${changeId}"]`);
                            if (button) {
                                button.textContent = '‚úÖ ƒê√£ √°p d·ª•ng';
                                button.classList.remove('btn-danger', 'btn-outline-info');
                                button.classList.add('btn-success');
                            }
                        });
                        
                        updatePreviewFromAppliedChanges();
                        
                        // Update the "Apply All" button
                        const applyAllBtn = type === 'error' ? 
                            document.getElementById('fixAllBtn') : 
                            document.getElementById('applyAllSuggestionsBtn');
                        applyAllBtn.textContent = `‚úÖ ƒê√£ √°p d·ª•ng t·∫•t c·∫£`;
                        applyAllBtn.classList.add('btn-success');
                        applyAllBtn.disabled = true;
                    };
                    
                    window.toggleChange = function(changeId, fromText, toText, button) {
                        if (window.appliedChanges.has(changeId)) {
                            window.appliedChanges.delete(changeId);
                            button.textContent = button.textContent.includes('üîß') ? 'üîß S·ª≠a' : 'üí° √Åp d·ª•ng';
                            button.classList.remove('btn-success');
                            button.classList.add(button.textContent.includes('üîß') ? 'btn-danger' : 'btn-outline-info');
                        } else {
                            window.appliedChanges.add(changeId);
                            button.textContent = '‚úÖ ƒê√£ √°p d·ª•ng';
                            button.classList.remove('btn-danger', 'btn-outline-info');
                            button.classList.add('btn-success');
                        }
                        
                        // Update preview
                        updatePreviewFromAppliedChanges();
                        
                        // Update "Apply All" button status
                        updateApplyAllButtonStatus();
                    };
                    
                    function updateApplyAllButtonStatus() {
                        // Check errors
                        const appliedErrors = window.allErrors.filter((_, index) => 
                            window.appliedChanges.has(`error_${index}`)
                        ).length;
                        const fixAllBtn = document.getElementById('fixAllBtn');
                        if (fixAllBtn) {
                            if (appliedErrors === window.allErrors.length && window.allErrors.length > 0) {
                                fixAllBtn.textContent = '‚úÖ ƒê√£ s·ª≠a t·∫•t c·∫£';
                                fixAllBtn.classList.add('btn-success');
                                fixAllBtn.disabled = true;
                            } else {
                                fixAllBtn.textContent = 'üîß S·ª≠a t·∫•t c·∫£';
                                fixAllBtn.classList.remove('btn-success');
                                fixAllBtn.disabled = false;
                            }
                        }
                        
                        // Check suggestions
                        const appliedSuggestions = window.allSuggestions.filter((_, index) => 
                            window.appliedChanges.has(`suggestion_${index}`)
                        ).length;
                        const applyAllBtn = document.getElementById('applyAllSuggestionsBtn');
                        if (applyAllBtn) {
                            if (appliedSuggestions === window.allSuggestions.length && window.allSuggestions.length > 0) {
                                applyAllBtn.textContent = '‚úÖ ƒê√£ √°p d·ª•ng t·∫•t c·∫£';
                                applyAllBtn.classList.add('btn-success');
                                applyAllBtn.disabled = true;
                            } else {
                                applyAllBtn.textContent = 'üí° √Åp d·ª•ng t·∫•t c·∫£';
                                applyAllBtn.classList.remove('btn-success');
                                applyAllBtn.disabled = false;
                            }
                        }
                    }
                    
                    function updatePreviewFromAppliedChanges() {
                        console.log('Updating preview from applied changes...');
                        let originalText = window.originalText;
                        let finalText = window.originalText;
                        
                        console.log('Original text:', originalText);
                        console.log('Applied changes:', Array.from(window.appliedChanges));
                        
                        // Apply all selected changes with highlighting
                        const allChangesToApply = [];
                        
                        // Collect all applied changes
                        window.appliedChanges.forEach(changeId => {
                            const [type, index] = changeId.split('_');
                            const changes = type === 'error' ? window.allErrors : window.allSuggestions;
                            const change = changes[parseInt(index)];
                            if (change) {
                                allChangesToApply.push({...change, type, applied: true});
                            }
                        });
                        
                        // Also collect non-applied changes for highlighting
                        [...window.allErrors, ...window.allSuggestions].forEach((change, globalIndex) => {
                            const type = globalIndex < window.allErrors.length ? 'error' : 'suggestion';
                            const localIndex = type === 'error' ? globalIndex : globalIndex - window.allErrors.length;
                            const changeId = `${type}_${localIndex}`;
                            
                            if (!window.appliedChanges.has(changeId)) {
                                allChangesToApply.push({...change, type, applied: false});
                            }
                        });
                        
                        // Sort changes by position in text (reverse order to avoid position shifts)
                        allChangesToApply.sort((a, b) => {
                            const posA = originalText.indexOf(a.from);
                            const posB = originalText.indexOf(b.from);
                            return posB - posA;
                        });
                        
                        // Apply changes to final text and create highlighted versions
                        let highlightedOriginal = originalText;
                        let highlightedFinal = originalText;
                        
                        allChangesToApply.forEach(change => {
                            // Simple exact match - avoid complex regex for Vietnamese text
                            const exactMatch = new RegExp(escapeRegex(change.from), 'gi');
                            
                            if (change.applied) {
                                // Apply the change to final text
                                finalText = finalText.replace(exactMatch, change.to);
                                
                                // Highlight in original (red = will be changed)
                                highlightedOriginal = highlightedOriginal.replace(exactMatch, 
                                    `<span style="background-color: #ffebee; text-decoration: line-through; color: #c62828;">${change.from}</span>`
                                );
                                
                                // Highlight in final text - need to apply changes first, then highlight
                            } else {
                                // Just highlight as available for change (yellow)
                                const isError = change.type === 'error';
                                const highlightColor = isError ? '#fff3e0' : '#f3e5f5';
                                const borderColor = isError ? '#ff9800' : '#9c27b0';
                                
                                highlightedOriginal = highlightedOriginal.replace(exactMatch, 
                                    `<span style="background-color: ${highlightColor}; border: 1px solid ${borderColor}; border-radius: 2px; padding: 1px 2px;">${change.from}</span>`
                                );
                            }
                        });
                        
                        // Apply highlighting to final text AFTER all changes are made
                        highlightedFinal = finalText;
                        allChangesToApply.forEach(change => {
                            if (change.applied) {
                                const toExactMatch = new RegExp(escapeRegex(change.to), 'gi');
                                highlightedFinal = highlightedFinal.replace(toExactMatch, 
                                    `<span style="background-color: #e8f5e8; font-weight: bold; color: #2e7d32;">${change.to}</span>`
                                );
                            }
                        });
                        
                        // Update the display - use innerHTML for highlighting
                        document.getElementById('originalText').innerHTML = highlightedOriginal || originalText;
                        
                        const hasAppliedChanges = allChangesToApply.some(c => c.applied);
                        if (hasAppliedChanges) {
                            document.getElementById('finalText').innerHTML = highlightedFinal;
                            document.getElementById('copyFinalTextBtn').style.display = 'inline-block';
                            // Store clean text for copying
                            window.finalCleanText = finalText;
                        } else {
                            document.getElementById('finalText').innerHTML = '<em class="text-muted">Ch·ªçn c√°c thay ƒë·ªïi b√™n tr√™n ƒë·ªÉ xem preview...</em>';
                            document.getElementById('copyFinalTextBtn').style.display = 'none';
                            window.finalCleanText = '';
                        }
                    }
                    
                    // Copy final text function
                    window.copyFinalText = function() {
                        const textToCopy = window.finalCleanText || window.originalText;
                        if (textToCopy) {
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                const copyBtn = document.getElementById('copyFinalTextBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '‚úÖ ƒê√£ copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-success');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-success');
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy: ', err);
                                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
                            });
                        }
                    };
                    
                    function escapeRegex(string) {
                        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    }
                    
                    // Debug function
                    function debugPreview() {
                        console.log('Original text:', window.originalText);
                        console.log('Applied changes:', Array.from(window.appliedChanges));
                        console.log('All errors:', window.allErrors);
                        console.log('All suggestions:', window.allSuggestions);
                    }
                } else if (feature === 'translate-url') {
                    content.innerHTML = `
                        <h2>D·ªãch B√†i B√°o T·ª´ URL</h2>
                        <div class="mb-3">
                            <label for="urlInput" class="form-label">Nh·∫≠p URL b√†i b√°o:</label>
                            <input type="url" class="form-control" id="urlInput" placeholder="https://example.com/article">
                        </div>
                        <div class="mb-3">
                            <label for="urlDirection" class="form-label">H∆∞·ªõng d·ªãch:</label>
                            <select id="urlDirection" class="form-select">
                                <option value="en-vi">Anh sang Vi·ªát (VnEconomy style)</option>
                                <option value="vi-en">Vi·ªát sang Anh</option>
                            </select>
                        </div>
                        <button id="translateUrlBtn" class="btn btn-primary">D·ªãch B√†i B√°o</button>
                        <div class="mt-3" id="urlResultSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>B√†i g·ªëc:</h5>
                                    <div class="border p-3 bg-light" style="max-height: 400px; overflow-y: auto;">
                                        <h6 id="originalTitle" class="text-primary"></h6>
                                        <small class="text-muted" id="originalUrl"></small>
                                        <p id="originalPreview" class="mt-2"></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>B√†i ƒë√£ d·ªãch:</h5>
                                    <div class="translation-output border p-3 bg-light" style="max-height: 400px; overflow-y: auto; position: relative;">
                                        <button id="urlCopyBtn" class="btn btn-sm btn-outline-secondary copy-btn" style="display: none;" onclick="copyUrlTranslation()">
                                            üìã Copy
                                        </button>
                                        <h6 id="translatedTitle" class="text-success"></h6>
                                        <div id="translatedContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Copy function for URL translation
                    window.copyUrlTranslation = function() {
                        const title = document.getElementById('translatedTitle').innerText;
                        const content = document.getElementById('translatedContent').innerText;
                        const fullText = title + '\n\n' + content;
                        
                        if (fullText.trim() && title !== 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ' && content !== 'Kh√¥ng c√≥ n·ªôi dung') {
                            navigator.clipboard.writeText(fullText).then(() => {
                                const copyBtn = document.getElementById('urlCopyBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '‚úÖ ƒê√£ copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-secondary');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-secondary');
                                }, 2000);
                            }).catch(err => {
                                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
                            });
                        }
                    };

                    document.getElementById('translateUrlBtn').addEventListener('click', async () => {
                        const url = document.getElementById('urlInput').value;
                        const direction = document.getElementById('urlDirection').value;
                        
                        if (!url) return alert('Vui l√≤ng nh·∫≠p URL b√†i b√°o!');
                        
                        const btn = document.getElementById('translateUrlBtn');
                        const resultSection = document.getElementById('urlResultSection');
                        
                        btn.innerHTML = 'ƒêang t·∫£i v√† d·ªãch...';
                        btn.disabled = true;
                        resultSection.style.display = 'none';

                        try {
                            const response = await fetch('/api/translate-url', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url, direction })
                            });

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const data = await response.json();

                            // Display results
                            document.getElementById('originalTitle').innerText = data.original?.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                            document.getElementById('originalUrl').innerText = url;
                            document.getElementById('originalPreview').innerText = data.original?.content || 'Kh√¥ng c√≥ n·ªôi dung';
                            
                            document.getElementById('translatedTitle').innerText = data.translated?.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                            document.getElementById('translatedContent').innerText = data.translated?.content || 'Kh√¥ng c√≥ n·ªôi dung';
                            
                            resultSection.style.display = 'block';
                            document.getElementById('urlCopyBtn').style.display = 'block';
                            
                        } catch (error) {
                            console.error(error);
                            
                            // Try to parse error message from response
                            let errorMessage = 'L·ªói khi d·ªãch URL.';
                            if (error.message.includes('400')) {
                                errorMessage = 'Kh√¥ng th·ªÉ tr√≠ch xu·∫•t n·ªôi dung t·ª´ URL n√†y. Vui l√≤ng th·ª≠ URL kh√°c ho·∫∑c ki·ªÉm tra URL c√≥ h·ª£p l·ªá kh√¥ng.';
                            } else if (error.message.includes('500')) {
                                errorMessage = 'L·ªói server khi x·ª≠ l√Ω URL. Vui l√≤ng th·ª≠ l·∫°i sau.';
                            } else {
                                errorMessage = 'L·ªói khi d·ªãch URL: ' + error.message + '\nVui l√≤ng ki·ªÉm tra URL c√≥ h·ª£p l·ªá kh√¥ng.';
                            }
                            
                            alert(errorMessage);
                        } finally {
                            btn.innerHTML = 'D·ªãch B√†i B√°o';
                            btn.disabled = false;
                        }
                    });
                } else if (feature === 'ai-write') {
                    content.innerHTML = `
                        <h2>üìù AI Vi·∫øt B√†i T·ª± ƒê·ªông</h2>
                        <div class="card">
                            <div class="card-body">
                                <!-- Input Method Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-bullseye me-2"></i>Ngu·ªìn n·ªôi dung:</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromTopic" value="topic" checked>
                                                <label class="form-check-label" for="fromTopic">
                                                    <i class="fas fa-lightbulb me-1"></i> T·ª´ ch·ªß ƒë·ªÅ
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromHotTopics" value="hottopics">
                                                <label class="form-check-label" for="fromHotTopics">
                                                    <i class="fas fa-fire me-1"></i> Ch·ªß ƒë·ªÅ Hot
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromArticles" value="articles">
                                                <label class="form-check-label" for="fromArticles">
                                                    <i class="fas fa-newspaper me-1"></i> T·ª´ b√†i b√°o c√≥ s·∫µn
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromWord" value="word">
                                                <label class="form-check-label" for="fromWord">
                                                    <i class="fas fa-file-word me-1"></i> T·ª´ file Word
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Topic Input -->
                                <div id="topicInput" class="input-section">
                                    <div class="mb-3">
                                        <label for="topicText" class="form-label"><i class="fas fa-lightbulb me-2"></i>Ch·ªß ƒë·ªÅ b√†i vi·∫øt:</label>
                                        <textarea class="form-control" id="topicText" rows="3" placeholder="VD: T√°c ƒë·ªông c·ªßa AI ƒë·ªëi v·ªõi ng√†nh b√°o ch√≠ Vi·ªát Nam, xu h∆∞·ªõng ph√°t tri·ªÉn c√¥ng ngh·ªá blockchain..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="topicContext" class="form-label"><i class="fas fa-edit me-2"></i>B·ªëi c·∫£nh/G√≥c ƒë·ªô (t√πy ch·ªçn):</label>
                                        <textarea class="form-control" id="topicContext" rows="2" placeholder="Th√™m b·ªëi c·∫£nh, g√≥c ƒë·ªô ti·∫øp c·∫≠n, ho·∫∑c th√¥ng tin c·∫ßn l∆∞u √Ω..."></textarea>
                                    </div>
                                </div>

                                <!-- Hot Topics Input -->
                                <div id="hotTopicsInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label"><i class="fas fa-fire me-2"></i>Top 10 Ch·ªß ƒê·ªÅ Hot Hi·ªán T·∫°i:</label>
                                            <button id="refreshHotTopicsBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-sync-alt me-1"></i>Refresh Topics</button>
                                        </div>
                                        <div class="row align-items-center mb-3">
                                            <div class="col-md-4">
                                                <label for="categoryFilter" class="form-label small"><i class="fas fa-folder me-1"></i>Chuy√™n m·ª•c:</label>
                                                <select id="categoryFilter" class="form-select form-select-sm">
                                                    <option value="all">T·∫•t c·∫£ chuy√™n m·ª•c</option>
                                                    <option value="Kinh t·∫ø">Kinh t·∫ø</option>
                                                    <option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá</option>
                                                    <option value="X√£ h·ªôi">X√£ h·ªôi</option>
                                                    <option value="VƒÉn h√≥a">VƒÉn h√≥a</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small"><i class="fas fa-chart-line me-1"></i>Trend Score:</label>
                                                <select id="scoreFilter" class="form-select form-select-sm">
                                                    <option value="all">T·∫•t c·∫£ m·ª©c ƒë·ªô</option>
                                                    <option value="90">Si√™u Hot (90%+)</option>
                                                    <option value="80">Hot (80%+)</option>
                                                    <option value="70">Trending (70%+)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small"><i class="fas fa-rss me-1"></i>Ngu·ªìn:</label>
                                                <select id="sourceFilter" class="form-select form-select-sm">
                                                    <option value="all">T·∫•t c·∫£ ngu·ªìn</option>
                                                    <option value="Current Events">Current Events</option>
                                                    <option value="Tech Trends">Tech Trends</option>
                                                    <option value="Vietnamese">Vietnamese Topics</option>
                                                    <option value="Fallback">General Topics</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="hotTopicsLoading" class="text-center py-3" style="display: none;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                                            </div>
                                            <p class="mt-2">ƒêang l·∫•y trending topics t·ª´ Google Trends & Social Media...</p>
                                        </div>
                                        <div id="hotTopicsList" class="row">
                                            <!-- Hot topics will be populated here -->
                                        </div>
                                        <div class="mt-3">
                                            <label for="selectedTopicDetails" class="form-label"><i class="fas fa-edit me-2"></i>Chi ti·∫øt ch·ªß ƒë·ªÅ ƒë√£ ch·ªçn:</label>
                                            <div id="selectedTopicDisplay" class="alert alert-info" style="display: none;">
                                                <strong id="selectedTopicTitle">Ch∆∞a ch·ªçn ch·ªß ƒë·ªÅ</strong>
                                                <p id="selectedTopicDescription" class="mb-1"></p>
                                                <small class="text-muted">Trend score: <span id="selectedTopicScore">-</span> | Source: <span id="selectedTopicSource">-</span></small>
                                            </div>
                                            <textarea class="form-control" id="selectedTopicDetails" rows="3" placeholder="G√≥c ƒë·ªô v√† b·ªëi c·∫£nh b·ªï sung cho ch·ªß ƒë·ªÅ Hot (t√πy ch·ªçn)..." readonly></textarea>
                                            <div class="form-text"><i class="fas fa-info-circle me-1"></i>Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ Hot ·ªü tr√™n, sau ƒë√≥ c√≥ th·ªÉ th√™m g√≥c ƒë·ªô ri√™ng</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Articles Input -->
                                <div id="articlesInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label"><i class="fas fa-newspaper me-2"></i>B√†i b√°o ngu·ªìn (c√≥ th·ªÉ paste nhi·ªÅu b√†i):</label>
                                        <div id="articlesContainer">
                                            <div class="article-input mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-newspaper me-1"></i>B√†i 1</span>
                                                    <textarea class="form-control article-content" rows="4" placeholder="Paste n·ªôi dung b√†i b√°o th·ª© 1..."></textarea>
                                                    <button class="btn btn-outline-danger remove-article" type="button"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                        <button id="addArticleBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-plus me-1"></i>Th√™m b√†i b√°o</button>
                                    </div>
                                </div>

                                <!-- Word File Input -->
                                <div id="wordInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <label for="wordFile" class="form-label"><i class="fas fa-file-word me-2"></i>Upload file Word:</label>
                                        <input class="form-control" type="file" id="wordFile" accept=".doc,.docx,.txt">
                                        <div class="form-text">H·ªó tr·ª£: .doc, .docx, .txt (t·ªëi ƒëa 10MB)</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="wordPreview" class="form-label"><i class="fas fa-eye me-2"></i>N·ªôi dung file (preview):</label>
                                        <textarea class="form-control" id="wordPreview" rows="5" placeholder="N·ªôi dung file s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..." readonly></textarea>
                                    </div>
                                </div>

                                <!-- Article Configuration -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="articleType" class="form-label"><i class="fas fa-file-alt me-2"></i>D·∫°ng b√†i b√°o:</label>
                                        <select id="articleType" class="form-select">
                                            <option value="tin-van">Tin v·∫Øn (200-400 t·ª´)</option>
                                            <option value="tin-tong-hop">Tin t·ªïng h·ª£p (400-800 t·ª´)</option>
                                            <option value="phong-su-ngan">Ph√≥ng s·ª± ng·∫Øn (600-1000 t·ª´)</option>
                                            <option value="bai-phan-tich">B√†i ph√¢n t√≠ch (800-1200 t·ª´)</option>
                                            <option value="phong-su-dai">Ph√≥ng s·ª± d√†i (1000-2000 t·ª´)</option>
                                            <option value="bai-binh-luan">B√†i b√¨nh lu·∫≠n (600-1000 t·ª´)</option>
                                            <option value="bao-cao-chuyen-sau">B√°o c√°o chuy√™n s√¢u (1200+ t·ª´)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="outputType" class="form-label"><i class="fas fa-cog me-2"></i>Lo·∫°i output:</label>
                                        <select id="outputType" class="form-select">
                                            <option value="outline">S∆∞·ªùn b√†i b√°o (ƒë·ªÉ editor ho√†n thi·ªán)</option>
                                            <option value="complete">B√†i b√°o ho√†n ch·ªânh</option>
                                            <option value="both">C·∫£ hai (S∆∞·ªùn + B√†i ho√†n ch·ªânh)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Writing Style Options -->
                                <div class="mb-4">
                                    <label class="form-label"><i class="fas fa-palette me-2"></i>Phong c√°ch vi·∫øt:</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <select id="writingTone" class="form-select">
                                                <option value="objective">Kh√°ch quan, trung t√≠nh</option>
                                                <option value="engaging">H·∫•p d·∫´n, thu h√∫t</option>
                                                <option value="formal">Trang tr·ªçng, ch√≠nh th·ª©c</option>
                                                <option value="casual">G·∫ßn g≈©i, d·ªÖ hi·ªÉu</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <select id="targetAudience" class="form-select">
                                                <option value="general">ƒê·ªôc gi·∫£ ƒë·∫°i ch√∫ng</option>
                                                <option value="business">C·ªông ƒë·ªìng doanh nghi·ªáp</option>
                                                <option value="tech">C·ªông ƒë·ªìng c√¥ng ngh·ªá</option>
                                                <option value="youth">Gi·ªõi tr·∫ª, sinh vi√™n</option>
                                                <option value="professional">Chuy√™n gia, chuy√™n ng√†nh</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Generate Button -->
                                <div class="text-center">
                                    <button id="generateArticleBtn" class="btn btn-primary btn-lg">
                                        <i class="fas fa-magic me-2"></i>T·∫°o B√†i B√°o AI
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div class="mt-4" id="aiWriteResults" style="display: none;">
                            <!-- Outline Section -->
                            <div id="outlineSection" class="card mb-4" style="display: none;">
                                <div class="card-header bg-info text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>S∆∞·ªùn B√†i B√°o</h5>
                                        <button class="btn btn-light btn-sm" onclick="copyContent('outlineContent')"><i class="fas fa-copy me-1"></i>Copy S∆∞·ªùn</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="outlineContent" class="content-output"></div>
                                </div>
                            </div>

                            <!-- Complete Article Section -->
                            <div id="articleSection" class="card mb-4" style="display: none;">
                                <div class="card-header bg-success text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>B√†i B√°o Ho√†n Ch·ªânh</h5>
                                        <div>
                                            <button class="btn btn-light btn-sm me-2" onclick="copyContent('articleContent')"><i class="fas fa-copy me-1"></i>Copy B√†i</button>
                                            <button class="btn btn-warning btn-sm" onclick="refineArticle()"><i class="fas fa-edit me-1"></i>Tinh Ch·ªânh</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="articleContent" class="content-output"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    // AI Writing Logic
                    setupAIWritingFeature();
                } else if (feature === 'hot-topics') {
                    content.innerHTML = `
                        <h2><i class="fas fa-fire me-2 text-danger"></i>G·ª£i √ù Ch·ªß ƒê·ªÅ HOT</h2>
                        <div class="card">
                            <div class="card-body">
                                <!-- Source Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-database me-2"></i>Ngu·ªìn d·ªØ li·ªáu:</label>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sourceAll" value="all" checked>
                                                <label class="form-check-label" for="sourceAll">
                                                    <i class="fas fa-globe me-1"></i> T·∫•t c·∫£ ngu·ªìn
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sourceGoogle" value="google" checked>
                                                <label class="form-check-label" for="sourceGoogle">
                                                    <i class="fab fa-google me-1"></i> Google Trends
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sourceBaoMoi" value="baomoi" checked>
                                                <label class="form-check-label" for="sourceBaoMoi">
                                                    <i class="fas fa-newspaper me-1"></i> BaoMoi.com
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sourceSocial" value="social" checked>
                                                <label class="form-check-label" for="sourceSocial">
                                                    <i class="fas fa-share-alt me-1"></i> M·∫°ng x√£ h·ªôi
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Category Filter -->
                                <div class="mb-4">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label for="categoryFilterMain" class="form-label fw-bold"><i class="fas fa-tags me-2"></i>Chuy√™n m·ª•c:</label>
                                            <select id="categoryFilterMain" class="form-select">
                                                <option value="all">T·∫•t c·∫£ chuy√™n m·ª•c</option>
                                                <option value="Kinh t·∫ø">Kinh t·∫ø</option>
                                                <option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá</option>
                                                <option value="X√£ h·ªôi">X√£ h·ªôi</option>
                                                <option value="Th·ªÉ thao">Th·ªÉ thao</option>
                                                <option value="Gi√°o d·ª•c">Gi√°o d·ª•c</option>
                                                <option value="Ch·ª©ng kho√°n">Ch·ª©ng kho√°n</option>
                                                <option value="Crypto">Crypto</option>
                                                <option value="VƒÉn h√≥a">VƒÉn h√≥a</option>
                                                <option value="Du l·ªãch">Du l·ªãch</option>
                                                <option value="S·ª©c kh·ªèe">S·ª©c kh·ªèe</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="hotLevelFilter" class="form-label fw-bold"><i class="fas fa-thermometer-half me-2"></i>ƒê·ªô Hot:</label>
                                            <select id="hotLevelFilter" class="form-select">
                                                <option value="all">T·∫•t c·∫£ m·ª©c ƒë·ªô</option>
                                                <option value="95">Si√™u Hot (95%+)</option>
                                                <option value="85">Very Hot (85%+)</option>
                                                <option value="75">Hot (75%+)</option>
                                                <option value="65">Trending (65%+)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Control Buttons -->
                                <div class="text-center mb-4">
                                    <button id="loadHotTopicsMainBtn" class="btn btn-primary me-3">
                                        <i class="fas fa-sync-alt me-2"></i>T·∫£i Ch·ªß ƒê·ªÅ HOT
                                    </button>
                                    <button id="refreshSourcesBtn" class="btn btn-outline-secondary">
                                        <i class="fas fa-redo me-2"></i>L√†m m·ªõi ngu·ªìn
                                    </button>
                                </div>

                                <!-- Loading State -->
                                <div id="hotTopicsMainLoading" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border text-danger" role="status">
                                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                                    </div>
                                    <h5 class="mt-3 text-danger">ƒêang qu√©t ch·ªß ƒë·ªÅ HOT...</h5>
                                    <div class="progress mt-3" style="max-width: 400px; margin: 0 auto;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" id="loadingProgress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted mt-2 d-block" id="loadingStatus">Kh·ªüi t·∫°o...</small>
                                </div>

                                <!-- Statistics -->
                                <div id="hotTopicsStats" class="row g-3 mb-4" style="display: none;">
                                    <div class="col-6 col-md-3">
                                        <div class="card bg-light border-0 text-center shadow-sm">
                                            <div class="card-body py-3">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-list-ul fa-2x text-primary me-2"></i>
                                                    <div>
                                                        <h4 class="mb-0 text-primary" id="totalTopicsCount">0</h4>
                                                        <small class="text-muted">T·ªïng ch·ªß ƒë·ªÅ</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="card bg-light border-0 text-center shadow-sm">
                                            <div class="card-body py-3">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-fire fa-2x text-danger me-2"></i>
                                                    <div>
                                                        <h4 class="mb-0 text-danger" id="superHotCount">0</h4>
                                                        <small class="text-muted">Si√™u Hot (90%+)</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="card bg-light border-0 text-center shadow-sm">
                                            <div class="card-body py-3">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-database fa-2x text-info me-2"></i>
                                                    <div>
                                                        <h4 class="mb-0 text-info" id="sourcesCount">0</h4>
                                                        <small class="text-muted">Ngu·ªìn d·ªØ li·ªáu</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="card bg-light border-0 text-center shadow-sm">
                                            <div class="card-body py-3">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-tags fa-2x text-success me-2"></i>
                                                    <div>
                                                        <h4 class="mb-0 text-success" id="categoriesCount">0</h4>
                                                        <small class="text-muted">Chuy√™n m·ª•c</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hot Topics Results -->
                                <div id="hotTopicsMainResults" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4><i class="fas fa-fire me-2 text-danger"></i>Ch·ªß ƒë·ªÅ HOT hi·ªán t·∫°i</h4>
                                        <small class="text-muted">C·∫≠p nh·∫≠t: <span id="lastUpdateTime">--</span></small>
                                    </div>
                                    <div id="hotTopicsMainGrid" class="row">
                                        <!-- Topics will be populated here -->
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div id="hotTopicsEmpty" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h4 class="text-muted">Ch∆∞a c√≥ ch·ªß ƒë·ªÅ n√†o</h4>
                                    <p class="text-muted">H√£y ch·ªçn ngu·ªìn d·ªØ li·ªáu v√† nh·∫•n "T·∫£i Ch·ªß ƒê·ªÅ HOT" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Topic Detail Modal -->
                        <div class="modal fade" id="topicDetailModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="modalTopicTitle">Chi ti·∫øt ch·ªß ƒë·ªÅ</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <p id="modalTopicDescription" class="lead"></p>
                                                <div class="mb-3">
                                                    <label class="form-label"><i class="fas fa-lightbulb me-2"></i>G·ª£i √Ω g√≥c ƒë·ªô vi·∫øt:</label>
                                                    <ul id="modalWritingAngles" class="list-unstyled">
                                                        <!-- Writing angles will be populated -->
                                                    </ul>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><i class="fas fa-search me-2"></i>T·ª´ kh√≥a li√™n quan:</label>
                                                    <div id="modalKeywords">
                                                        <!-- Keywords will be populated -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6><i class="fas fa-info-circle me-1"></i>Th√¥ng tin:</h6>
                                                        <p class="mb-1"><strong>Chuy√™n m·ª•c:</strong> <span id="modalTopicCategory"></span></p>
                                                        <p class="mb-1"><strong>ƒê·ªô Hot:</strong> <span id="modalTopicScore" class="badge bg-danger"></span></p>
                                                        <p class="mb-1"><strong>Ngu·ªìn:</strong> <span id="modalTopicSource"></span></p>
                                                        <p class="mb-1"><strong>Th·ªùi gian:</strong> <span id="modalTopicTime"></span></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-primary" id="useTopicForWriting">
                                            <i class="fas fa-edit me-2"></i>D√πng vi·∫øt b√†i
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="copyTopicInfo">
                                            <i class="fas fa-copy me-2"></i>Copy th√¥ng tin
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Initialize Hot Topics functionality
                    initializeHotTopicsFeature();
                } else if (feature === 'content-summary') {
                    content.innerHTML = `
                        <h2><i class="fas fa-compress-alt me-2 text-info"></i>T√≥m T·∫Øt N·ªôi Dung</h2>
                        
                        <!-- API Status Test -->
                        <div class="alert alert-info mb-3">
                            <strong>üîß API Status Test:</strong>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="testApiEndpoint()">Test API</button>
                            <span id="apiStatus" class="ms-2"></span>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <!-- Summary Mode Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-bullseye me-2"></i>Lo·∫°i t√≥m t·∫Øt:</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="summaryMode" id="categorySummary" value="category" checked>
                                                <label class="form-check-label" for="categorySummary">
                                                    <i class="fas fa-list-ul me-1"></i> ƒêi·ªÉm tin chuy√™n m·ª•c
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="summaryMode" id="articleSummary" value="article">
                                                <label class="form-check-label" for="articleSummary">
                                                    <i class="fas fa-file-alt me-1"></i> T√≥m t·∫Øt b√†i vi·∫øt
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Category Summary Input -->
                                <div id="categoryInput" class="summary-input-section">
                                    <div class="mb-3">
                                        <label for="categoryUrl" class="form-label"><i class="fas fa-link me-2"></i>URL chuy√™n m·ª•c b√°o:</label>
                                        <input type="url" class="form-control" id="categoryUrl" placeholder="https://vnexpress.net/thoi-su ho·∫∑c https://tuoitre.vn/thoi-su.htm">
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Paste ƒë∆∞·ªùng d·∫´n chuy√™n m·ª•c (VD: Th·ªùi s·ª±, Kinh doanh...) ƒë·ªÉ t·∫°o ƒëi·ªÉm tin t·ª´ c√°c ti√™u ƒë·ªÅ trong ng√†y - nhanh & hi·ªáu qu·∫£!
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="categorySettings" class="form-label"><i class="fas fa-cog me-2"></i>T√πy ch·ªçn ƒëi·ªÉm tin:</label>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <select id="categoryLength" class="form-select form-select-sm">
                                                    <option value="short">T√≥m t·∫Øt ng·∫Øn (200-300 t·ª´)</option>
                                                    <option value="medium" selected>T√≥m t·∫Øt v·ª´a (400-600 t·ª´)</option>
                                                    <option value="long">T√≥m t·∫Øt chi ti·∫øt (800-1000 t·ª´)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <select id="categoryFocus" class="form-select form-select-sm">
                                                    <option value="general">T·ªïng quan</option>
                                                    <option value="highlights">ƒêi·ªÉm n·ªïi b·∫≠t</option>
                                                    <option value="analysis">Ph√¢n t√≠ch s√¢u</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" class="form-control form-control-sm" id="maxArticles" value="10" min="5" max="30" placeholder="Max b√†i">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Article Summary Input -->
                                <div id="articleInput" class="summary-input-section" style="display: none;">
                                    <div class="mb-3">
                                        <label for="articleUrl" class="form-label"><i class="fas fa-link me-2"></i>URL b√†i vi·∫øt:</label>
                                        <input type="url" class="form-control" id="articleUrl" placeholder="https://vnexpress.net/... ho·∫∑c https://dantri.com.vn/...">
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Paste ƒë∆∞·ªùng d·∫´n b√†i b√°o b·∫•t k·ª≥ ƒë·ªÉ t√≥m t·∫Øt n·ªôi dung
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="articleSettings" class="form-label"><i class="fas fa-cog me-2"></i>T√πy ch·ªçn t√≥m t·∫Øt:</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <select id="articleLength" class="form-select form-select-sm">
                                                    <option value="brief">T√≥m t·∫Øt si√™u ng·∫Øn (50-100 t·ª´)</option>
                                                    <option value="short" selected>T√≥m t·∫Øt ng·∫Øn (150-250 t·ª´)</option>
                                                    <option value="medium">T√≥m t·∫Øt v·ª´a (300-400 t·ª´)</option>
                                                    <option value="detailed">T√≥m t·∫Øt chi ti·∫øt (500+ t·ª´)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <select id="articleStyle" class="form-select form-select-sm">
                                                    <option value="bullet">D·∫°ng bullet points</option>
                                                    <option value="paragraph" selected>D·∫°ng ƒëo·∫°n vƒÉn</option>
                                                    <option value="structured">D·∫°ng c√≥ c·∫•u tr√∫c</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Generate Summary Button -->
                                <div class="text-center mb-4">
                                    <button id="generateSummaryBtn" class="btn btn-info btn-lg">
                                        <i class="fas fa-magic me-2"></i>T·∫°o T√≥m T·∫Øt
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div class="mt-4" id="summaryResults" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-file-text me-2"></i>K·∫øt Qu·∫£ T√≥m T·∫Øt</h5>
                                        <div>
                                            <button class="btn btn-light btn-sm me-2" onclick="copyContent('summaryContent')">
                                                <i class="fas fa-copy me-1"></i>Copy
                                            </button>
                                            <button class="btn btn-warning btn-sm" id="textToSpeechBtn" onclick="sendToTTS()">
                                                <i class="fas fa-volume-up me-1"></i>Text to Speech
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Source Info -->
                                    <div id="sourceInfo" class="alert alert-light mb-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted"><strong>Ngu·ªìn:</strong> <span id="sourceUrl">-</span></small>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted"><strong>Lo·∫°i:</strong> <span id="sourceType">-</span></small>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted"><strong>Th·ªùi gian:</strong> <span id="summaryTime">-</span></small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Summary Content -->
                                    <div id="summaryContent" class="content-output">
                                        <!-- Summary will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Initialize Content Summary functionality
                    initializeContentSummaryFeature();
                } else {
                    content.innerHTML = `<h2>${this.textContent}</h2><p>ƒêang ph√°t tri·ªÉn t√≠nh nƒÉng: ${feature}. N·ªôi dung s·∫Ω ƒë∆∞·ª£c th√™m sau.</p>`;
                }
            });
        });

        // AI Writing Feature Setup
        function setupAIWritingFeature() {
            // Input method switching
            document.querySelectorAll('input[name="inputMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Input method changed to:', this.value);
                    
                    // Hide all sections first
                    document.querySelectorAll('.input-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Clear previous state when switching away from hot topics
                    if (this.value !== 'hottopics') {
                        window.selectedHotTopicData = null;
                        console.log('Cleared hot topic data due to input method change');
                        
                        // Clear hot topics UI state
                        const selectedTopicDisplay = document.getElementById('selectedTopicDisplay');
                        if (selectedTopicDisplay) {
                            selectedTopicDisplay.style.display = 'none';
                        }
                        
                        const selectedTopicDetails = document.getElementById('selectedTopicDetails');
                        if (selectedTopicDetails) {
                            selectedTopicDetails.value = '';
                            selectedTopicDetails.readOnly = true;
                        }
                        
                        // Remove selections
                        document.querySelectorAll('.hot-topic-card').forEach(c => {
                            c.classList.remove('selected', 'border-primary');
                        });
                    }
                    
                    // Show appropriate section
                    if (this.value === 'topic') {
                        document.getElementById('topicInput').style.display = 'block';
                    } else if (this.value === 'hottopics') {
                        document.getElementById('hotTopicsInput').style.display = 'block';
                        loadHotTopics(); // Load hot topics when selected
                    } else if (this.value === 'articles') {
                        document.getElementById('articlesInput').style.display = 'block';
                    } else if (this.value === 'word') {
                        document.getElementById('wordInput').style.display = 'block';
                    }
                });
            });

            // Add article functionality
            let articleCount = 1;
            document.getElementById('addArticleBtn').addEventListener('click', function() {
                articleCount++;
                const container = document.getElementById('articlesContainer');
                const newArticle = document.createElement('div');
                newArticle.className = 'article-input mb-3';
                newArticle.innerHTML = `
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-newspaper me-1"></i>B√†i ${articleCount}</span>
                        <textarea class="form-control article-content" rows="4" placeholder="Paste n·ªôi dung b√†i b√°o th·ª© ${articleCount}..."></textarea>
                        <button class="btn btn-outline-danger remove-article" type="button"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(newArticle);
            });

            // Remove article functionality
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-article')) {
                    if (document.querySelectorAll('.article-input').length > 1) {
                        e.target.closest('.article-input').remove();
                        // Renumber articles
                        document.querySelectorAll('.article-input').forEach((article, index) => {
                            article.querySelector('.input-group-text').innerHTML = `<i class="fas fa-newspaper me-1"></i>B√†i ${index + 1}`;
                            article.querySelector('textarea').placeholder = `Paste n·ªôi dung b√†i b√°o th·ª© ${index + 1}...`;
                        });
                        articleCount = document.querySelectorAll('.article-input').length;
                    } else {
                        alert('C·∫ßn √≠t nh·∫•t 1 b√†i b√°o ngu·ªìn!');
                    }
                }
            });

            // Word file upload handling
            document.getElementById('wordFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('wordPreview').value = e.target.result;
                    };
                    reader.readAsText(file);
                }
            });

            // Generate article button
            document.getElementById('generateArticleBtn').addEventListener('click', async function() {
                const btn = this;
                const originalText = btn.innerHTML;
                
                try {
                    // Collect input data
                    const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;
                    const articleType = document.getElementById('articleType').value;
                    const outputType = document.getElementById('outputType').value;
                    const writingTone = document.getElementById('writingTone').value;
                    const targetAudience = document.getElementById('targetAudience').value;

                    let inputContent = '';
                    let inputContext = '';

                    if (inputMethod === 'topic') {
                        inputContent = document.getElementById('topicText').value.trim();
                        inputContext = document.getElementById('topicContext').value.trim();
                        if (!inputContent) {
                            alert('Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ b√†i vi·∫øt!');
                            return;
                        }
                    } else if (inputMethod === 'hottopics') {
                        // Check if we have stored hot topic data (more reliable than DOM query)
                        if (window.selectedHotTopicData) {
                            inputContent = window.selectedHotTopicData.title;
                            const topicDescription = window.selectedHotTopicData.description;
                            const additionalContext = document.getElementById('selectedTopicDetails').value.trim();
                            inputContext = `${topicDescription}${additionalContext ? '\nG√≥c ƒë·ªô b·ªï sung: ' + additionalContext : ''}`;
                            console.log('Using stored hot topic data:', {
                                title: inputContent,
                                description: topicDescription,
                                context: additionalContext,
                                timestamp: window.selectedHotTopicData.timestamp
                            });
                        } else {
                            // Fallback to DOM query if no stored data
                            const selectedTopic = document.querySelector('.hot-topic-card.selected');
                            if (!selectedTopic) {
                                alert('Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ Hot t·ª´ danh s√°ch!');
                                return;
                            }
                            inputContent = selectedTopic.dataset.title;
                            const topicDescription = selectedTopic.dataset.description;
                            const additionalContext = document.getElementById('selectedTopicDetails').value.trim();
                            inputContext = `${topicDescription}${additionalContext ? '\nG√≥c ƒë·ªô b·ªï sung: ' + additionalContext : ''}`;
                            console.log('Using DOM fallback for hot topic:', inputContent, 'Context:', inputContext);
                        }
                    } else if (inputMethod === 'articles') {
                        const articles = Array.from(document.querySelectorAll('.article-content'))
                            .map(textarea => textarea.value.trim())
                            .filter(content => content);
                        if (articles.length === 0) {
                            alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 b√†i b√°o ngu·ªìn!');
                            return;
                        }
                                                 inputContent = articles.join('\n\n=== PH√ÇN C√ÅCH B√ÄI ===\n\n');
                    } else if (inputMethod === 'word') {
                        inputContent = document.getElementById('wordPreview').value.trim();
                        if (!inputContent) {
                            alert('Vui l√≤ng upload file Word ho·∫∑c nh·∫≠p n·ªôi dung!');
                            return;
                        }
                    }

                    // Update button state
                    btn.disabled = true;
                    btn.innerHTML = '‚è≥ ƒêang t·∫°o b√†i...';

                    // Call API
                    const response = await fetch('/api/ai-write', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            inputMethod,
                            inputContent,
                            inputContext,
                            articleType,
                            outputType,
                            writingTone,
                            targetAudience
                        })
                    });

                    if (!response.ok) {
                        throw new Error('L·ªói API: ' + response.statusText);
                    }

                    const result = await response.json();
                    
                    // Display results
                    displayAIWritingResults(result, outputType);

                } catch (error) {
                    console.error('AI Writing Error:', error);
                    alert('L·ªói khi t·∫°o b√†i: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });

            // Hot Topics functionality
            document.getElementById('refreshHotTopicsBtn').addEventListener('click', loadHotTopics);
            
            // Filter event listeners
            document.getElementById('categoryFilter').addEventListener('change', applyHotTopicsFilters);
            document.getElementById('scoreFilter').addEventListener('change', applyHotTopicsFilters);
            document.getElementById('sourceFilter').addEventListener('change', applyHotTopicsFilters);
        }

        // Global variable to store all topics
        window.allHotTopics = [];
        
        // Load hot topics from API
        async function loadHotTopics() {
            const loadingDiv = document.getElementById('hotTopicsLoading');
            const topicsList = document.getElementById('hotTopicsList');
            
            try {
                loadingDiv.style.display = 'block';
                topicsList.innerHTML = '';
                
                const response = await fetch('/api/hot-topics', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch hot topics');
                }
                
                const data = await response.json();
                
                // Store all topics globally
                window.allHotTopics = data.topics || [];
                window.categoryStats = data.categoryStats || {};
                
                // Update filter options with counts
                updateFilterOptions(data.categoryStats);
                
                // Reset filters
                document.getElementById('categoryFilter').value = 'all';
                document.getElementById('scoreFilter').value = 'all';
                document.getElementById('sourceFilter').value = 'all';
                
                // Display all topics initially
                displayHotTopics(window.allHotTopics);
                
            } catch (error) {
                console.error('Hot Topics Error:', error);
                topicsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>Kh√¥ng th·ªÉ t·∫£i ch·ªß ƒë·ªÅ Hot. <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadHotTopics()">Th·ª≠ l·∫°i</button>
                        </div>
                    </div>
                `;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Apply filters to hot topics
        function applyHotTopicsFilters() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const scoreFilter = document.getElementById('scoreFilter').value;
            const sourceFilter = document.getElementById('sourceFilter').value;
            
            let filteredTopics = [...window.allHotTopics];
            
            // Filter by category
            if (categoryFilter !== 'all') {
                filteredTopics = filteredTopics.filter(topic => 
                    topic.category === categoryFilter
                );
            }
            
            // Filter by score
            if (scoreFilter !== 'all') {
                const minScore = parseInt(scoreFilter);
                filteredTopics = filteredTopics.filter(topic => 
                    topic.score >= minScore
                );
            }
            
            // Filter by source
            if (sourceFilter !== 'all') {
                filteredTopics = filteredTopics.filter(topic => {
                    if (sourceFilter === 'Current Events') return topic.source === 'Current Events';
                    if (sourceFilter === 'Tech Trends') return topic.source === 'Tech Trends';
                    if (sourceFilter === 'Vietnamese') return topic.source.includes('Vietnamese');
                    if (sourceFilter === 'Fallback') return topic.source === 'Fallback Topics';
                    return true;
                });
            }
            
            // Display filtered topics
            displayHotTopics(filteredTopics, true); // true indicates this is a filtered view
        }

        // Display hot topics in grid
        function displayHotTopics(topics, isFiltered = false) {
            const topicsList = document.getElementById('hotTopicsList');
            
            if (!topics || topics.length === 0) {
                const message = isFiltered ? 
                    '<i class="fas fa-search me-1"></i>Kh√¥ng t√¨m th·∫•y ch·ªß ƒë·ªÅ n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.' :
                    '<i class="fas fa-list me-1"></i>Kh√¥ng c√≥ ch·ªß ƒë·ªÅ Hot n√†o.';
                const buttonText = isFiltered ? 'X√≥a b·ªô l·ªçc' : 'T·∫£i l·∫°i';
                const buttonAction = isFiltered ? 'clearFilters()' : 'loadHotTopics()';
                
                topicsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            ${message} <button class="btn btn-sm btn-outline-primary ms-2" onclick="${buttonAction}">${buttonText}</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Update topics counter
            updateTopicsCounter(topics.length, window.allHotTopics.length, isFiltered);
            
                            const topicsHTML = topics.map((topic, index) => `
                <div class="col-md-6 mb-3">
                    <div class="card hot-topic-card h-100" 
                         data-title="${topic.title}"
                         data-description="${topic.description}"
                         data-score="${topic.score}"
                         data-source="${topic.source}"
                         onclick="selectHotTopic(this)">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge bg-danger">#${index + 1}</span>
                                <small class="text-muted">${topic.source}</small>
                            </div>
                            <h6 class="card-title">${topic.title}</h6>
                            <p class="card-text text-muted small">${topic.description}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-success"><i class="fas fa-fire me-1"></i>Trend: ${topic.score}%</small>
                                <small class="text-muted">${topic.category}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            topicsList.innerHTML = topicsHTML;
        }

        // Select hot topic
        window.selectHotTopic = function(card) {
            console.log('selectHotTopic called with:', card.dataset);
            
            // Remove previous selection
            document.querySelectorAll('.hot-topic-card').forEach(c => {
                c.classList.remove('selected', 'border-primary');
            });
            
            // Select current card
            card.classList.add('selected', 'border-primary');
            
            // Update details
            const title = card.dataset.title;
            const description = card.dataset.description;
            const score = card.dataset.score;
            const source = card.dataset.source;
            
            console.log('Setting topic details:', { title, description, score, source });
            
            document.getElementById('selectedTopicTitle').textContent = title;
            document.getElementById('selectedTopicDescription').textContent = description;
            document.getElementById('selectedTopicScore').textContent = score + '%';
            document.getElementById('selectedTopicSource').textContent = source;
            document.getElementById('selectedTopicDisplay').style.display = 'block';
            
            // IMPORTANT: Clear previous context and set new placeholder
            const contextInput = document.getElementById('selectedTopicDetails');
            contextInput.value = ''; // Clear previous context
            contextInput.readOnly = false;
            contextInput.placeholder = 'Th√™m g√≥c ƒë·ªô, b·ªëi c·∫£nh ri√™ng cho ch·ªß ƒë·ªÅ "' + title + '"...';
            
            // Store selected topic data globally for AI generation
            window.selectedHotTopicData = {
                title: title,
                description: description,
                score: score,
                source: source,
                timestamp: Date.now()
            };
            
            console.log('Hot topic selected and stored:', window.selectedHotTopicData);
        }

        // Update topics counter
        function updateTopicsCounter(filteredCount, totalCount, isFiltered) {
            const counterElement = document.getElementById('topicsCounter');
            if (!counterElement) {
                // Create counter element if it doesn't exist
                const labelsRow = document.querySelector('#hotTopicsInput .d-flex.justify-content-between');
                if (labelsRow) {
                    const counter = document.createElement('small');
                    counter.id = 'topicsCounter';
                    counter.className = 'text-muted';
                    labelsRow.appendChild(counter);
                }
            }
            
            const counter = document.getElementById('topicsCounter');
            if (counter) {
                if (isFiltered) {
                    counter.innerHTML = `<i class="fas fa-filter me-1"></i>Hi·ªÉn th·ªã <strong>${filteredCount}</strong>/<strong>${totalCount}</strong> ch·ªß ƒë·ªÅ`;
                    counter.className = 'text-info fw-bold';
                } else {
                    counter.innerHTML = `<i class="fas fa-list-ul me-1"></i>T·ªïng c·ªông <strong>${totalCount}</strong> ch·ªß ƒë·ªÅ Hot`;
                    counter.className = 'text-muted';
                }
            }
        }

                 // Clear all filters
        window.clearFilters = function() {
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('scoreFilter').value = 'all'; 
            document.getElementById('sourceFilter').value = 'all';
            
            // Display all topics
            displayHotTopics(window.allHotTopics);
        }

        // Update filter options with counts
        function updateFilterOptions(stats) {
            if (!stats) return;
            
            // Update category filter options
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = stats.categories || {};
            
            // Reset to default options with counts
            categoryFilter.innerHTML = `
                <option value="all">T·∫•t c·∫£ chuy√™n m·ª•c (${stats.total || 0})</option>
                <option value="Kinh t·∫ø">Kinh t·∫ø (${categories['Kinh t·∫ø'] || 0})</option>
                <option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá (${categories['C√¥ng ngh·ªá'] || 0})</option>
                <option value="X√£ h·ªôi">X√£ h·ªôi (${categories['X√£ h·ªôi'] || 0})</option>
                <option value="VƒÉn h√≥a">VƒÉn h√≥a (${categories['VƒÉn h√≥a'] || 0})</option>
            `;
            
            // Update score filter options
            const scoreFilter = document.getElementById('scoreFilter');
            const scoreRanges = stats.scoreRanges || {};
            scoreFilter.innerHTML = `
                <option value="all">T·∫•t c·∫£ m·ª©c ƒë·ªô (${stats.total || 0})</option>
                <option value="90">Si√™u Hot 90%+ (${scoreRanges.super_hot || 0})</option>
                <option value="80">Hot 80%+ (${(scoreRanges.super_hot || 0) + (scoreRanges.hot || 0)})</option>
                <option value="70">Trending 70%+ (${stats.total || 0})</option>
            `;
            
            // Update source filter options  
            const sourceFilter = document.getElementById('sourceFilter');
            const sources = stats.sources || {};
            const currentEvents = sources['Current Events'] || 0;
            const techTrends = sources['Tech Trends'] || 0;
            const vietnamese = Object.keys(sources).filter(s => s.includes('Vietnamese')).reduce((sum, key) => sum + (sources[key] || 0), 0);
            const fallback = sources['Fallback Topics'] || 0;
            
            sourceFilter.innerHTML = `
                <option value="all">T·∫•t c·∫£ ngu·ªìn (${stats.total || 0})</option>
                <option value="Current Events">Current Events (${currentEvents})</option>
                <option value="Tech Trends">Tech Trends (${techTrends})</option>
                <option value="Vietnamese">Vietnamese Topics (${vietnamese})</option>
                <option value="Fallback">General Topics (${fallback})</option>
            `;
        }

        function displayAIWritingResults(result, outputType) {
            const resultsSection = document.getElementById('aiWriteResults');
            const outlineSection = document.getElementById('outlineSection');
            const articleSection = document.getElementById('articleSection');

            resultsSection.style.display = 'block';

            if (outputType === 'outline' || outputType === 'both') {
                document.getElementById('outlineContent').innerHTML = formatContent(result.outline || result.content);
                outlineSection.style.display = 'block';
            } else {
                outlineSection.style.display = 'none';
            }

            if (outputType === 'complete' || outputType === 'both') {
                document.getElementById('articleContent').innerHTML = formatContent(result.article || result.content);
                articleSection.style.display = 'block';
            } else {
                articleSection.style.display = 'none';
            }

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

                 function formatContent(content) {
             if (!content) return '<em>Kh√¥ng c√≥ n·ªôi dung</em>';
             
             return content
                 .split('\n')
                 .map(line => {
                     line = line.trim();
                     if (!line) return '';
                     
                     // Format headers
                     if (line.startsWith('#')) {
                         const level = line.match(/^#+/)[0].length;
                         const text = line.replace(/^#+\s*/, '');
                         return `<h${level + 2} class="text-primary mt-3 mb-2">${text}</h${level + 2}>`;
                     }
                     
                     // Format bold text
                     line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                     
                     // Format italic text  
                     line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
                     
                     // Regular paragraph
                     return `<p class="mb-2">${line}</p>`;
                 })
                 .filter(line => line) // Remove empty lines
                 .join('');
         }

        // Copy content function
        window.copyContent = function(elementId) {
            const element = document.getElementById(elementId);
            const text = element.innerText || element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ ƒê√£ copy!';
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-light');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
            });
        };

        // Refine article function
        window.refineArticle = function() {
            // TODO: Implement article refinement functionality
            alert('T√≠nh nƒÉng tinh ch·ªânh ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        };

        // Initialize Hot Topics Feature
        function initializeHotTopicsFeature() {
            // Global variables for hot topics
            window.currentHotTopics = [];
            window.filteredHotTopics = [];

            // Source checkboxes management
            document.getElementById('sourceAll').addEventListener('change', function() {
                const isChecked = this.checked;
                ['sourceGoogle', 'sourceBaoMoi', 'sourceSocial'].forEach(id => {
                    document.getElementById(id).checked = isChecked;
                });
            });

            // Individual source checkboxes
            ['sourceGoogle', 'sourceBaoMoi', 'sourceSocial'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    const allChecked = ['sourceGoogle', 'sourceBaoMoi', 'sourceSocial']
                        .every(sourceId => document.getElementById(sourceId).checked);
                    document.getElementById('sourceAll').checked = allChecked;
                });
            });

            // Load hot topics button
            document.getElementById('loadHotTopicsMainBtn').addEventListener('click', loadMainHotTopics);
            document.getElementById('refreshSourcesBtn').addEventListener('click', refreshHotTopicsSources);

            // Filter change events
            document.getElementById('categoryFilterMain').addEventListener('change', applyMainHotTopicsFilters);
            document.getElementById('hotLevelFilter').addEventListener('change', applyMainHotTopicsFilters);

            // Modal events
            document.getElementById('useTopicForWriting').addEventListener('click', useTopicForAIWriting);
            document.getElementById('copyTopicInfo').addEventListener('click', copyTopicInformation);
        }

        // Load hot topics with enhanced sources
        async function loadMainHotTopics() {
            const loadingDiv = document.getElementById('hotTopicsMainLoading');
            const statsDiv = document.getElementById('hotTopicsStats');
            const resultsDiv = document.getElementById('hotTopicsMainResults');
            const emptyDiv = document.getElementById('hotTopicsEmpty');
            const loadBtn = document.getElementById('loadHotTopicsMainBtn');

            try {
                // Show loading
                loadingDiv.style.display = 'block';
                statsDiv.style.display = 'none';
                resultsDiv.style.display = 'none';
                emptyDiv.style.display = 'none';
                loadBtn.disabled = true;

                // Simulate loading progress
                const progressBar = document.getElementById('loadingProgress');
                const statusText = document.getElementById('loadingStatus');
                const sources = ['Google Trends', 'BaoMoi.com', 'M·∫°ng x√£ h·ªôi'];
                
                for (let i = 0; i < sources.length; i++) {
                    progressBar.style.width = `${(i + 1) * 33.33}%`;
                    statusText.textContent = `ƒêang qu√©t ${sources[i]}...`;
                    await new Promise(resolve => setTimeout(resolve, 600));
                }

                // Get selected sources
                const selectedSources = [];
                if (document.getElementById('sourceGoogle').checked) selectedSources.push('google');
                if (document.getElementById('sourceBaoMoi').checked) selectedSources.push('baomoi');
                if (document.getElementById('sourceSocial').checked) selectedSources.push('social');

                // Call enhanced API
                const response = await fetch(`/api/hot-topics?sources=${selectedSources.join(',')}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                
                // Store data globally
                window.currentHotTopics = data.topics || [];
                window.filteredHotTopics = [...window.currentHotTopics];

                // Update statistics
                updateHotTopicsStatistics(data);

                // Display topics
                displayMainHotTopics(window.filteredHotTopics);

                // Show results
                loadingDiv.style.display = 'none';
                if (window.currentHotTopics.length > 0) {
                    statsDiv.style.display = 'block';
                    resultsDiv.style.display = 'block';
                    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('vi-VN');
                } else {
                    emptyDiv.style.display = 'block';
                }

            } catch (error) {
                console.error('Hot Topics Error:', error);
                loadingDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                alert('Kh√¥ng th·ªÉ t·∫£i ch·ªß ƒë·ªÅ Hot: ' + error.message);
            } finally {
                loadBtn.disabled = false;
            }
        }

        // Display hot topics in enhanced grid
        function displayMainHotTopics(topics) {
            const grid = document.getElementById('hotTopicsMainGrid');
            
            if (!topics || topics.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-search me-2"></i>Kh√¥ng t√¨m th·∫•y ch·ªß ƒë·ªÅ ph√π h·ª£p v·ªõi b·ªô l·ªçc hi·ªán t·∫°i
                        </div>
                    </div>
                `;
                return;
            }

            // IMPORTANT: Update global filteredHotTopics to match displayed topics
            window.filteredHotTopics = [...topics];

            const topicsHTML = topics.map((topic, index) => {
                // Escape quotes and special characters for onclick handlers
                const escapedTitle = topic.title.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const escapedDescription = topic.description.replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                return `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 hot-topic-card-main shadow-sm" data-bs-toggle="modal" data-bs-target="#topicDetailModal" onclick="showTopicDetail(${index})">
                        <div class="card-header bg-gradient text-white ${getScoreColor(topic.score)}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-dark">#${topic.rank || index + 1}</span>
                                <small><i class="fas fa-fire me-1"></i>${topic.score}%</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${topic.title}</h6>
                            <p class="card-text small text-muted">${topic.description.substring(0, 100)}...</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">${topic.category}</span>
                                <small class="text-muted">${topic.source}</small>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary flex-fill me-2" onclick="event.stopPropagation(); quickUseForWriting('${escapedTitle}', '${escapedDescription}')">
                                    <i class="fas fa-edit me-1"></i>Vi·∫øt b√†i
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); quickCopyTopic('${escapedTitle}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            grid.innerHTML = topicsHTML;
        }

        // Apply filters to main hot topics
        function applyMainHotTopicsFilters() {
            if (!window.currentHotTopics || window.currentHotTopics.length === 0) {
                return;
            }

            const categoryFilter = document.getElementById('categoryFilterMain').value;
            const hotLevelFilter = document.getElementById('hotLevelFilter').value;

            let filtered = [...window.currentHotTopics];

            // Filter by category
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(topic => topic.category === categoryFilter);
            }

            // Filter by hot level (score)
            if (hotLevelFilter !== 'all') {
                const minScore = parseInt(hotLevelFilter);
                filtered = filtered.filter(topic => topic.score >= minScore);
            }

            window.filteredHotTopics = filtered;
            displayMainHotTopics(filtered);
        }

        // Update hot topics statistics
        function updateHotTopicsStatistics(data) {
            const stats = data.categoryStats || {};
            const topics = data.topics || [];

            document.getElementById('totalTopicsCount').textContent = topics.length;
            document.getElementById('superHotCount').textContent = topics.filter(t => t.score >= 90).length;
            document.getElementById('sourcesCount').textContent = Object.keys(stats.sources || {}).length;
            document.getElementById('categoriesCount').textContent = Object.keys(stats.categories || {}).length;
        }

        // Get color class based on score
        function getScoreColor(score) {
            if (score >= 95) return 'bg-danger';
            if (score >= 85) return 'bg-warning';
            if (score >= 75) return 'bg-info';
            return 'bg-secondary';
        }

        // Show topic detail in modal
        window.showTopicDetail = function(index) {
            console.log('showTopicDetail called with index:', index);
            console.log('filteredHotTopics length:', window.filteredHotTopics?.length);
            
            const topic = window.filteredHotTopics[index];
            console.log('Selected topic:', topic);
            
            if (!topic) {
                console.error('Topic not found at index:', index);
                return;
            }

            document.getElementById('modalTopicTitle').textContent = topic.title;
            document.getElementById('modalTopicDescription').textContent = topic.description;
            document.getElementById('modalTopicCategory').textContent = topic.category;
            document.getElementById('modalTopicScore').textContent = topic.score + '%';
            document.getElementById('modalTopicSource').textContent = topic.source;
            document.getElementById('modalTopicTime').textContent = new Date().toLocaleString('vi-VN');

            // Generate writing angles
            const angles = generateWritingAngles(topic);
            console.log('Generated angles:', angles);
            const anglesList = document.getElementById('modalWritingAngles');
            anglesList.innerHTML = angles.map(angle => `<li class="mb-1"><i class="fas fa-chevron-right me-2 text-primary"></i>${angle}</li>`).join('');

            // Generate keywords
            const keywords = generateKeywords(topic);
            console.log('Generated keywords:', keywords);
            const keywordsDiv = document.getElementById('modalKeywords');
            keywordsDiv.innerHTML = keywords.map(kw => `<span class="badge bg-light text-dark me-1 mb-1">${kw}</span>`).join('');

            // Store current topic for actions
            window.currentModalTopic = topic;
        };

        // Generate writing angles based on topic
        function generateWritingAngles(topic) {
            const baseAngles = {
                'Kinh t·∫ø': [
                    'Ph√¢n t√≠ch t√°c ƒë·ªông ƒë·∫øn th·ªã tr∆∞·ªùng v√† doanh nghi·ªáp',
                    'G√≥c nh√¨n t·ª´ ng∆∞·ªùi ti√™u d√πng v√† nh√† ƒë·∫ßu t∆∞',
                    'So s√°nh v·ªõi t√¨nh h√¨nh qu·ªëc t·∫ø v√† khu v·ª±c'
                ],
                'C√¥ng ngh·ªá': [
                    '·ª®ng d·ª•ng th·ª±c t·∫ø trong ƒë·ªùi s·ªëng v√† kinh doanh',
                    'Xu h∆∞·ªõng ph√°t tri·ªÉn v√† d·ª± b√°o t∆∞∆°ng lai',
                    'Th√°ch th·ª©c v√† c∆° h·ªôi cho Vi·ªát Nam'
                ],
                'X√£ h·ªôi': [
                    'T√°c ƒë·ªông ƒë·∫øn c√°c t·∫ßng l·ªõp x√£ h·ªôi kh√°c nhau',
                    'Gi·∫£i ph√°p v√† ch√≠nh s√°ch t·ª´ nh√† n∆∞·ªõc',
                    'Kinh nghi·ªám t·ª´ c√°c n∆∞·ªõc kh√°c'
                ],
                'Th·ªÉ thao': [
                    'Ph√¢n t√≠ch k·ªπ thu·∫≠t v√† chi·∫øn thu·∫≠t',
                    'T√°c ƒë·ªông ƒë·∫øn tinh th·∫ßn ng∆∞·ªùi h√¢m m·ªô',
                    '√ù nghƒ©a v·ªõi phong tr√†o th·ªÉ thao Vi·ªát Nam'
                ],
                'Ch·ª©ng kho√°n': [
                    'Ph√¢n t√≠ch k·ªπ thu·∫≠t v√† c∆° b·∫£n',
                    'T√°c ƒë·ªông ƒë·∫øn nh√† ƒë·∫ßu t∆∞ c√° nh√¢n',
                    'Xu h∆∞·ªõng th·ªã tr∆∞·ªùng v√† d·ª± b√°o'
                ],
                'Crypto': [
                    'Ph√¢n t√≠ch bi·∫øn ƒë·ªông v√† nguy√™n nh√¢n',
                    'T√°c ƒë·ªông ƒë·∫øn h·ªá sinh th√°i blockchain',
                    'Quy ƒë·ªãnh ph√°p l√Ω v√† tri·ªÉn v·ªçng'
                ]
            };

            return baseAngles[topic.category] || [
                'Ph√¢n t√≠ch hi·ªán t∆∞·ª£ng v√† nguy√™n nh√¢n',
                'T√°c ƒë·ªông ƒë·∫øn c·ªông ƒë·ªìng v√† x√£ h·ªôi',
                'Gi·∫£i ph√°p v√† h∆∞·ªõng ph√°t tri·ªÉn'
            ];
        }

        // Generate keywords based on topic
        function generateKeywords(topic) {
            if (!topic || !topic.title || !topic.description) {
                console.error('Invalid topic data for keyword generation:', topic);
                return ['Ch·ªß ƒë·ªÅ', 'Hot', 'Trending'];
            }
            
            const words = topic.title.split(' ').concat(topic.description.split(' '));
            const stopwords = ['l√†', 'v√†', 'c·ªßa', 'trong', 'v·ªõi', 'ƒë∆∞·ª£c', 'c√≥', 'ƒë·ªÉ', 't·ª´', 'cho', 'v·ªÅ', 'theo', 'c√°c', 'nh·ªØng', 'n√†y', 'ƒë√≥', 'm·ªôt', 's·∫Ω', 'ƒë√£', 'kh√¥ng', 't·∫°i', 'tr√™n', 'sau', 'tr∆∞·ªõc', 'nh∆∞', 'th√¨', 'r·ªìi', 'm√†', 'n√™n', 'b·ªüi', 'v√¨', 'n·∫øu', 'khi', 'l√∫c'];
            
            const filteredWords = words
                .map(word => word.replace(/[.,!?;:"()]/g, '').trim()) // Remove punctuation
                .filter(word => 
                    word.length > 2 && 
                    !stopwords.includes(word.toLowerCase()) &&
                    !/^\d+$/.test(word) // Exclude pure numbers
                )
                .slice(0, 10) // Get more words first
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase());
            
            // Remove duplicates and return top 8
            const uniqueWords = [...new Set(filteredWords)];
            return uniqueWords.slice(0, 8);
        }

        // Quick use topic for writing
        window.quickUseForWriting = function(title, description) {
            console.log('quickUseForWriting called with:', { title, description });
            
            // Switch to AI writing feature
            const aiWriteBtn = document.querySelector('[data-feature="ai-write"]');
            if (!aiWriteBtn) {
                console.error('AI write button not found');
                alert('Kh√¥ng t√¨m th·∫•y t√≠nh nƒÉng AI vi·∫øt b√†i. Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }
            
            aiWriteBtn.click();
            
            // Wait for UI to load then fill data
            setTimeout(() => {
                const hotTopicsRadio = document.getElementById('fromHotTopics');
                if (hotTopicsRadio) {
                    console.log('Setting hot topics radio to checked');
                    hotTopicsRadio.checked = true;
                    hotTopicsRadio.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        const selectedTopicDetails = document.getElementById('selectedTopicDetails');
                        if (selectedTopicDetails) {
                            console.log('quickUseForWriting: Setting topic details:', title, description);
                            
                            // CLEAR PREVIOUS DATA FIRST
                            selectedTopicDetails.value = '';
                            
                            // Set new topic data with clear format
                            selectedTopicDetails.value = `${title}\n\n${description}`;
                            selectedTopicDetails.readOnly = false;
                            
                            // Update the display
                            const selectedTopicDisplay = document.getElementById('selectedTopicDisplay');
                            const selectedTopicTitle = document.getElementById('selectedTopicTitle');
                            const selectedTopicDescription = document.getElementById('selectedTopicDescription');
                            
                            if (selectedTopicDisplay && selectedTopicTitle && selectedTopicDescription) {
                                selectedTopicTitle.textContent = title;
                                selectedTopicDescription.textContent = description;
                                selectedTopicDisplay.style.display = 'block';
                            }
                            
                            // Store topic data globally (consistent with selectHotTopic)
                            window.selectedHotTopicData = {
                                title: title,
                                description: description,
                                score: 95, // Default high score for standalone topics
                                source: 'Standalone Hot Topics',
                                timestamp: Date.now()
                            };
                            
                            console.log('quickUseForWriting: Stored topic data:', window.selectedHotTopicData);
                            
                            // Clear any existing hot topic card selections in AI Writing
                            document.querySelectorAll('.hot-topic-card').forEach(c => {
                                c.classList.remove('selected', 'border-primary');
                            });
                            
                            // Show success message
                            alert('‚úÖ ƒê√£ chuy·ªÉn ch·ªß ƒë·ªÅ sang AI vi·∫øt b√†i!');
                        } else {
                            console.error('selectedTopicDetails not found');
                            alert('Kh√¥ng th·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin. Vui l√≤ng copy th·ªß c√¥ng.');
                        }
                    }, 800);
                } else {
                    console.error('fromHotTopics radio not found');
                    alert('Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi sang ch·∫ø ƒë·ªô Hot Topics. Vui l√≤ng ch·ªçn th·ªß c√¥ng.');
                }
            }, 500);
        };

        // Quick copy topic
        window.quickCopyTopic = function(title) {
            navigator.clipboard.writeText(title).then(() => {
                // Show temporary success message
                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 1500);
            });
        };

        // Use topic for AI writing (from modal)
        window.useTopicForAIWriting = function() {
            if (!window.currentModalTopic) return;
            
            const topic = window.currentModalTopic;
            bootstrap.Modal.getInstance(document.getElementById('topicDetailModal')).hide();
            
            quickUseForWriting(topic.title, topic.description);
        };

        // Copy topic information (from modal)
        window.copyTopicInformation = function() {
            if (!window.currentModalTopic) return;
            
            const topic = window.currentModalTopic;
            const info = `Ch·ªß ƒë·ªÅ: ${topic.title}\n\nM√¥ t·∫£: ${topic.description}\n\nChuy√™n m·ª•c: ${topic.category}\nƒê·ªô Hot: ${topic.score}%\nNgu·ªìn: ${topic.source}`;
            
            navigator.clipboard.writeText(info).then(() => {
                const btn = document.getElementById('copyTopicInfo');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>ƒê√£ copy!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            });
        };

        // Refresh hot topics sources
        async function refreshHotTopicsSources() {
            const btn = document.getElementById('refreshSourcesBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang refresh...';
            btn.disabled = true;
            
            // Simulate refresh delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Reload topics
            await loadMainHotTopics();
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        // Initialize Content Summary Feature
        function initializeContentSummaryFeature() {
            console.log('Initializing Content Summary feature...');
            
            // Mode switching
            document.querySelectorAll('input[name="summaryMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Summary mode changed to:', this.value);
                    
                    // Hide all input sections
                    document.querySelectorAll('.summary-input-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show appropriate section
                    if (this.value === 'category') {
                        document.getElementById('categoryInput').style.display = 'block';
                    } else if (this.value === 'article') {
                        document.getElementById('articleInput').style.display = 'block';
                    }
                });
            });

            // Generate Summary button
            document.getElementById('generateSummaryBtn').addEventListener('click', async function() {
                const btn = this;
                const originalText = btn.innerHTML;
                
                try {
                    // Get selected mode
                    const summaryMode = document.querySelector('input[name="summaryMode"]:checked').value;
                    console.log('Generating summary for mode:', summaryMode);
                    
                    let url, settings = {};
                    
                    if (summaryMode === 'category') {
                        url = document.getElementById('categoryUrl').value.trim();
                        if (!url) {
                            alert('Vui l√≤ng nh·∫≠p URL chuy√™n m·ª•c!');
                            return;
                        }
                        
                        settings = {
                            length: document.getElementById('categoryLength').value,
                            focus: document.getElementById('categoryFocus').value,
                            maxArticles: parseInt(document.getElementById('maxArticles').value)
                        };
                    } else if (summaryMode === 'article') {
                        url = document.getElementById('articleUrl').value.trim();
                        if (!url) {
                            alert('Vui l√≤ng nh·∫≠p URL b√†i vi·∫øt!');
                            return;
                        }
                        
                        settings = {
                            length: document.getElementById('articleLength').value,
                            style: document.getElementById('articleStyle').value
                        };
                    }
                    
                    // Update button state
                    btn.disabled = true;
                    btn.innerHTML = '‚è≥ ƒêang t√≥m t·∫Øt...';
                    
                    // Call API
                    const response = await fetch('/api/content-summary', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            mode: summaryMode,
                            url: url,
                            settings: settings
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'API Error: ' + response.status);
                    }

                    const result = await response.json();
                    console.log('Summary result:', result);
                    
                    // Display results
                    displaySummaryResults(result, summaryMode, url);

                } catch (error) {
                    console.error('Content Summary Error:', error);
                    
                    let errorMessage = error.message;
                    
                    // Enhanced error messages
                    if (error.message.includes('Kh√¥ng t√¨m th·∫•y b√†i b√°o n√†o')) {
                        errorMessage = `‚ùå Kh√¥ng th·ªÉ t√≥m t·∫Øt chuy√™n m·ª•c n√†y!\n\n` +
                                     `üîç C√≥ th·ªÉ do:\n` +
                                     `‚Ä¢ Trang web ch·∫∑n bot/crawler\n` +
                                     `‚Ä¢ C·∫•u tr√∫c HTML c·ªßa trang thay ƒë·ªïi\n` +
                                     `‚Ä¢ URL chuy√™n m·ª•c kh√¥ng h·ª£p l·ªá\n\n` +
                                     `üí° Gi·∫£i ph√°p:\n` +
                                     `‚Ä¢ Th·ª≠ v·ªõi URL b√†i vi·∫øt ƒë∆°n l·∫ª thay v√¨ chuy√™n m·ª•c\n` +
                                     `‚Ä¢ Copy link b√†i b√°o c·ª• th·ªÉ v√† ch·ªçn "T√≥m t·∫Øt b√†i vi·∫øt"\n` +
                                     `‚Ä¢ Th·ª≠ v·ªõi trang ch·ªß thay v√¨ chuy√™n m·ª•c con`;
                    } else if (error.message.includes('Failed to summarize')) {
                        errorMessage = `‚ùå L·ªói khi t√≥m t·∫Øt n·ªôi dung!\n\n` +
                                     `üîç Nguy√™n nh√¢n c√≥ th·ªÉ:\n` +
                                     `‚Ä¢ K·∫øt n·ªëi m·∫°ng kh√¥ng ·ªïn ƒë·ªãnh\n` +
                                     `‚Ä¢ Trang web kh√¥ng cho ph√©p truy c·∫≠p\n` +
                                     `‚Ä¢ N·ªôi dung qu√° ph·ª©c t·∫°p ƒë·ªÉ x·ª≠ l√Ω\n\n` +
                                     `üí° H√£y th·ª≠ l·∫°i sau v√†i ph√∫t ho·∫∑c s·ª≠ d·ª•ng URL kh√°c`;
                    }
                    
                    alert(errorMessage);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        }

        // Display Summary Results
        function displaySummaryResults(result, mode, url) {
            const resultsSection = document.getElementById('summaryResults');
            const sourceInfo = document.getElementById('sourceInfo');
            const summaryContent = document.getElementById('summaryContent');
            
            // Update source info
            document.getElementById('sourceUrl').textContent = url;
            document.getElementById('sourceType').textContent = mode === 'category' ? 'ƒêi·ªÉm tin chuy√™n m·ª•c' : 'B√†i vi·∫øt ƒë∆°n l·∫ª';
            document.getElementById('summaryTime').textContent = new Date().toLocaleString('vi-VN');
            
            // Format and display summary content
            let formattedContent = '';
            if (result.summary) {
                formattedContent = formatContent(result.summary);
            } else if (result.content) {
                formattedContent = formatContent(result.content);
            } else {
                formattedContent = '<p class="text-muted">Kh√¥ng c√≥ n·ªôi dung t√≥m t·∫Øt.</p>';
            }
            
            summaryContent.innerHTML = formattedContent;
            
            // Store content globally for TTS
            window.currentSummaryContent = result.summary || result.content || '';
            window.currentSummaryUrl = url;
            
            // Show results
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            console.log('Summary displayed successfully');
        }

        // Send to Text to Speech
        window.sendToTTS = function() {
            if (!window.currentSummaryContent) {
                alert('Kh√¥ng c√≥ n·ªôi dung t√≥m t·∫Øt ƒë·ªÉ chuy·ªÉn sang TTS!');
                return;
            }
            
            console.log('Sending content to TTS:', window.currentSummaryContent);
            
            // Switch to TTS feature
            const ttsBtn = document.querySelector('[data-feature="tts"]');
            if (ttsBtn) {
                ttsBtn.click();
                
                // Wait for TTS UI to load then populate content
                setTimeout(() => {
                    const ttsTextarea = document.getElementById('ttsText');
                    if (ttsTextarea) {
                        ttsTextarea.value = window.currentSummaryContent;
                        alert('‚úÖ ƒê√£ chuy·ªÉn n·ªôi dung t√≥m t·∫Øt sang Text to Speech!');
                    } else {
                        // TTS feature not yet implemented
                        alert('üîä T√≠nh nƒÉng Text to Speech s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau.\n\nN·ªôi dung ƒë√£ ƒë∆∞·ª£c copy ƒë·ªÉ chu·∫©n b·ªã:\n\n' + 
                              window.currentSummaryContent.substring(0, 200) + '...');
                    }
                }, 500);
            } else {
                alert('Kh√¥ng t√¨m th·∫•y t√≠nh nƒÉng Text to Speech!');
            }
        };

        // Test API Endpoint Status
        window.testApiEndpoint = async function() {
            const statusSpan = document.getElementById('apiStatus');
            statusSpan.innerHTML = '‚è≥ Testing...';
            
            try {
                console.log('üîç Testing API endpoints...');
                
                // Test 1: Health check
                const healthResponse = await fetch('/api/content-summary?test=health');
                console.log('Health check response:', healthResponse.status, healthResponse.statusText);
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    console.log('Health check data:', healthData);
                    statusSpan.innerHTML = '‚úÖ API is WORKING! Ready to use.';
                    statusSpan.className = 'text-success fw-bold';
                } else {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }
                
                // Test 2: Test summary endpoint
                const testResponse = await fetch('/api/test-summary');
                console.log('Test endpoint response:', testResponse.status);
                
                if (testResponse.ok) {
                    const testData = await testResponse.json();
                    console.log('Test endpoint data:', testData);
                }
                
            } catch (error) {
                console.error('API Test Error:', error);
                statusSpan.innerHTML = `‚ùå API not available: ${error.message}`;
                statusSpan.className = 'text-danger fw-bold';
                
                // Show deployment status
                alert(`üö® API Deployment Issue!\n\n` +
                     `Error: ${error.message}\n\n` +
                     `Possible causes:\n` +
                     `‚Ä¢ Vercel still deploying changes\n` +
                     `‚Ä¢ API function not deployed correctly\n` +
                     `‚Ä¢ Caching issues\n\n` +
                     `üí° Solution: Wait 1-2 minutes and try again`);
            }
        };
    </script>
</body>
</html> 