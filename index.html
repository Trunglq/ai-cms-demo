
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CMS Demo</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 250px; 
            min-width: 250px; 
            background-color: #f8f9fa; 
            padding: 20px;
            flex-shrink: 0;
            border-right: 1px solid #dee2e6;
        }
        .main-content { 
            flex-grow: 1; 
            padding: 20px;
            min-width: 0;
        }
        .list-group-item { 
            cursor: pointer; 
            border: none;
            border-radius: 8px !important;
            margin-bottom: 2px;
            transition: all 0.2s ease;
            color: #495057;
            font-weight: 400;
        }
        .list-group-item:hover {
            background-color: #e9ecef;
            color: #495057;
            transform: translateX(2px);
        }
        .list-group-item.active, .list-group-item:active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        .list-group-item i {
            width: 20px;
            text-align: center;
            opacity: 0.7;
        }
        .list-group-item:hover i, .list-group-item.active i {
            opacity: 1;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
        }
        .translation-output {
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .content-output {
            line-height: 1.6;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .content-output h3, .content-output h4, .content-output h5 {
            color: #0d6efd;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .content-output p {
            margin-bottom: 0.75rem;
            text-align: justify;
        }
        .content-output strong {
            color: #212529;
            font-weight: 600;
        }
        .hot-topic-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        .hot-topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: #0d6efd;
        }
        .hot-topic-card.selected {
            border: 2px solid #0d6efd !important;
            background-color: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(13, 110, 253, 0.15);
        }
        .hot-topic-card .badge {
            font-size: 10px;
        }
        .hot-topic-card .card-title {
            font-size: 14px;
            line-height: 1.3;
            margin-bottom: 8px;
        }
        .hot-topic-card .card-text {
            font-size: 11px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .hot-topic-card-main {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        .hot-topic-card-main:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #0d6efd;
        }
        .hot-topic-card-main .card-title {
            font-size: 15px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 10px;
            color: #212529;
        }
        .hot-topic-card-main .card-text {
            font-size: 13px;
            line-height: 1.4;
            color: #6c757d;
        }
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }
        /* Force horizontal layout for statistics cards - STRONGER CSS */
        #hotTopicsStats {
            display: block !important;
        }
        #hotTopicsStats .row {
            display: flex !important;
            flex-wrap: nowrap !important;
            gap: 0.75rem !important;
            justify-content: space-between !important;
        }
        #hotTopicsStats .col-6,
        #hotTopicsStats .col-md-3 {
            flex: 1 1 0% !important;
            min-width: 0 !important;
            padding: 0 !important;
        }
        @media (max-width: 991.98px) {
            #hotTopicsStats .row {
                flex-wrap: wrap !important;
            }
            #hotTopicsStats .col-6 {
                flex: 1 1 45% !important;
                margin-bottom: 0.75rem;
            }
        }
        /* Ensure card content is properly aligned */
        #hotTopicsStats .card {
            height: 100% !important;
            min-height: 80px !important;
        }
        #hotTopicsStats .d-flex {
            align-items: center !important;
            justify-content: flex-start !important;
            text-align: left !important;
        }
        #hotTopicsStats .card-body {
            padding: 0.75rem !important;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4 class="mb-3 text-center text-primary fw-bold"><i class="fas fa-cogs me-2"></i>Menu Tính Năng</h4>
        <div class="list-group">
            <a class="list-group-item list-group-item-action" data-feature="ai-write"><i class="fas fa-edit me-2"></i>AI viết bài tự động</a>
            <a class="list-group-item list-group-item-action" data-feature="spell-check"><i class="fas fa-spell-check me-2 text-success"></i>Kiểm tra lỗi chính tả</a>
            <a class="list-group-item list-group-item-action" data-feature="hot-topics"><i class="fas fa-fire me-2"></i>Gợi ý chủ đề HOT</a>
            <a class="list-group-item list-group-item-action" data-feature="content-summary"><i class="fas fa-compress-alt me-2"></i>Tóm tắt nội dung</a>
            <a class="list-group-item list-group-item-action" data-feature="tts"><i class="fas fa-volume-up me-2"></i>Text to Speech</a>
            <a class="list-group-item list-group-item-action" data-feature="stt"><i class="fas fa-microphone me-2"></i>Speech to Text</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-en-vi"><i class="fas fa-language me-2 text-success"></i>Dịch Anh sang Việt</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-vi-en"><i class="fas fa-exchange-alt me-2 text-success"></i>Dịch Việt sang Anh</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-url"><i class="fas fa-link me-2 text-success"></i>Dịch từ URL báo</a>
            <a class="list-group-item list-group-item-action" data-feature="publish"><i class="fas fa-rocket me-2"></i>Xuất bản đa nền tảng</a>
            <a class="list-group-item list-group-item-action" data-feature="score-article"><i class="fas fa-chart-bar me-2"></i>Chấm điểm bài báo</a>
            <a class="list-group-item list-group-item-action" data-feature="image-manage"><i class="fas fa-images me-2"></i>Quản lý ảnh bằng AI</a>
        </div>
    </div>
    <div class="main-content" id="feature-content">
        <h2>Chào mừng đến với AI CMS Demo</h2>
        <p>Chọn một tính năng từ menu bên trái để bắt đầu.</p>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // For local testing only: Paste your OpenAI key here. Remove or leave empty for production (uses serverless).
        const LOCAL_OPENAI_KEY = ''; // Paste 'sk-proj-...' here for local test. Do not commit!

        document.querySelectorAll('.list-group-item').forEach(item => {
            item.addEventListener('click', async function() {
                const feature = this.getAttribute('data-feature');
                const content = document.getElementById('feature-content');
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

                if (feature === 'translate-en-vi' || feature === 'translate-vi-en') {
                    const fromLang = feature === 'translate-en-vi' ? 'Anh' : 'Việt';
                    const toLang = feature === 'translate-en-vi' ? 'Việt' : 'Anh';
                    const direction = feature === 'translate-en-vi' ? 'en-vi' : 'vi-en';
                    const inputLabel = `Nhập văn bản tiếng ${fromLang}:`;
                    const outputLabel = `Kết quả dịch (tiếng ${toLang}):`;

                    content.innerHTML = `
                        <h2>Dịch ${fromLang} sang ${toLang}</h2>
                        <div class="mb-3">
                            <label for="inputText" class="form-label">${inputLabel}</label>
                            <textarea class="form-control" id="inputText" rows="5"></textarea>
                        </div>
                        <button id="translateBtn" class="btn btn-primary">Dịch</button>
                        <div class="mt-3" style="min-width: 0;">
                            <label class="form-label">${outputLabel}</label>
                            <div class="translation-output border p-3 bg-light" style="min-height: 100px; position: relative;">
                                <button id="copyBtn" class="btn btn-sm btn-outline-secondary copy-btn" style="display: none;" onclick="copyToClipboard()">
                                    📋 Copy
                                </button>
                                <div id="outputText"></div>
                            </div>
                        </div>
                    `;

                    // Add copy function to global scope
                    window.copyToClipboard = function() {
                        const outputText = document.getElementById('outputText').innerText;
                        if (outputText && outputText !== 'Đang dịch...') {
                            navigator.clipboard.writeText(outputText).then(() => {
                                const copyBtn = document.getElementById('copyBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '✅ Đã copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-secondary');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-secondary');
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy: ', err);
                                alert('Không thể copy. Vui lòng copy thủ công.');
                            });
                        }
                    };

                    document.getElementById('translateBtn').addEventListener('click', async () => {
                        const input = document.getElementById('inputText').value;
                        if (!input) return alert('Vui lòng nhập văn bản!');
                        
                        // Show loading state
                        const outputElement = document.getElementById('outputText');
                        const copyBtn = document.getElementById('copyBtn');
                        outputElement.innerText = 'Đang dịch...';
                        copyBtn.style.display = 'none';

                        try {
                            let response;
                            if (isLocal && LOCAL_OPENAI_KEY) {
                                // Local direct call for testing
                                response = await fetch('https://api.openai.com/v1/chat/completions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${LOCAL_OPENAI_KEY}`
                                    },
                                    body: JSON.stringify({
                                        model: 'gpt-3.5-turbo',
                                        messages: [{ role: 'user', content: `Dịch văn bản sau từ tiếng ${fromLang} sang tiếng ${toLang}: ${input}` }]
                                    })
                                });
                            } else {
                                // Production: Call serverless endpoint
                                response = await fetch('/api/translate', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ text: input, direction })
                                });
                            }

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const data = await response.json();
                            const translatedText = isLocal ? data.choices[0].message.content : data.translatedText;
                            outputElement.innerText = translatedText;
                            
                            // Show copy button after successful translation
                            if (translatedText && translatedText !== 'Đang dịch...') {
                                copyBtn.style.display = 'block';
                            }
                        } catch (error) {
                            console.error(error);
                            outputElement.innerText = 'Lỗi khi dịch. Vui lòng thử lại.';
                            copyBtn.style.display = 'none';
                            alert('Lỗi khi gọi API: ' + error.message + ' (Nếu local, kiểm tra key và mạng)');
                        }
                    });
                } else if (feature === 'spell-check') {
                    content.innerHTML = `
                        <h2>Kiểm tra lỗi chính tả</h2>
                        <div class="mb-3">
                            <label for="inputText" class="form-label">Nhập văn bản cần kiểm tra:</label>
                            <textarea class="form-control" id="inputText" rows="5"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <select id="languageSelect" class="form-select mb-3">
                                    <option value="vi">Tiếng Việt</option>
                                    <option value="en">Tiếng Anh</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select id="modeSelect" class="form-select mb-3">
                                    <option value="conservative">Chỉ lỗi thực sự</option>
                                    <option value="comprehensive">Gợi ý + cải thiện</option>
                                </select>
                            </div>
                        </div>
                        <button id="checkBtn" class="btn btn-primary">Kiểm tra</button>
                        
                        <!-- Results Section -->
                        <div class="mt-4" id="resultsSection" style="display: none;">
                            <!-- Status Alert -->
                            <div id="statusAlert" class="alert" role="alert"></div>
                            
                            <!-- Errors Section -->
                            <div id="errorsSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-danger mb-0">🔴 Lỗi cần sửa:</h5>
                                    <button id="fixAllBtn" class="btn btn-danger btn-sm" onclick="applyAllChanges('error')">
                                        🔧 Sửa tất cả
                                    </button>
                                </div>
                                <div id="errorsList" class="mb-3"></div>
                            </div>
                            
                            <!-- Suggestions Section -->
                            <div id="suggestionsSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-info mb-0">💡 Gợi ý cải thiện (tùy chọn):</h5>
                                    <button id="applyAllSuggestionsBtn" class="btn btn-info btn-sm" onclick="applyAllChanges('suggestion')">
                                        💡 Áp dụng tất cả
                                    </button>
                                </div>
                                <div id="suggestionsList" class="mb-3"></div>
                            </div>
                            
                            <!-- Preview Section -->
                            <div id="previewSection" style="display: none;">
                                <h5>📄 Xem trước kết quả:</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Văn bản gốc:</label>
                                        <div id="originalText" class="border p-3 bg-light" style="min-height: 100px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label class="form-label">Văn bản sau khi áp dụng:</label>
                                            <button id="copyFinalTextBtn" class="btn btn-sm btn-outline-success" onclick="copyFinalText()" style="display: none;">
                                                📋 Copy kết quả
                                            </button>
                                        </div>
                                        <div id="finalText" class="border p-3 bg-light" style="min-height: 100px; position: relative;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Spell Check Logic with new UI
                    window.appliedChanges = new Set();
                    window.allErrors = [];
                    window.allSuggestions = [];
                    window.originalText = '';
                    
                    document.getElementById('checkBtn').addEventListener('click', async () => {
                        const input = document.getElementById('inputText').value;
                        const language = document.getElementById('languageSelect').value;
                        const mode = document.getElementById('modeSelect').value;
                        if (!input) return alert('Vui lòng nhập văn bản!');

                        const checkBtn = document.getElementById('checkBtn');
                        checkBtn.disabled = true;
                        checkBtn.textContent = 'Đang kiểm tra...';

                        try {
                            const response = await fetch('/api/spellcheck', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ text: input, language, mode })
                            });

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const result = await response.json();
                            
                            // Debug logging
                            console.log('Spell check result:', result);
                            
                            // Show results section
                            document.getElementById('resultsSection').style.display = 'block';
                            
                            // Store data globally
                            window.appliedChanges.clear();
                            window.allErrors = result.errors || [];
                            window.allSuggestions = result.suggestions || [];
                            window.originalText = input;
                            
                            // Show status
                            const statusAlert = document.getElementById('statusAlert');
                            if (!result.hasErrors && (!result.suggestions || result.suggestions.length === 0)) {
                                statusAlert.className = 'alert alert-success';
                                statusAlert.innerHTML = '✅ <strong>Tuyệt vời!</strong> Không phát hiện lỗi chính tả hoặc ngữ pháp nào.';
                                document.getElementById('errorsSection').style.display = 'none';
                                document.getElementById('suggestionsSection').style.display = 'none';
                                document.getElementById('previewSection').style.display = 'none';
                            } else {
                                statusAlert.className = 'alert alert-warning';
                                statusAlert.innerHTML = `📝 Tìm thấy ${result.errors?.length || 0} lỗi và ${result.suggestions?.length || 0} gợi ý cải thiện.`;
                                
                                // Show errors
                                if (result.errors && result.errors.length > 0) {
                                    document.getElementById('errorsSection').style.display = 'block';
                                    displayChanges('errorsList', result.errors, 'error');
                                } else {
                                    document.getElementById('errorsSection').style.display = 'none';
                                }
                                
                                // Show suggestions
                                if (result.suggestions && result.suggestions.length > 0) {
                                    document.getElementById('suggestionsSection').style.display = 'block';
                                    displayChanges('suggestionsList', result.suggestions, 'suggestion');
                                } else {
                                    document.getElementById('suggestionsSection').style.display = 'none';
                                }
                                
                                // Show preview
                                document.getElementById('previewSection').style.display = 'block';
                                updatePreviewFromAppliedChanges();
                            }
                            
                        } catch (error) {
                            console.error(error);
                            document.getElementById('statusAlert').className = 'alert alert-danger';
                            document.getElementById('statusAlert').innerHTML = `❌ <strong>Lỗi:</strong> ${error.message}`;
                            document.getElementById('resultsSection').style.display = 'block';
                        } finally {
                            checkBtn.disabled = false;
                            checkBtn.textContent = 'Kiểm tra';
                        }
                    });

                    function displayChanges(containerId, changes, type) {
                        const container = document.getElementById(containerId);
                        const isError = type === 'error';
                        const bgColor = isError ? 'border-danger' : 'border-info';
                        const textColor = isError ? 'text-danger' : 'text-info';
                        
                        const html = changes.map((change, index) => {
                            const changeId = `${type}_${index}`;
                            return `
                                <div class="card mb-2 ${bgColor}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <span class="text-decoration-line-through text-muted">"${change.from}"</span>
                                                <span class="mx-2">→</span>
                                                <span class="${textColor} fw-bold">"${change.to}"</span>
                                                <br><small class="text-muted mt-1">
                                                    <span class="badge bg-secondary">${change.type || 'unknown'}</span> 
                                                    ${change.reason}
                                                </small>
                                            </div>
                                            <button class="btn btn-sm ${isError ? 'btn-danger' : 'btn-outline-info'}" 
                                                    onclick="toggleChange('${changeId}', '${change.from}', '${change.to}', this)">
                                                ${isError ? '🔧 Sửa' : '💡 Áp dụng'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = html;
                    }
                    
                    // Apply all changes of a specific type
                    window.applyAllChanges = function(type) {
                        const changes = type === 'error' ? window.allErrors : window.allSuggestions;
                        changes.forEach((change, index) => {
                            const changeId = `${type}_${index}`;
                            window.appliedChanges.add(changeId);
                            
                            // Update button appearance
                            const button = document.querySelector(`[onclick*="${changeId}"]`);
                            if (button) {
                                button.textContent = '✅ Đã áp dụng';
                                button.classList.remove('btn-danger', 'btn-outline-info');
                                button.classList.add('btn-success');
                            }
                        });
                        
                        updatePreviewFromAppliedChanges();
                        
                        // Update the "Apply All" button
                        const applyAllBtn = type === 'error' ? 
                            document.getElementById('fixAllBtn') : 
                            document.getElementById('applyAllSuggestionsBtn');
                        applyAllBtn.textContent = `✅ Đã áp dụng tất cả`;
                        applyAllBtn.classList.add('btn-success');
                        applyAllBtn.disabled = true;
                    };
                    
                    window.toggleChange = function(changeId, fromText, toText, button) {
                        if (window.appliedChanges.has(changeId)) {
                            window.appliedChanges.delete(changeId);
                            button.textContent = button.textContent.includes('🔧') ? '🔧 Sửa' : '💡 Áp dụng';
                            button.classList.remove('btn-success');
                            button.classList.add(button.textContent.includes('🔧') ? 'btn-danger' : 'btn-outline-info');
                        } else {
                            window.appliedChanges.add(changeId);
                            button.textContent = '✅ Đã áp dụng';
                            button.classList.remove('btn-danger', 'btn-outline-info');
                            button.classList.add('btn-success');
                        }
                        
                        // Update preview
                        updatePreviewFromAppliedChanges();
                        
                        // Update "Apply All" button status
                        updateApplyAllButtonStatus();
                    };
                    
                    function updateApplyAllButtonStatus() {
                        // Check errors
                        const appliedErrors = window.allErrors.filter((_, index) => 
                            window.appliedChanges.has(`error_${index}`)
                        ).length;
                        const fixAllBtn = document.getElementById('fixAllBtn');
                        if (fixAllBtn) {
                            if (appliedErrors === window.allErrors.length && window.allErrors.length > 0) {
                                fixAllBtn.textContent = '✅ Đã sửa tất cả';
                                fixAllBtn.classList.add('btn-success');
                                fixAllBtn.disabled = true;
                            } else {
                                fixAllBtn.textContent = '🔧 Sửa tất cả';
                                fixAllBtn.classList.remove('btn-success');
                                fixAllBtn.disabled = false;
                            }
                        }
                        
                        // Check suggestions
                        const appliedSuggestions = window.allSuggestions.filter((_, index) => 
                            window.appliedChanges.has(`suggestion_${index}`)
                        ).length;
                        const applyAllBtn = document.getElementById('applyAllSuggestionsBtn');
                        if (applyAllBtn) {
                            if (appliedSuggestions === window.allSuggestions.length && window.allSuggestions.length > 0) {
                                applyAllBtn.textContent = '✅ Đã áp dụng tất cả';
                                applyAllBtn.classList.add('btn-success');
                                applyAllBtn.disabled = true;
                            } else {
                                applyAllBtn.textContent = '💡 Áp dụng tất cả';
                                applyAllBtn.classList.remove('btn-success');
                                applyAllBtn.disabled = false;
                            }
                        }
                    }
                    
                    function updatePreviewFromAppliedChanges() {
                        console.log('Updating preview from applied changes...');
                        let originalText = window.originalText;
                        let finalText = window.originalText;
                        
                        console.log('Original text:', originalText);
                        console.log('Applied changes:', Array.from(window.appliedChanges));
                        
                        // Apply all selected changes with highlighting
                        const allChangesToApply = [];
                        
                        // Collect all applied changes
                        window.appliedChanges.forEach(changeId => {
                            const [type, index] = changeId.split('_');
                            const changes = type === 'error' ? window.allErrors : window.allSuggestions;
                            const change = changes[parseInt(index)];
                            if (change) {
                                allChangesToApply.push({...change, type, applied: true});
                            }
                        });
                        
                        // Also collect non-applied changes for highlighting
                        [...window.allErrors, ...window.allSuggestions].forEach((change, globalIndex) => {
                            const type = globalIndex < window.allErrors.length ? 'error' : 'suggestion';
                            const localIndex = type === 'error' ? globalIndex : globalIndex - window.allErrors.length;
                            const changeId = `${type}_${localIndex}`;
                            
                            if (!window.appliedChanges.has(changeId)) {
                                allChangesToApply.push({...change, type, applied: false});
                            }
                        });
                        
                        // Sort changes by position in text (reverse order to avoid position shifts)
                        allChangesToApply.sort((a, b) => {
                            const posA = originalText.indexOf(a.from);
                            const posB = originalText.indexOf(b.from);
                            return posB - posA;
                        });
                        
                        // Apply changes to final text and create highlighted versions
                        let highlightedOriginal = originalText;
                        let highlightedFinal = originalText;
                        
                        allChangesToApply.forEach(change => {
                            // Simple exact match - avoid complex regex for Vietnamese text
                            const exactMatch = new RegExp(escapeRegex(change.from), 'gi');
                            
                            if (change.applied) {
                                // Apply the change to final text
                                finalText = finalText.replace(exactMatch, change.to);
                                
                                // Highlight in original (red = will be changed)
                                highlightedOriginal = highlightedOriginal.replace(exactMatch, 
                                    `<span style="background-color: #ffebee; text-decoration: line-through; color: #c62828;">${change.from}</span>`
                                );
                                
                                // Highlight in final text - need to apply changes first, then highlight
                            } else {
                                // Just highlight as available for change (yellow)
                                const isError = change.type === 'error';
                                const highlightColor = isError ? '#fff3e0' : '#f3e5f5';
                                const borderColor = isError ? '#ff9800' : '#9c27b0';
                                
                                highlightedOriginal = highlightedOriginal.replace(exactMatch, 
                                    `<span style="background-color: ${highlightColor}; border: 1px solid ${borderColor}; border-radius: 2px; padding: 1px 2px;">${change.from}</span>`
                                );
                            }
                        });
                        
                        // Apply highlighting to final text AFTER all changes are made
                        highlightedFinal = finalText;
                        allChangesToApply.forEach(change => {
                            if (change.applied) {
                                const toExactMatch = new RegExp(escapeRegex(change.to), 'gi');
                                highlightedFinal = highlightedFinal.replace(toExactMatch, 
                                    `<span style="background-color: #e8f5e8; font-weight: bold; color: #2e7d32;">${change.to}</span>`
                                );
                            }
                        });
                        
                        // Update the display - use innerHTML for highlighting
                        document.getElementById('originalText').innerHTML = highlightedOriginal || originalText;
                        
                        const hasAppliedChanges = allChangesToApply.some(c => c.applied);
                        if (hasAppliedChanges) {
                            document.getElementById('finalText').innerHTML = highlightedFinal;
                            document.getElementById('copyFinalTextBtn').style.display = 'inline-block';
                            // Store clean text for copying
                            window.finalCleanText = finalText;
                        } else {
                            document.getElementById('finalText').innerHTML = '<em class="text-muted">Chọn các thay đổi bên trên để xem preview...</em>';
                            document.getElementById('copyFinalTextBtn').style.display = 'none';
                            window.finalCleanText = '';
                        }
                    }
                    
                    // Copy final text function
                    window.copyFinalText = function() {
                        const textToCopy = window.finalCleanText || window.originalText;
                        if (textToCopy) {
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                const copyBtn = document.getElementById('copyFinalTextBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '✅ Đã copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-success');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-success');
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy: ', err);
                                alert('Không thể copy. Vui lòng copy thủ công.');
                            });
                        }
                    };
                    
                    function escapeRegex(string) {
                        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    }
                    
                    // Debug function
                    function debugPreview() {
                        console.log('Original text:', window.originalText);
                        console.log('Applied changes:', Array.from(window.appliedChanges));
                        console.log('All errors:', window.allErrors);
                        console.log('All suggestions:', window.allSuggestions);
                    }
                } else if (feature === 'translate-url') {
                    content.innerHTML = `
                        <h2>Dịch Bài Báo Từ URL</h2>
                        <div class="mb-3">
                            <label for="urlInput" class="form-label">Nhập URL bài báo:</label>
                            <input type="url" class="form-control" id="urlInput" placeholder="https://example.com/article">
                        </div>
                        <div class="mb-3">
                            <label for="urlDirection" class="form-label">Hướng dịch:</label>
                            <select id="urlDirection" class="form-select">
                                <option value="en-vi">Anh sang Việt (VnEconomy style)</option>
                                <option value="vi-en">Việt sang Anh</option>
                            </select>
                        </div>
                        <button id="translateUrlBtn" class="btn btn-primary">Dịch Bài Báo</button>
                        <div class="mt-3" id="urlResultSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Bài gốc:</h5>
                                    <div class="border p-3 bg-light" style="max-height: 400px; overflow-y: auto;">
                                        <h6 id="originalTitle" class="text-primary"></h6>
                                        <small class="text-muted" id="originalUrl"></small>
                                        <p id="originalPreview" class="mt-2"></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>Bài đã dịch:</h5>
                                    <div class="translation-output border p-3 bg-light" style="max-height: 400px; overflow-y: auto; position: relative;">
                                        <button id="urlCopyBtn" class="btn btn-sm btn-outline-secondary copy-btn" style="display: none;" onclick="copyUrlTranslation()">
                                            📋 Copy
                                        </button>
                                        <h6 id="translatedTitle" class="text-success"></h6>
                                        <div id="translatedContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Copy function for URL translation
                    window.copyUrlTranslation = function() {
                        const title = document.getElementById('translatedTitle').innerText;
                        const content = document.getElementById('translatedContent').innerText;
                        const fullText = title + '\n\n' + content;
                        
                        if (fullText.trim() && title !== 'Không có tiêu đề' && content !== 'Không có nội dung') {
                            navigator.clipboard.writeText(fullText).then(() => {
                                const copyBtn = document.getElementById('urlCopyBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '✅ Đã copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-secondary');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-secondary');
                                }, 2000);
                            }).catch(err => {
                                alert('Không thể copy. Vui lòng copy thủ công.');
                            });
                        }
                    };

                    document.getElementById('translateUrlBtn').addEventListener('click', async () => {
                        const url = document.getElementById('urlInput').value;
                        const direction = document.getElementById('urlDirection').value;
                        
                        if (!url) return alert('Vui lòng nhập URL bài báo!');
                        
                        const btn = document.getElementById('translateUrlBtn');
                        const resultSection = document.getElementById('urlResultSection');
                        
                        btn.innerHTML = 'Đang tải và dịch...';
                        btn.disabled = true;
                        resultSection.style.display = 'none';

                        try {
                            const response = await fetch('/api/translate-url', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url, direction })
                            });

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const data = await response.json();

                            // Display results
                            document.getElementById('originalTitle').innerText = data.original?.title || 'Không có tiêu đề';
                            document.getElementById('originalUrl').innerText = url;
                            document.getElementById('originalPreview').innerText = data.original?.content || 'Không có nội dung';
                            
                            document.getElementById('translatedTitle').innerText = data.translated?.title || 'Không có tiêu đề';
                            document.getElementById('translatedContent').innerText = data.translated?.content || 'Không có nội dung';
                            
                            resultSection.style.display = 'block';
                            document.getElementById('urlCopyBtn').style.display = 'block';
                            
                        } catch (error) {
                            console.error(error);
                            
                            // Try to parse error message from response
                            let errorMessage = 'Lỗi khi dịch URL.';
                            if (error.message.includes('400')) {
                                errorMessage = 'Không thể trích xuất nội dung từ URL này. Vui lòng thử URL khác hoặc kiểm tra URL có hợp lệ không.';
                            } else if (error.message.includes('500')) {
                                errorMessage = 'Lỗi server khi xử lý URL. Vui lòng thử lại sau.';
                            } else {
                                errorMessage = 'Lỗi khi dịch URL: ' + error.message + '\nVui lòng kiểm tra URL có hợp lệ không.';
                            }
                            
                            alert(errorMessage);
                        } finally {
                            btn.innerHTML = 'Dịch Bài Báo';
                            btn.disabled = false;
                        }
                    });
                } else if (feature === 'ai-write') {
                    content.innerHTML = `
                        <h2>📝 AI Viết Bài Tự Động</h2>
                        <div class="card">
                            <div class="card-body">
                                <!-- Input Method Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-bullseye me-2"></i>Nguồn nội dung:</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromTopic" value="topic" checked>
                                                <label class="form-check-label" for="fromTopic">
                                                    <i class="fas fa-lightbulb me-1"></i> Từ chủ đề
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromHotTopics" value="hottopics">
                                                <label class="form-check-label" for="fromHotTopics">
                                                    <i class="fas fa-fire me-1"></i> Chủ đề Hot
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromArticles" value="articles">
                                                <label class="form-check-label" for="fromArticles">
                                                    <i class="fas fa-newspaper me-1"></i> Từ bài báo có sẵn
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromWord" value="word">
                                                <label class="form-check-label" for="fromWord">
                                                    <i class="fas fa-file-word me-1"></i> Từ file Word
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Topic Input -->
                                <div id="topicInput" class="input-section">
                                    <div class="mb-3">
                                        <label for="topicText" class="form-label"><i class="fas fa-lightbulb me-2"></i>Chủ đề bài viết:</label>
                                        <textarea class="form-control" id="topicText" rows="3" placeholder="VD: Tác động của AI đối với ngành báo chí Việt Nam, xu hướng phát triển công nghệ blockchain..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="topicContext" class="form-label"><i class="fas fa-edit me-2"></i>Bối cảnh/Góc độ (tùy chọn):</label>
                                        <textarea class="form-control" id="topicContext" rows="2" placeholder="Thêm bối cảnh, góc độ tiếp cận, hoặc thông tin cần lưu ý..."></textarea>
                                    </div>
                                </div>

                                <!-- Hot Topics Input -->
                                <div id="hotTopicsInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label"><i class="fas fa-fire me-2"></i>Top 10 Chủ Đề Hot Hiện Tại:</label>
                                            <button id="refreshHotTopicsBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-sync-alt me-1"></i>Refresh Topics</button>
                                        </div>
                                        <div class="row align-items-center mb-3">
                                            <div class="col-md-4">
                                                <label for="categoryFilter" class="form-label small"><i class="fas fa-folder me-1"></i>Chuyên mục:</label>
                                                <select id="categoryFilter" class="form-select form-select-sm">
                                                    <option value="all">Tất cả chuyên mục</option>
                                                    <option value="Kinh tế">Kinh tế</option>
                                                    <option value="Công nghệ">Công nghệ</option>
                                                    <option value="Xã hội">Xã hội</option>
                                                    <option value="Văn hóa">Văn hóa</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small"><i class="fas fa-chart-line me-1"></i>Trend Score:</label>
                                                <select id="scoreFilter" class="form-select form-select-sm">
                                                    <option value="all">Tất cả mức độ</option>
                                                    <option value="90">Siêu Hot (90%+)</option>
                                                    <option value="80">Hot (80%+)</option>
                                                    <option value="70">Trending (70%+)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small"><i class="fas fa-rss me-1"></i>Nguồn:</label>
                                                <select id="sourceFilter" class="form-select form-select-sm">
                                                    <option value="all">Tất cả nguồn</option>
                                                    <option value="Current Events">Current Events</option>
                                                    <option value="Tech Trends">Tech Trends</option>
                                                    <option value="Vietnamese">Vietnamese Topics</option>
                                                    <option value="Fallback">General Topics</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="hotTopicsLoading" class="text-center py-3" style="display: none;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Đang tải...</span>
                                            </div>
                                            <p class="mt-2">Đang lấy trending topics từ Google Trends & Social Media...</p>
                                        </div>
                                        <div id="hotTopicsList" class="row">
                                            <!-- Hot topics will be populated here -->
                                        </div>
                                        <div class="mt-3">
                                            <label for="selectedTopicDetails" class="form-label"><i class="fas fa-edit me-2"></i>Chi tiết chủ đề đã chọn:</label>
                                            <div id="selectedTopicDisplay" class="alert alert-info" style="display: none;">
                                                <strong id="selectedTopicTitle">Chưa chọn chủ đề</strong>
                                                <p id="selectedTopicDescription" class="mb-1"></p>
                                                <small class="text-muted">Trend score: <span id="selectedTopicScore">-</span> | Source: <span id="selectedTopicSource">-</span></small>
                                            </div>
                                            <textarea class="form-control" id="selectedTopicDetails" rows="3" placeholder="Góc độ và bối cảnh bổ sung cho chủ đề Hot (tùy chọn)..." readonly></textarea>
                                            <div class="form-text"><i class="fas fa-info-circle me-1"></i>Chọn một chủ đề Hot ở trên, sau đó có thể thêm góc độ riêng</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Articles Input -->
                                <div id="articlesInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label"><i class="fas fa-newspaper me-2"></i>Bài báo nguồn (có thể paste nhiều bài):</label>
                                        <div id="articlesContainer">
                                            <div class="article-input mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-newspaper me-1"></i>Bài 1</span>
                                                    <textarea class="form-control article-content" rows="4" placeholder="Paste nội dung bài báo thứ 1..."></textarea>
                                                    <button class="btn btn-outline-danger remove-article" type="button"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                        <button id="addArticleBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-plus me-1"></i>Thêm bài báo</button>
                                    </div>
                                </div>

                                <!-- Word File Input -->
                                <div id="wordInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <label for="wordFile" class="form-label"><i class="fas fa-file-word me-2"></i>Upload file Word:</label>
                                        <input class="form-control" type="file" id="wordFile" accept=".doc,.docx,.txt">
                                        <div class="form-text">Hỗ trợ: .doc, .docx, .txt (tối đa 10MB)</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="wordPreview" class="form-label"><i class="fas fa-eye me-2"></i>Nội dung file (preview):</label>
                                        <textarea class="form-control" id="wordPreview" rows="5" placeholder="Nội dung file sẽ hiển thị ở đây..." readonly></textarea>
                                    </div>
                                </div>

                                <!-- Article Configuration -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="articleType" class="form-label"><i class="fas fa-file-alt me-2"></i>Dạng bài báo:</label>
                                        <select id="articleType" class="form-select">
                                            <option value="tin-van">Tin vắn (200-400 từ)</option>
                                            <option value="tin-tong-hop">Tin tổng hợp (400-800 từ)</option>
                                            <option value="phong-su-ngan">Phóng sự ngắn (600-1000 từ)</option>
                                            <option value="bai-phan-tich">Bài phân tích (800-1200 từ)</option>
                                            <option value="phong-su-dai">Phóng sự dài (1000-2000 từ)</option>
                                            <option value="bai-binh-luan">Bài bình luận (600-1000 từ)</option>
                                            <option value="bao-cao-chuyen-sau">Báo cáo chuyên sâu (1200+ từ)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="outputType" class="form-label"><i class="fas fa-cog me-2"></i>Loại output:</label>
                                        <select id="outputType" class="form-select">
                                            <option value="outline">Sườn bài báo (để editor hoàn thiện)</option>
                                            <option value="complete">Bài báo hoàn chỉnh</option>
                                            <option value="both">Cả hai (Sườn + Bài hoàn chỉnh)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Writing Style Options -->
                                <div class="mb-4">
                                    <label class="form-label"><i class="fas fa-palette me-2"></i>Phong cách viết:</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <select id="writingTone" class="form-select">
                                                <option value="objective">Khách quan, trung tính</option>
                                                <option value="engaging">Hấp dẫn, thu hút</option>
                                                <option value="formal">Trang trọng, chính thức</option>
                                                <option value="casual">Gần gũi, dễ hiểu</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <select id="targetAudience" class="form-select">
                                                <option value="general">Độc giả đại chúng</option>
                                                <option value="business">Cộng đồng doanh nghiệp</option>
                                                <option value="tech">Cộng đồng công nghệ</option>
                                                <option value="youth">Giới trẻ, sinh viên</option>
                                                <option value="professional">Chuyên gia, chuyên ngành</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Generate Button -->
                                <div class="text-center">
                                    <button id="generateArticleBtn" class="btn btn-primary btn-lg">
                                        <i class="fas fa-magic me-2"></i>Tạo Bài Báo AI
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div class="mt-4" id="aiWriteResults" style="display: none;">
                            <!-- Outline Section -->
                            <div id="outlineSection" class="card mb-4" style="display: none;">
                                <div class="card-header bg-info text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Sườn Bài Báo</h5>
                                        <button class="btn btn-light btn-sm" onclick="copyContent('outlineContent')"><i class="fas fa-copy me-1"></i>Copy Sườn</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="outlineContent" class="content-output"></div>
                                </div>
                            </div>

                            <!-- Complete Article Section -->
                            <div id="articleSection" class="card mb-4" style="display: none;">
                                <div class="card-header bg-success text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Bài Báo Hoàn Chỉnh</h5>
                                        <div>
                                            <button class="btn btn-light btn-sm me-2" onclick="copyContent('articleContent')"><i class="fas fa-copy me-1"></i>Copy Bài</button>
                                            <button class="btn btn-warning btn-sm" onclick="refineArticle()"><i class="fas fa-edit me-1"></i>Tinh Chỉnh</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="articleContent" class="content-output"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    // AI Writing Logic
                    setupAIWritingFeature();
                } else if (feature === 'hot-topics') {
                    content.innerHTML = `
                        <h2><i class="fas fa-fire me-2 text-danger"></i>Gợi Ý Chủ Đề HOT</h2>
                        <div class="card">
                            <div class="card-body">
                                <!-- Source Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-database me-2"></i>Nguồn dữ liệu:</label>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sourceAll" value="all" checked>
                                                <label class="form-check-label" for="sourceAll">
                                                    <i class="fas fa-globe me-1"></i> Tất cả nguồn
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sourceGoogle" value="google" checked>
                                                <label class="form-check-label" for="sourceGoogle">
                                                    <i class="fab fa-google me-1"></i> Google Trends
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sourceBaoMoi" value="baomoi" checked>
                                                <label class="form-check-label" for="sourceBaoMoi">
                                                    <i class="fas fa-newspaper me-1"></i> BaoMoi.com
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="sourceSocial" value="social" checked>
                                                <label class="form-check-label" for="sourceSocial">
                                                    <i class="fas fa-share-alt me-1"></i> Mạng xã hội
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Category Filter -->
                                <div class="mb-4">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label for="categoryFilterMain" class="form-label fw-bold"><i class="fas fa-tags me-2"></i>Chuyên mục:</label>
                                            <select id="categoryFilterMain" class="form-select">
                                                <option value="all">Tất cả chuyên mục</option>
                                                <option value="Kinh tế">Kinh tế</option>
                                                <option value="Công nghệ">Công nghệ</option>
                                                <option value="Xã hội">Xã hội</option>
                                                <option value="Thể thao">Thể thao</option>
                                                <option value="Giáo dục">Giáo dục</option>
                                                <option value="Chứng khoán">Chứng khoán</option>
                                                <option value="Crypto">Crypto</option>
                                                <option value="Văn hóa">Văn hóa</option>
                                                <option value="Du lịch">Du lịch</option>
                                                <option value="Sức khỏe">Sức khỏe</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="hotLevelFilter" class="form-label fw-bold"><i class="fas fa-thermometer-half me-2"></i>Độ Hot:</label>
                                            <select id="hotLevelFilter" class="form-select">
                                                <option value="all">Tất cả mức độ</option>
                                                <option value="95">Siêu Hot (95%+)</option>
                                                <option value="85">Very Hot (85%+)</option>
                                                <option value="75">Hot (75%+)</option>
                                                <option value="65">Trending (65%+)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Control Buttons -->
                                <div class="text-center mb-4">
                                    <button id="loadHotTopicsMainBtn" class="btn btn-primary me-3">
                                        <i class="fas fa-sync-alt me-2"></i>Tải Chủ Đề HOT
                                    </button>
                                    <button id="refreshSourcesBtn" class="btn btn-outline-secondary">
                                        <i class="fas fa-redo me-2"></i>Làm mới nguồn
                                    </button>
                                </div>

                                <!-- Loading State -->
                                <div id="hotTopicsMainLoading" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border text-danger" role="status">
                                        <span class="visually-hidden">Đang tải...</span>
                                    </div>
                                    <h5 class="mt-3 text-danger">Đang quét chủ đề HOT...</h5>
                                    <div class="progress mt-3" style="max-width: 400px; margin: 0 auto;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" id="loadingProgress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted mt-2 d-block" id="loadingStatus">Khởi tạo...</small>
                                </div>

                                <!-- Statistics -->
                                <div id="hotTopicsStats" class="row g-3 mb-4" style="display: none;">
                                    <div class="col-6 col-md-3">
                                        <div class="card bg-light border-0 text-center shadow-sm">
                                            <div class="card-body py-3">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-list-ul fa-2x text-primary me-2"></i>
                                                    <div>
                                                        <h4 class="mb-0 text-primary" id="totalTopicsCount">0</h4>
                                                        <small class="text-muted">Tổng chủ đề</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="card bg-light border-0 text-center shadow-sm">
                                            <div class="card-body py-3">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-fire fa-2x text-danger me-2"></i>
                                                    <div>
                                                        <h4 class="mb-0 text-danger" id="superHotCount">0</h4>
                                                        <small class="text-muted">Siêu Hot (90%+)</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="card bg-light border-0 text-center shadow-sm">
                                            <div class="card-body py-3">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-database fa-2x text-info me-2"></i>
                                                    <div>
                                                        <h4 class="mb-0 text-info" id="sourcesCount">0</h4>
                                                        <small class="text-muted">Nguồn dữ liệu</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="card bg-light border-0 text-center shadow-sm">
                                            <div class="card-body py-3">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-tags fa-2x text-success me-2"></i>
                                                    <div>
                                                        <h4 class="mb-0 text-success" id="categoriesCount">0</h4>
                                                        <small class="text-muted">Chuyên mục</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hot Topics Results -->
                                <div id="hotTopicsMainResults" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4><i class="fas fa-fire me-2 text-danger"></i>Chủ đề HOT hiện tại</h4>
                                        <small class="text-muted">Cập nhật: <span id="lastUpdateTime">--</span></small>
                                    </div>
                                    <div id="hotTopicsMainGrid" class="row">
                                        <!-- Topics will be populated here -->
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div id="hotTopicsEmpty" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h4 class="text-muted">Chưa có chủ đề nào</h4>
                                    <p class="text-muted">Hãy chọn nguồn dữ liệu và nhấn "Tải Chủ Đề HOT" để bắt đầu</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Topic Detail Modal -->
                        <div class="modal fade" id="topicDetailModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="modalTopicTitle">Chi tiết chủ đề</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <p id="modalTopicDescription" class="lead"></p>
                                                <div class="mb-3">
                                                    <label class="form-label"><i class="fas fa-lightbulb me-2"></i>Gợi ý góc độ viết:</label>
                                                    <ul id="modalWritingAngles" class="list-unstyled">
                                                        <!-- Writing angles will be populated -->
                                                    </ul>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><i class="fas fa-search me-2"></i>Từ khóa liên quan:</label>
                                                    <div id="modalKeywords">
                                                        <!-- Keywords will be populated -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6><i class="fas fa-info-circle me-1"></i>Thông tin:</h6>
                                                        <p class="mb-1"><strong>Chuyên mục:</strong> <span id="modalTopicCategory"></span></p>
                                                        <p class="mb-1"><strong>Độ Hot:</strong> <span id="modalTopicScore" class="badge bg-danger"></span></p>
                                                        <p class="mb-1"><strong>Nguồn:</strong> <span id="modalTopicSource"></span></p>
                                                        <p class="mb-1"><strong>Thời gian:</strong> <span id="modalTopicTime"></span></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-primary" id="useTopicForWriting">
                                            <i class="fas fa-edit me-2"></i>Dùng viết bài
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="copyTopicInfo">
                                            <i class="fas fa-copy me-2"></i>Copy thông tin
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Initialize Hot Topics functionality
                    initializeHotTopicsFeature();
                } else if (feature === 'content-summary') {
                    content.innerHTML = `
                        <h2><i class="fas fa-compress-alt me-2 text-info"></i>Tóm Tắt Nội Dung</h2>
                        
                        <!-- API Status Test -->
                        <div class="alert alert-info mb-3">
                            <strong>🔧 API Status Test:</strong>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="testApiEndpoint()">Test API</button>
                            <span id="apiStatus" class="ms-2"></span>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <!-- Summary Mode Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-bullseye me-2"></i>Loại tóm tắt:</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="summaryMode" id="categorySummary" value="category" checked>
                                                <label class="form-check-label" for="categorySummary">
                                                    <i class="fas fa-list-ul me-1"></i> Điểm tin chuyên mục
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="summaryMode" id="articleSummary" value="article">
                                                <label class="form-check-label" for="articleSummary">
                                                    <i class="fas fa-file-alt me-1"></i> Tóm tắt bài viết
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Category Summary Input -->
                                <div id="categoryInput" class="summary-input-section">
                                    <div class="mb-3">
                                        <label for="categoryUrl" class="form-label"><i class="fas fa-link me-2"></i>URL chuyên mục báo:</label>
                                        <input type="url" class="form-control" id="categoryUrl" placeholder="https://vnexpress.net/thoi-su hoặc https://tuoitre.vn/thoi-su.htm">
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Paste đường dẫn chuyên mục (VD: Thời sự, Kinh doanh...) để tạo điểm tin từ các tiêu đề trong ngày - nhanh & hiệu quả!
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="categorySettings" class="form-label"><i class="fas fa-cog me-2"></i>Tùy chọn điểm tin:</label>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <select id="categoryLength" class="form-select form-select-sm">
                                                    <option value="short">Tóm tắt ngắn (200-300 từ)</option>
                                                    <option value="medium" selected>Tóm tắt vừa (400-600 từ)</option>
                                                    <option value="long">Tóm tắt chi tiết (800-1000 từ)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <select id="categoryFocus" class="form-select form-select-sm">
                                                    <option value="general">Tổng quan</option>
                                                    <option value="highlights">Điểm nổi bật</option>
                                                    <option value="analysis">Phân tích sâu</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="number" class="form-control form-control-sm" id="maxArticles" value="10" min="5" max="30" placeholder="Max bài">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Article Summary Input -->
                                <div id="articleInput" class="summary-input-section" style="display: none;">
                                    <div class="mb-3">
                                        <label for="articleUrl" class="form-label"><i class="fas fa-link me-2"></i>URL bài viết:</label>
                                        <input type="url" class="form-control" id="articleUrl" placeholder="https://vnexpress.net/... hoặc https://dantri.com.vn/...">
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Paste đường dẫn bài báo bất kỳ để tóm tắt nội dung
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="articleSettings" class="form-label"><i class="fas fa-cog me-2"></i>Tùy chọn tóm tắt:</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <select id="articleLength" class="form-select form-select-sm">
                                                    <option value="brief">Tóm tắt siêu ngắn (50-100 từ)</option>
                                                    <option value="short" selected>Tóm tắt ngắn (150-250 từ)</option>
                                                    <option value="medium">Tóm tắt vừa (300-400 từ)</option>
                                                    <option value="detailed">Tóm tắt chi tiết (500+ từ)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <select id="articleStyle" class="form-select form-select-sm">
                                                    <option value="bullet">Dạng bullet points</option>
                                                    <option value="paragraph" selected>Dạng đoạn văn</option>
                                                    <option value="structured">Dạng có cấu trúc</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Generate Summary Button -->
                                <div class="text-center mb-4">
                                    <button id="generateSummaryBtn" class="btn btn-info btn-lg">
                                        <i class="fas fa-magic me-2"></i>Tạo Tóm Tắt
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div class="mt-4" id="summaryResults" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-file-text me-2"></i>Kết Quả Tóm Tắt</h5>
                                        <div>
                                            <button class="btn btn-light btn-sm me-2" onclick="copyContent('summaryContent')">
                                                <i class="fas fa-copy me-1"></i>Copy
                                            </button>
                                            <button class="btn btn-warning btn-sm" id="textToSpeechBtn" onclick="sendToTTS()">
                                                <i class="fas fa-volume-up me-1"></i>Text to Speech
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Source Info -->
                                    <div id="sourceInfo" class="alert alert-light mb-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted"><strong>Nguồn:</strong> <span id="sourceUrl">-</span></small>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted"><strong>Loại:</strong> <span id="sourceType">-</span></small>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted"><strong>Thời gian:</strong> <span id="summaryTime">-</span></small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Summary Content -->
                                    <div id="summaryContent" class="content-output">
                                        <!-- Summary will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Initialize Content Summary functionality
                    initializeContentSummaryFeature();
                } else {
                    content.innerHTML = `<h2>${this.textContent}</h2><p>Đang phát triển tính năng: ${feature}. Nội dung sẽ được thêm sau.</p>`;
                }
            });
        });

        // AI Writing Feature Setup
        function setupAIWritingFeature() {
            // Input method switching
            document.querySelectorAll('input[name="inputMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Input method changed to:', this.value);
                    
                    // Hide all sections first
                    document.querySelectorAll('.input-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Clear previous state when switching away from hot topics
                    if (this.value !== 'hottopics') {
                        window.selectedHotTopicData = null;
                        console.log('Cleared hot topic data due to input method change');
                        
                        // Clear hot topics UI state
                        const selectedTopicDisplay = document.getElementById('selectedTopicDisplay');
                        if (selectedTopicDisplay) {
                            selectedTopicDisplay.style.display = 'none';
                        }
                        
                        const selectedTopicDetails = document.getElementById('selectedTopicDetails');
                        if (selectedTopicDetails) {
                            selectedTopicDetails.value = '';
                            selectedTopicDetails.readOnly = true;
                        }
                        
                        // Remove selections
                        document.querySelectorAll('.hot-topic-card').forEach(c => {
                            c.classList.remove('selected', 'border-primary');
                        });
                    }
                    
                    // Show appropriate section
                    if (this.value === 'topic') {
                        document.getElementById('topicInput').style.display = 'block';
                    } else if (this.value === 'hottopics') {
                        document.getElementById('hotTopicsInput').style.display = 'block';
                        loadHotTopics(); // Load hot topics when selected
                    } else if (this.value === 'articles') {
                        document.getElementById('articlesInput').style.display = 'block';
                    } else if (this.value === 'word') {
                        document.getElementById('wordInput').style.display = 'block';
                    }
                });
            });

            // Add article functionality
            let articleCount = 1;
            document.getElementById('addArticleBtn').addEventListener('click', function() {
                articleCount++;
                const container = document.getElementById('articlesContainer');
                const newArticle = document.createElement('div');
                newArticle.className = 'article-input mb-3';
                newArticle.innerHTML = `
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-newspaper me-1"></i>Bài ${articleCount}</span>
                        <textarea class="form-control article-content" rows="4" placeholder="Paste nội dung bài báo thứ ${articleCount}..."></textarea>
                        <button class="btn btn-outline-danger remove-article" type="button"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(newArticle);
            });

            // Remove article functionality
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-article')) {
                    if (document.querySelectorAll('.article-input').length > 1) {
                        e.target.closest('.article-input').remove();
                        // Renumber articles
                        document.querySelectorAll('.article-input').forEach((article, index) => {
                            article.querySelector('.input-group-text').innerHTML = `<i class="fas fa-newspaper me-1"></i>Bài ${index + 1}`;
                            article.querySelector('textarea').placeholder = `Paste nội dung bài báo thứ ${index + 1}...`;
                        });
                        articleCount = document.querySelectorAll('.article-input').length;
                    } else {
                        alert('Cần ít nhất 1 bài báo nguồn!');
                    }
                }
            });

            // Word file upload handling
            document.getElementById('wordFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('wordPreview').value = e.target.result;
                    };
                    reader.readAsText(file);
                }
            });

            // Generate article button
            document.getElementById('generateArticleBtn').addEventListener('click', async function() {
                const btn = this;
                const originalText = btn.innerHTML;
                
                try {
                    // Collect input data
                    const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;
                    const articleType = document.getElementById('articleType').value;
                    const outputType = document.getElementById('outputType').value;
                    const writingTone = document.getElementById('writingTone').value;
                    const targetAudience = document.getElementById('targetAudience').value;

                    let inputContent = '';
                    let inputContext = '';

                    if (inputMethod === 'topic') {
                        inputContent = document.getElementById('topicText').value.trim();
                        inputContext = document.getElementById('topicContext').value.trim();
                        if (!inputContent) {
                            alert('Vui lòng nhập chủ đề bài viết!');
                            return;
                        }
                    } else if (inputMethod === 'hottopics') {
                        // Check if we have stored hot topic data (more reliable than DOM query)
                        if (window.selectedHotTopicData) {
                            inputContent = window.selectedHotTopicData.title;
                            const topicDescription = window.selectedHotTopicData.description;
                            const additionalContext = document.getElementById('selectedTopicDetails').value.trim();
                            inputContext = `${topicDescription}${additionalContext ? '\nGóc độ bổ sung: ' + additionalContext : ''}`;
                            console.log('Using stored hot topic data:', {
                                title: inputContent,
                                description: topicDescription,
                                context: additionalContext,
                                timestamp: window.selectedHotTopicData.timestamp
                            });
                        } else {
                            // Fallback to DOM query if no stored data
                            const selectedTopic = document.querySelector('.hot-topic-card.selected');
                            if (!selectedTopic) {
                                alert('Vui lòng chọn một chủ đề Hot từ danh sách!');
                                return;
                            }
                            inputContent = selectedTopic.dataset.title;
                            const topicDescription = selectedTopic.dataset.description;
                            const additionalContext = document.getElementById('selectedTopicDetails').value.trim();
                            inputContext = `${topicDescription}${additionalContext ? '\nGóc độ bổ sung: ' + additionalContext : ''}`;
                            console.log('Using DOM fallback for hot topic:', inputContent, 'Context:', inputContext);
                        }
                    } else if (inputMethod === 'articles') {
                        const articles = Array.from(document.querySelectorAll('.article-content'))
                            .map(textarea => textarea.value.trim())
                            .filter(content => content);
                        if (articles.length === 0) {
                            alert('Vui lòng nhập ít nhất 1 bài báo nguồn!');
                            return;
                        }
                                                 inputContent = articles.join('\n\n=== PHÂN CÁCH BÀI ===\n\n');
                    } else if (inputMethod === 'word') {
                        inputContent = document.getElementById('wordPreview').value.trim();
                        if (!inputContent) {
                            alert('Vui lòng upload file Word hoặc nhập nội dung!');
                            return;
                        }
                    }

                    // Update button state
                    btn.disabled = true;
                    btn.innerHTML = '⏳ Đang tạo bài...';

                    // Call API
                    const response = await fetch('/api/ai-write', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            inputMethod,
                            inputContent,
                            inputContext,
                            articleType,
                            outputType,
                            writingTone,
                            targetAudience
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Lỗi API: ' + response.statusText);
                    }

                    const result = await response.json();
                    
                    // Display results
                    displayAIWritingResults(result, outputType);

                } catch (error) {
                    console.error('AI Writing Error:', error);
                    alert('Lỗi khi tạo bài: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });

            // Hot Topics functionality
            document.getElementById('refreshHotTopicsBtn').addEventListener('click', loadHotTopics);
            
            // Filter event listeners
            document.getElementById('categoryFilter').addEventListener('change', applyHotTopicsFilters);
            document.getElementById('scoreFilter').addEventListener('change', applyHotTopicsFilters);
            document.getElementById('sourceFilter').addEventListener('change', applyHotTopicsFilters);
        }

        // Global variable to store all topics
        window.allHotTopics = [];
        
        // Load hot topics from API
        async function loadHotTopics() {
            const loadingDiv = document.getElementById('hotTopicsLoading');
            const topicsList = document.getElementById('hotTopicsList');
            
            try {
                loadingDiv.style.display = 'block';
                topicsList.innerHTML = '';
                
                const response = await fetch('/api/hot-topics', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch hot topics');
                }
                
                const data = await response.json();
                
                // Store all topics globally
                window.allHotTopics = data.topics || [];
                window.categoryStats = data.categoryStats || {};
                
                // Update filter options with counts
                updateFilterOptions(data.categoryStats);
                
                // Reset filters
                document.getElementById('categoryFilter').value = 'all';
                document.getElementById('scoreFilter').value = 'all';
                document.getElementById('sourceFilter').value = 'all';
                
                // Display all topics initially
                displayHotTopics(window.allHotTopics);
                
            } catch (error) {
                console.error('Hot Topics Error:', error);
                topicsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>Không thể tải chủ đề Hot. <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadHotTopics()">Thử lại</button>
                        </div>
                    </div>
                `;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Apply filters to hot topics
        function applyHotTopicsFilters() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const scoreFilter = document.getElementById('scoreFilter').value;
            const sourceFilter = document.getElementById('sourceFilter').value;
            
            let filteredTopics = [...window.allHotTopics];
            
            // Filter by category
            if (categoryFilter !== 'all') {
                filteredTopics = filteredTopics.filter(topic => 
                    topic.category === categoryFilter
                );
            }
            
            // Filter by score
            if (scoreFilter !== 'all') {
                const minScore = parseInt(scoreFilter);
                filteredTopics = filteredTopics.filter(topic => 
                    topic.score >= minScore
                );
            }
            
            // Filter by source
            if (sourceFilter !== 'all') {
                filteredTopics = filteredTopics.filter(topic => {
                    if (sourceFilter === 'Current Events') return topic.source === 'Current Events';
                    if (sourceFilter === 'Tech Trends') return topic.source === 'Tech Trends';
                    if (sourceFilter === 'Vietnamese') return topic.source.includes('Vietnamese');
                    if (sourceFilter === 'Fallback') return topic.source === 'Fallback Topics';
                    return true;
                });
            }
            
            // Display filtered topics
            displayHotTopics(filteredTopics, true); // true indicates this is a filtered view
        }

        // Display hot topics in grid
        function displayHotTopics(topics, isFiltered = false) {
            const topicsList = document.getElementById('hotTopicsList');
            
            if (!topics || topics.length === 0) {
                const message = isFiltered ? 
                    '<i class="fas fa-search me-1"></i>Không tìm thấy chủ đề nào phù hợp với bộ lọc.' :
                    '<i class="fas fa-list me-1"></i>Không có chủ đề Hot nào.';
                const buttonText = isFiltered ? 'Xóa bộ lọc' : 'Tải lại';
                const buttonAction = isFiltered ? 'clearFilters()' : 'loadHotTopics()';
                
                topicsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            ${message} <button class="btn btn-sm btn-outline-primary ms-2" onclick="${buttonAction}">${buttonText}</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Update topics counter
            updateTopicsCounter(topics.length, window.allHotTopics.length, isFiltered);
            
                            const topicsHTML = topics.map((topic, index) => `
                <div class="col-md-6 mb-3">
                    <div class="card hot-topic-card h-100" 
                         data-title="${topic.title}"
                         data-description="${topic.description}"
                         data-score="${topic.score}"
                         data-source="${topic.source}"
                         onclick="selectHotTopic(this)">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge bg-danger">#${index + 1}</span>
                                <small class="text-muted">${topic.source}</small>
                            </div>
                            <h6 class="card-title">${topic.title}</h6>
                            <p class="card-text text-muted small">${topic.description}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-success"><i class="fas fa-fire me-1"></i>Trend: ${topic.score}%</small>
                                <small class="text-muted">${topic.category}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            topicsList.innerHTML = topicsHTML;
        }

        // Select hot topic
        window.selectHotTopic = function(card) {
            console.log('selectHotTopic called with:', card.dataset);
            
            // Remove previous selection
            document.querySelectorAll('.hot-topic-card').forEach(c => {
                c.classList.remove('selected', 'border-primary');
            });
            
            // Select current card
            card.classList.add('selected', 'border-primary');
            
            // Update details
            const title = card.dataset.title;
            const description = card.dataset.description;
            const score = card.dataset.score;
            const source = card.dataset.source;
            
            console.log('Setting topic details:', { title, description, score, source });
            
            document.getElementById('selectedTopicTitle').textContent = title;
            document.getElementById('selectedTopicDescription').textContent = description;
            document.getElementById('selectedTopicScore').textContent = score + '%';
            document.getElementById('selectedTopicSource').textContent = source;
            document.getElementById('selectedTopicDisplay').style.display = 'block';
            
            // IMPORTANT: Clear previous context and set new placeholder
            const contextInput = document.getElementById('selectedTopicDetails');
            contextInput.value = ''; // Clear previous context
            contextInput.readOnly = false;
            contextInput.placeholder = 'Thêm góc độ, bối cảnh riêng cho chủ đề "' + title + '"...';
            
            // Store selected topic data globally for AI generation
            window.selectedHotTopicData = {
                title: title,
                description: description,
                score: score,
                source: source,
                timestamp: Date.now()
            };
            
            console.log('Hot topic selected and stored:', window.selectedHotTopicData);
        }

        // Update topics counter
        function updateTopicsCounter(filteredCount, totalCount, isFiltered) {
            const counterElement = document.getElementById('topicsCounter');
            if (!counterElement) {
                // Create counter element if it doesn't exist
                const labelsRow = document.querySelector('#hotTopicsInput .d-flex.justify-content-between');
                if (labelsRow) {
                    const counter = document.createElement('small');
                    counter.id = 'topicsCounter';
                    counter.className = 'text-muted';
                    labelsRow.appendChild(counter);
                }
            }
            
            const counter = document.getElementById('topicsCounter');
            if (counter) {
                if (isFiltered) {
                    counter.innerHTML = `<i class="fas fa-filter me-1"></i>Hiển thị <strong>${filteredCount}</strong>/<strong>${totalCount}</strong> chủ đề`;
                    counter.className = 'text-info fw-bold';
                } else {
                    counter.innerHTML = `<i class="fas fa-list-ul me-1"></i>Tổng cộng <strong>${totalCount}</strong> chủ đề Hot`;
                    counter.className = 'text-muted';
                }
            }
        }

                 // Clear all filters
        window.clearFilters = function() {
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('scoreFilter').value = 'all'; 
            document.getElementById('sourceFilter').value = 'all';
            
            // Display all topics
            displayHotTopics(window.allHotTopics);
        }

        // Update filter options with counts
        function updateFilterOptions(stats) {
            if (!stats) return;
            
            // Update category filter options
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = stats.categories || {};
            
            // Reset to default options with counts
            categoryFilter.innerHTML = `
                <option value="all">Tất cả chuyên mục (${stats.total || 0})</option>
                <option value="Kinh tế">Kinh tế (${categories['Kinh tế'] || 0})</option>
                <option value="Công nghệ">Công nghệ (${categories['Công nghệ'] || 0})</option>
                <option value="Xã hội">Xã hội (${categories['Xã hội'] || 0})</option>
                <option value="Văn hóa">Văn hóa (${categories['Văn hóa'] || 0})</option>
            `;
            
            // Update score filter options
            const scoreFilter = document.getElementById('scoreFilter');
            const scoreRanges = stats.scoreRanges || {};
            scoreFilter.innerHTML = `
                <option value="all">Tất cả mức độ (${stats.total || 0})</option>
                <option value="90">Siêu Hot 90%+ (${scoreRanges.super_hot || 0})</option>
                <option value="80">Hot 80%+ (${(scoreRanges.super_hot || 0) + (scoreRanges.hot || 0)})</option>
                <option value="70">Trending 70%+ (${stats.total || 0})</option>
            `;
            
            // Update source filter options  
            const sourceFilter = document.getElementById('sourceFilter');
            const sources = stats.sources || {};
            const currentEvents = sources['Current Events'] || 0;
            const techTrends = sources['Tech Trends'] || 0;
            const vietnamese = Object.keys(sources).filter(s => s.includes('Vietnamese')).reduce((sum, key) => sum + (sources[key] || 0), 0);
            const fallback = sources['Fallback Topics'] || 0;
            
            sourceFilter.innerHTML = `
                <option value="all">Tất cả nguồn (${stats.total || 0})</option>
                <option value="Current Events">Current Events (${currentEvents})</option>
                <option value="Tech Trends">Tech Trends (${techTrends})</option>
                <option value="Vietnamese">Vietnamese Topics (${vietnamese})</option>
                <option value="Fallback">General Topics (${fallback})</option>
            `;
        }

        function displayAIWritingResults(result, outputType) {
            const resultsSection = document.getElementById('aiWriteResults');
            const outlineSection = document.getElementById('outlineSection');
            const articleSection = document.getElementById('articleSection');

            resultsSection.style.display = 'block';

            if (outputType === 'outline' || outputType === 'both') {
                document.getElementById('outlineContent').innerHTML = formatContent(result.outline || result.content);
                outlineSection.style.display = 'block';
            } else {
                outlineSection.style.display = 'none';
            }

            if (outputType === 'complete' || outputType === 'both') {
                document.getElementById('articleContent').innerHTML = formatContent(result.article || result.content);
                articleSection.style.display = 'block';
            } else {
                articleSection.style.display = 'none';
            }

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

                 function formatContent(content) {
             if (!content) return '<em>Không có nội dung</em>';
             
             return content
                 .split('\n')
                 .map(line => {
                     line = line.trim();
                     if (!line) return '';
                     
                     // Format headers
                     if (line.startsWith('#')) {
                         const level = line.match(/^#+/)[0].length;
                         const text = line.replace(/^#+\s*/, '');
                         return `<h${level + 2} class="text-primary mt-3 mb-2">${text}</h${level + 2}>`;
                     }
                     
                     // Format bold text
                     line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                     
                     // Format italic text  
                     line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
                     
                     // Regular paragraph
                     return `<p class="mb-2">${line}</p>`;
                 })
                 .filter(line => line) // Remove empty lines
                 .join('');
         }

        // Copy content function
        window.copyContent = function(elementId) {
            const element = document.getElementById(elementId);
            const text = element.innerText || element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '✅ Đã copy!';
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-light');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Không thể copy. Vui lòng copy thủ công.');
            });
        };

        // Refine article function
        window.refineArticle = function() {
            // TODO: Implement article refinement functionality
            alert('Tính năng tinh chỉnh đang được phát triển!');
        };

        // Initialize Hot Topics Feature
        function initializeHotTopicsFeature() {
            // Global variables for hot topics
            window.currentHotTopics = [];
            window.filteredHotTopics = [];

            // Source checkboxes management
            document.getElementById('sourceAll').addEventListener('change', function() {
                const isChecked = this.checked;
                ['sourceGoogle', 'sourceBaoMoi', 'sourceSocial'].forEach(id => {
                    document.getElementById(id).checked = isChecked;
                });
            });

            // Individual source checkboxes
            ['sourceGoogle', 'sourceBaoMoi', 'sourceSocial'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    const allChecked = ['sourceGoogle', 'sourceBaoMoi', 'sourceSocial']
                        .every(sourceId => document.getElementById(sourceId).checked);
                    document.getElementById('sourceAll').checked = allChecked;
                });
            });

            // Load hot topics button
            document.getElementById('loadHotTopicsMainBtn').addEventListener('click', loadMainHotTopics);
            document.getElementById('refreshSourcesBtn').addEventListener('click', refreshHotTopicsSources);

            // Filter change events
            document.getElementById('categoryFilterMain').addEventListener('change', applyMainHotTopicsFilters);
            document.getElementById('hotLevelFilter').addEventListener('change', applyMainHotTopicsFilters);

            // Modal events
            document.getElementById('useTopicForWriting').addEventListener('click', useTopicForAIWriting);
            document.getElementById('copyTopicInfo').addEventListener('click', copyTopicInformation);
        }

        // Load hot topics with enhanced sources
        async function loadMainHotTopics() {
            const loadingDiv = document.getElementById('hotTopicsMainLoading');
            const statsDiv = document.getElementById('hotTopicsStats');
            const resultsDiv = document.getElementById('hotTopicsMainResults');
            const emptyDiv = document.getElementById('hotTopicsEmpty');
            const loadBtn = document.getElementById('loadHotTopicsMainBtn');

            try {
                // Show loading
                loadingDiv.style.display = 'block';
                statsDiv.style.display = 'none';
                resultsDiv.style.display = 'none';
                emptyDiv.style.display = 'none';
                loadBtn.disabled = true;

                // Simulate loading progress
                const progressBar = document.getElementById('loadingProgress');
                const statusText = document.getElementById('loadingStatus');
                const sources = ['Google Trends', 'BaoMoi.com', 'Mạng xã hội'];
                
                for (let i = 0; i < sources.length; i++) {
                    progressBar.style.width = `${(i + 1) * 33.33}%`;
                    statusText.textContent = `Đang quét ${sources[i]}...`;
                    await new Promise(resolve => setTimeout(resolve, 600));
                }

                // Get selected sources
                const selectedSources = [];
                if (document.getElementById('sourceGoogle').checked) selectedSources.push('google');
                if (document.getElementById('sourceBaoMoi').checked) selectedSources.push('baomoi');
                if (document.getElementById('sourceSocial').checked) selectedSources.push('social');

                // Call enhanced API
                const response = await fetch(`/api/hot-topics?sources=${selectedSources.join(',')}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                
                // Store data globally
                window.currentHotTopics = data.topics || [];
                window.filteredHotTopics = [...window.currentHotTopics];

                // Update statistics
                updateHotTopicsStatistics(data);

                // Display topics
                displayMainHotTopics(window.filteredHotTopics);

                // Show results
                loadingDiv.style.display = 'none';
                if (window.currentHotTopics.length > 0) {
                    statsDiv.style.display = 'block';
                    resultsDiv.style.display = 'block';
                    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('vi-VN');
                } else {
                    emptyDiv.style.display = 'block';
                }

            } catch (error) {
                console.error('Hot Topics Error:', error);
                loadingDiv.style.display = 'none';
                emptyDiv.style.display = 'block';
                alert('Không thể tải chủ đề Hot: ' + error.message);
            } finally {
                loadBtn.disabled = false;
            }
        }

        // Display hot topics in enhanced grid
        function displayMainHotTopics(topics) {
            const grid = document.getElementById('hotTopicsMainGrid');
            
            if (!topics || topics.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-search me-2"></i>Không tìm thấy chủ đề phù hợp với bộ lọc hiện tại
                        </div>
                    </div>
                `;
                return;
            }

            // IMPORTANT: Update global filteredHotTopics to match displayed topics
            window.filteredHotTopics = [...topics];

            const topicsHTML = topics.map((topic, index) => {
                // Escape quotes and special characters for onclick handlers
                const escapedTitle = topic.title.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const escapedDescription = topic.description.replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                return `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 hot-topic-card-main shadow-sm" data-bs-toggle="modal" data-bs-target="#topicDetailModal" onclick="showTopicDetail(${index})">
                        <div class="card-header bg-gradient text-white ${getScoreColor(topic.score)}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-dark">#${topic.rank || index + 1}</span>
                                <small><i class="fas fa-fire me-1"></i>${topic.score}%</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${topic.title}</h6>
                            <p class="card-text small text-muted">${topic.description.substring(0, 100)}...</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">${topic.category}</span>
                                <small class="text-muted">${topic.source}</small>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary flex-fill me-2" onclick="event.stopPropagation(); quickUseForWriting('${escapedTitle}', '${escapedDescription}')">
                                    <i class="fas fa-edit me-1"></i>Viết bài
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); quickCopyTopic('${escapedTitle}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            grid.innerHTML = topicsHTML;
        }

        // Apply filters to main hot topics
        function applyMainHotTopicsFilters() {
            if (!window.currentHotTopics || window.currentHotTopics.length === 0) {
                return;
            }

            const categoryFilter = document.getElementById('categoryFilterMain').value;
            const hotLevelFilter = document.getElementById('hotLevelFilter').value;

            let filtered = [...window.currentHotTopics];

            // Filter by category
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(topic => topic.category === categoryFilter);
            }

            // Filter by hot level (score)
            if (hotLevelFilter !== 'all') {
                const minScore = parseInt(hotLevelFilter);
                filtered = filtered.filter(topic => topic.score >= minScore);
            }

            window.filteredHotTopics = filtered;
            displayMainHotTopics(filtered);
        }

        // Update hot topics statistics
        function updateHotTopicsStatistics(data) {
            const stats = data.categoryStats || {};
            const topics = data.topics || [];

            document.getElementById('totalTopicsCount').textContent = topics.length;
            document.getElementById('superHotCount').textContent = topics.filter(t => t.score >= 90).length;
            document.getElementById('sourcesCount').textContent = Object.keys(stats.sources || {}).length;
            document.getElementById('categoriesCount').textContent = Object.keys(stats.categories || {}).length;
        }

        // Get color class based on score
        function getScoreColor(score) {
            if (score >= 95) return 'bg-danger';
            if (score >= 85) return 'bg-warning';
            if (score >= 75) return 'bg-info';
            return 'bg-secondary';
        }

        // Show topic detail in modal
        window.showTopicDetail = function(index) {
            console.log('showTopicDetail called with index:', index);
            console.log('filteredHotTopics length:', window.filteredHotTopics?.length);
            
            const topic = window.filteredHotTopics[index];
            console.log('Selected topic:', topic);
            
            if (!topic) {
                console.error('Topic not found at index:', index);
                return;
            }

            document.getElementById('modalTopicTitle').textContent = topic.title;
            document.getElementById('modalTopicDescription').textContent = topic.description;
            document.getElementById('modalTopicCategory').textContent = topic.category;
            document.getElementById('modalTopicScore').textContent = topic.score + '%';
            document.getElementById('modalTopicSource').textContent = topic.source;
            document.getElementById('modalTopicTime').textContent = new Date().toLocaleString('vi-VN');

            // Generate writing angles
            const angles = generateWritingAngles(topic);
            console.log('Generated angles:', angles);
            const anglesList = document.getElementById('modalWritingAngles');
            anglesList.innerHTML = angles.map(angle => `<li class="mb-1"><i class="fas fa-chevron-right me-2 text-primary"></i>${angle}</li>`).join('');

            // Generate keywords
            const keywords = generateKeywords(topic);
            console.log('Generated keywords:', keywords);
            const keywordsDiv = document.getElementById('modalKeywords');
            keywordsDiv.innerHTML = keywords.map(kw => `<span class="badge bg-light text-dark me-1 mb-1">${kw}</span>`).join('');

            // Store current topic for actions
            window.currentModalTopic = topic;
        };

        // Generate writing angles based on topic
        function generateWritingAngles(topic) {
            const baseAngles = {
                'Kinh tế': [
                    'Phân tích tác động đến thị trường và doanh nghiệp',
                    'Góc nhìn từ người tiêu dùng và nhà đầu tư',
                    'So sánh với tình hình quốc tế và khu vực'
                ],
                'Công nghệ': [
                    'Ứng dụng thực tế trong đời sống và kinh doanh',
                    'Xu hướng phát triển và dự báo tương lai',
                    'Thách thức và cơ hội cho Việt Nam'
                ],
                'Xã hội': [
                    'Tác động đến các tầng lớp xã hội khác nhau',
                    'Giải pháp và chính sách từ nhà nước',
                    'Kinh nghiệm từ các nước khác'
                ],
                'Thể thao': [
                    'Phân tích kỹ thuật và chiến thuật',
                    'Tác động đến tinh thần người hâm mộ',
                    'Ý nghĩa với phong trào thể thao Việt Nam'
                ],
                'Chứng khoán': [
                    'Phân tích kỹ thuật và cơ bản',
                    'Tác động đến nhà đầu tư cá nhân',
                    'Xu hướng thị trường và dự báo'
                ],
                'Crypto': [
                    'Phân tích biến động và nguyên nhân',
                    'Tác động đến hệ sinh thái blockchain',
                    'Quy định pháp lý và triển vọng'
                ]
            };

            return baseAngles[topic.category] || [
                'Phân tích hiện tượng và nguyên nhân',
                'Tác động đến cộng đồng và xã hội',
                'Giải pháp và hướng phát triển'
            ];
        }

        // Generate keywords based on topic
        function generateKeywords(topic) {
            if (!topic || !topic.title || !topic.description) {
                console.error('Invalid topic data for keyword generation:', topic);
                return ['Chủ đề', 'Hot', 'Trending'];
            }
            
            const words = topic.title.split(' ').concat(topic.description.split(' '));
            const stopwords = ['là', 'và', 'của', 'trong', 'với', 'được', 'có', 'để', 'từ', 'cho', 'về', 'theo', 'các', 'những', 'này', 'đó', 'một', 'sẽ', 'đã', 'không', 'tại', 'trên', 'sau', 'trước', 'như', 'thì', 'rồi', 'mà', 'nên', 'bởi', 'vì', 'nếu', 'khi', 'lúc'];
            
            const filteredWords = words
                .map(word => word.replace(/[.,!?;:"()]/g, '').trim()) // Remove punctuation
                .filter(word => 
                    word.length > 2 && 
                    !stopwords.includes(word.toLowerCase()) &&
                    !/^\d+$/.test(word) // Exclude pure numbers
                )
                .slice(0, 10) // Get more words first
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase());
            
            // Remove duplicates and return top 8
            const uniqueWords = [...new Set(filteredWords)];
            return uniqueWords.slice(0, 8);
        }

        // Quick use topic for writing
        window.quickUseForWriting = function(title, description) {
            console.log('quickUseForWriting called with:', { title, description });
            
            // Switch to AI writing feature
            const aiWriteBtn = document.querySelector('[data-feature="ai-write"]');
            if (!aiWriteBtn) {
                console.error('AI write button not found');
                alert('Không tìm thấy tính năng AI viết bài. Vui lòng thử lại.');
                return;
            }
            
            aiWriteBtn.click();
            
            // Wait for UI to load then fill data
            setTimeout(() => {
                const hotTopicsRadio = document.getElementById('fromHotTopics');
                if (hotTopicsRadio) {
                    console.log('Setting hot topics radio to checked');
                    hotTopicsRadio.checked = true;
                    hotTopicsRadio.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        const selectedTopicDetails = document.getElementById('selectedTopicDetails');
                        if (selectedTopicDetails) {
                            console.log('quickUseForWriting: Setting topic details:', title, description);
                            
                            // CLEAR PREVIOUS DATA FIRST
                            selectedTopicDetails.value = '';
                            
                            // Set new topic data with clear format
                            selectedTopicDetails.value = `${title}\n\n${description}`;
                            selectedTopicDetails.readOnly = false;
                            
                            // Update the display
                            const selectedTopicDisplay = document.getElementById('selectedTopicDisplay');
                            const selectedTopicTitle = document.getElementById('selectedTopicTitle');
                            const selectedTopicDescription = document.getElementById('selectedTopicDescription');
                            
                            if (selectedTopicDisplay && selectedTopicTitle && selectedTopicDescription) {
                                selectedTopicTitle.textContent = title;
                                selectedTopicDescription.textContent = description;
                                selectedTopicDisplay.style.display = 'block';
                            }
                            
                            // Store topic data globally (consistent with selectHotTopic)
                            window.selectedHotTopicData = {
                                title: title,
                                description: description,
                                score: 95, // Default high score for standalone topics
                                source: 'Standalone Hot Topics',
                                timestamp: Date.now()
                            };
                            
                            console.log('quickUseForWriting: Stored topic data:', window.selectedHotTopicData);
                            
                            // Clear any existing hot topic card selections in AI Writing
                            document.querySelectorAll('.hot-topic-card').forEach(c => {
                                c.classList.remove('selected', 'border-primary');
                            });
                            
                            // Show success message
                            alert('✅ Đã chuyển chủ đề sang AI viết bài!');
                        } else {
                            console.error('selectedTopicDetails not found');
                            alert('Không thể tự động điền thông tin. Vui lòng copy thủ công.');
                        }
                    }, 800);
                } else {
                    console.error('fromHotTopics radio not found');
                    alert('Không thể chuyển đổi sang chế độ Hot Topics. Vui lòng chọn thủ công.');
                }
            }, 500);
        };

        // Quick copy topic
        window.quickCopyTopic = function(title) {
            navigator.clipboard.writeText(title).then(() => {
                // Show temporary success message
                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 1500);
            });
        };

        // Use topic for AI writing (from modal)
        window.useTopicForAIWriting = function() {
            if (!window.currentModalTopic) return;
            
            const topic = window.currentModalTopic;
            bootstrap.Modal.getInstance(document.getElementById('topicDetailModal')).hide();
            
            quickUseForWriting(topic.title, topic.description);
        };

        // Copy topic information (from modal)
        window.copyTopicInformation = function() {
            if (!window.currentModalTopic) return;
            
            const topic = window.currentModalTopic;
            const info = `Chủ đề: ${topic.title}\n\nMô tả: ${topic.description}\n\nChuyên mục: ${topic.category}\nĐộ Hot: ${topic.score}%\nNguồn: ${topic.source}`;
            
            navigator.clipboard.writeText(info).then(() => {
                const btn = document.getElementById('copyTopicInfo');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Đã copy!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            });
        };

        // Refresh hot topics sources
        async function refreshHotTopicsSources() {
            const btn = document.getElementById('refreshSourcesBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang refresh...';
            btn.disabled = true;
            
            // Simulate refresh delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Reload topics
            await loadMainHotTopics();
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        // Initialize Content Summary Feature
        function initializeContentSummaryFeature() {
            console.log('Initializing Content Summary feature...');
            
            // Mode switching
            document.querySelectorAll('input[name="summaryMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Summary mode changed to:', this.value);
                    
                    // Hide all input sections
                    document.querySelectorAll('.summary-input-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show appropriate section
                    if (this.value === 'category') {
                        document.getElementById('categoryInput').style.display = 'block';
                    } else if (this.value === 'article') {
                        document.getElementById('articleInput').style.display = 'block';
                    }
                });
            });

            // Generate Summary button
            document.getElementById('generateSummaryBtn').addEventListener('click', async function() {
                const btn = this;
                const originalText = btn.innerHTML;
                
                try {
                    // Get selected mode
                    const summaryMode = document.querySelector('input[name="summaryMode"]:checked').value;
                    console.log('Generating summary for mode:', summaryMode);
                    
                    let url, settings = {};
                    
                    if (summaryMode === 'category') {
                        url = document.getElementById('categoryUrl').value.trim();
                        if (!url) {
                            alert('Vui lòng nhập URL chuyên mục!');
                            return;
                        }
                        
                        settings = {
                            length: document.getElementById('categoryLength').value,
                            focus: document.getElementById('categoryFocus').value,
                            maxArticles: parseInt(document.getElementById('maxArticles').value)
                        };
                    } else if (summaryMode === 'article') {
                        url = document.getElementById('articleUrl').value.trim();
                        if (!url) {
                            alert('Vui lòng nhập URL bài viết!');
                            return;
                        }
                        
                        settings = {
                            length: document.getElementById('articleLength').value,
                            style: document.getElementById('articleStyle').value
                        };
                    }
                    
                    // Update button state
                    btn.disabled = true;
                    btn.innerHTML = '⏳ Đang tóm tắt...';
                    
                    // Call API
                    const response = await fetch('/api/content-summary', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            mode: summaryMode,
                            url: url,
                            settings: settings
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'API Error: ' + response.status);
                    }

                    const result = await response.json();
                    console.log('Summary result:', result);
                    
                    // Display results
                    displaySummaryResults(result, summaryMode, url);

                } catch (error) {
                    console.error('Content Summary Error:', error);
                    
                    let errorMessage = error.message;
                    
                    // Enhanced error messages
                    if (error.message.includes('Không tìm thấy bài báo nào')) {
                        errorMessage = `❌ Không thể tóm tắt chuyên mục này!\n\n` +
                                     `🔍 Có thể do:\n` +
                                     `• Trang web chặn bot/crawler\n` +
                                     `• Cấu trúc HTML của trang thay đổi\n` +
                                     `• URL chuyên mục không hợp lệ\n\n` +
                                     `💡 Giải pháp:\n` +
                                     `• Thử với URL bài viết đơn lẻ thay vì chuyên mục\n` +
                                     `• Copy link bài báo cụ thể và chọn "Tóm tắt bài viết"\n` +
                                     `• Thử với trang chủ thay vì chuyên mục con`;
                    } else if (error.message.includes('Failed to summarize')) {
                        errorMessage = `❌ Lỗi khi tóm tắt nội dung!\n\n` +
                                     `🔍 Nguyên nhân có thể:\n` +
                                     `• Kết nối mạng không ổn định\n` +
                                     `• Trang web không cho phép truy cập\n` +
                                     `• Nội dung quá phức tạp để xử lý\n\n` +
                                     `💡 Hãy thử lại sau vài phút hoặc sử dụng URL khác`;
                    }
                    
                    alert(errorMessage);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        }

        // Display Summary Results
        function displaySummaryResults(result, mode, url) {
            const resultsSection = document.getElementById('summaryResults');
            const sourceInfo = document.getElementById('sourceInfo');
            const summaryContent = document.getElementById('summaryContent');
            
            // Update source info
            document.getElementById('sourceUrl').textContent = url;
            document.getElementById('sourceType').textContent = mode === 'category' ? 'Điểm tin chuyên mục' : 'Bài viết đơn lẻ';
            document.getElementById('summaryTime').textContent = new Date().toLocaleString('vi-VN');
            
            // Format and display summary content
            let formattedContent = '';
            if (result.summary) {
                formattedContent = formatContent(result.summary);
            } else if (result.content) {
                formattedContent = formatContent(result.content);
            } else {
                formattedContent = '<p class="text-muted">Không có nội dung tóm tắt.</p>';
            }
            
            summaryContent.innerHTML = formattedContent;
            
            // Store content globally for TTS
            window.currentSummaryContent = result.summary || result.content || '';
            window.currentSummaryUrl = url;
            
            // Show results
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            console.log('Summary displayed successfully');
        }

        // Send to Text to Speech
        window.sendToTTS = function() {
            if (!window.currentSummaryContent) {
                alert('Không có nội dung tóm tắt để chuyển sang TTS!');
                return;
            }
            
            console.log('Sending content to TTS:', window.currentSummaryContent);
            
            // Switch to TTS feature
            const ttsBtn = document.querySelector('[data-feature="tts"]');
            if (ttsBtn) {
                ttsBtn.click();
                
                // Wait for TTS UI to load then populate content
                setTimeout(() => {
                    const ttsTextarea = document.getElementById('ttsText');
                    if (ttsTextarea) {
                        ttsTextarea.value = window.currentSummaryContent;
                        alert('✅ Đã chuyển nội dung tóm tắt sang Text to Speech!');
                    } else {
                        // TTS feature not yet implemented
                        alert('🔊 Tính năng Text to Speech sẽ được phát triển sau.\n\nNội dung đã được copy để chuẩn bị:\n\n' + 
                              window.currentSummaryContent.substring(0, 200) + '...');
                    }
                }, 500);
            } else {
                alert('Không tìm thấy tính năng Text to Speech!');
            }
        };

        // Test API Endpoint Status
        window.testApiEndpoint = async function() {
            const statusSpan = document.getElementById('apiStatus');
            statusSpan.innerHTML = '⏳ Testing...';
            
            try {
                console.log('🔍 Testing API endpoints...');
                
                // Test 1: Health check
                const healthResponse = await fetch('/api/content-summary?test=health');
                console.log('Health check response:', healthResponse.status, healthResponse.statusText);
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    console.log('Health check data:', healthData);
                    statusSpan.innerHTML = '✅ API is WORKING! Ready to use.';
                    statusSpan.className = 'text-success fw-bold';
                } else {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }
                
                // Test 2: Test summary endpoint
                const testResponse = await fetch('/api/test-summary');
                console.log('Test endpoint response:', testResponse.status);
                
                if (testResponse.ok) {
                    const testData = await testResponse.json();
                    console.log('Test endpoint data:', testData);
                }
                
            } catch (error) {
                console.error('API Test Error:', error);
                statusSpan.innerHTML = `❌ API not available: ${error.message}`;
                statusSpan.className = 'text-danger fw-bold';
                
                // Show deployment status
                alert(`🚨 API Deployment Issue!\n\n` +
                     `Error: ${error.message}\n\n` +
                     `Possible causes:\n` +
                     `• Vercel still deploying changes\n` +
                     `• API function not deployed correctly\n` +
                     `• Caching issues\n\n` +
                     `💡 Solution: Wait 1-2 minutes and try again`);
            }
        };
    </script>
</body>
</html> 