
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CMS Demo</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 250px; 
            min-width: 250px; 
            background-color: #f8f9fa; 
            padding: 20px;
            flex-shrink: 0;
            border-right: 1px solid #dee2e6;
        }
        .main-content { 
            flex-grow: 1; 
            padding: 20px;
            min-width: 0;
        }
        .list-group-item { 
            cursor: pointer; 
            border: none;
            border-radius: 8px !important;
            margin-bottom: 2px;
            transition: all 0.2s ease;
            color: #495057;
            font-weight: 400;
        }
        .list-group-item:hover {
            background-color: #e9ecef;
            color: #495057;
            transform: translateX(2px);
        }
        .list-group-item.active, .list-group-item:active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        .list-group-item i {
            width: 20px;
            text-align: center;
            opacity: 0.7;
        }
        .list-group-item:hover i, .list-group-item.active i {
            opacity: 1;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
        }
        .translation-output {
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .content-output {
            line-height: 1.6;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .content-output h3, .content-output h4, .content-output h5 {
            color: #0d6efd;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .content-output p {
            margin-bottom: 0.75rem;
            text-align: justify;
        }
        .content-output strong {
            color: #212529;
            font-weight: 600;
        }
        .hot-topic-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        .hot-topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: #0d6efd;
        }
        .hot-topic-card.selected {
            border: 2px solid #0d6efd !important;
            background-color: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(13, 110, 253, 0.15);
        }
        .hot-topic-card .badge {
            font-size: 10px;
        }
        .hot-topic-card .card-title {
            font-size: 14px;
            line-height: 1.3;
            margin-bottom: 8px;
        }
        .hot-topic-card .card-text {
            font-size: 11px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4 class="mb-3 text-center text-primary fw-bold"><i class="fas fa-cogs me-2"></i>Menu T√≠nh NƒÉng</h4>
        <div class="list-group">
            <a class="list-group-item list-group-item-action" data-feature="ai-write"><i class="fas fa-edit me-2"></i>AI vi·∫øt b√†i t·ª± ƒë·ªông</a>
            <a class="list-group-item list-group-item-action" data-feature="spell-check"><i class="fas fa-spell-check me-2 text-success"></i>Ki·ªÉm tra l·ªói ch√≠nh t·∫£</a>
            <a class="list-group-item list-group-item-action" data-feature="hot-topics"><i class="fas fa-fire me-2"></i>G·ª£i √Ω ch·ªß ƒë·ªÅ HOT</a>
            <a class="list-group-item list-group-item-action" data-feature="tts"><i class="fas fa-volume-up me-2"></i>Text to Speech</a>
            <a class="list-group-item list-group-item-action" data-feature="stt"><i class="fas fa-microphone me-2"></i>Speech to Text</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-en-vi"><i class="fas fa-language me-2 text-success"></i>D·ªãch Anh sang Vi·ªát</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-vi-en"><i class="fas fa-exchange-alt me-2 text-success"></i>D·ªãch Vi·ªát sang Anh</a>
            <a class="list-group-item list-group-item-action" data-feature="translate-url"><i class="fas fa-link me-2 text-success"></i>D·ªãch t·ª´ URL b√°o</a>
            <a class="list-group-item list-group-item-action" data-feature="publish"><i class="fas fa-rocket me-2"></i>Xu·∫•t b·∫£n ƒëa n·ªÅn t·∫£ng</a>
            <a class="list-group-item list-group-item-action" data-feature="score-article"><i class="fas fa-chart-bar me-2"></i>Ch·∫•m ƒëi·ªÉm b√†i b√°o</a>
            <a class="list-group-item list-group-item-action" data-feature="image-manage"><i class="fas fa-images me-2"></i>Qu·∫£n l√Ω ·∫£nh b·∫±ng AI</a>
        </div>
    </div>
    <div class="main-content" id="feature-content">
        <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi AI CMS Demo</h2>
        <p>Ch·ªçn m·ªôt t√≠nh nƒÉng t·ª´ menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // For local testing only: Paste your OpenAI key here. Remove or leave empty for production (uses serverless).
        const LOCAL_OPENAI_KEY = ''; // Paste 'sk-proj-...' here for local test. Do not commit!

        document.querySelectorAll('.list-group-item').forEach(item => {
            item.addEventListener('click', async function() {
                const feature = this.getAttribute('data-feature');
                const content = document.getElementById('feature-content');
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

                if (feature === 'translate-en-vi' || feature === 'translate-vi-en') {
                    const fromLang = feature === 'translate-en-vi' ? 'Anh' : 'Vi·ªát';
                    const toLang = feature === 'translate-en-vi' ? 'Vi·ªát' : 'Anh';
                    const direction = feature === 'translate-en-vi' ? 'en-vi' : 'vi-en';
                    const inputLabel = `Nh·∫≠p vƒÉn b·∫£n ti·∫øng ${fromLang}:`;
                    const outputLabel = `K·∫øt qu·∫£ d·ªãch (ti·∫øng ${toLang}):`;

                    content.innerHTML = `
                        <h2>D·ªãch ${fromLang} sang ${toLang}</h2>
                        <div class="mb-3">
                            <label for="inputText" class="form-label">${inputLabel}</label>
                            <textarea class="form-control" id="inputText" rows="5"></textarea>
                        </div>
                        <button id="translateBtn" class="btn btn-primary">D·ªãch</button>
                        <div class="mt-3" style="min-width: 0;">
                            <label class="form-label">${outputLabel}</label>
                            <div class="translation-output border p-3 bg-light" style="min-height: 100px; position: relative;">
                                <button id="copyBtn" class="btn btn-sm btn-outline-secondary copy-btn" style="display: none;" onclick="copyToClipboard()">
                                    üìã Copy
                                </button>
                                <div id="outputText"></div>
                            </div>
                        </div>
                    `;

                    // Add copy function to global scope
                    window.copyToClipboard = function() {
                        const outputText = document.getElementById('outputText').innerText;
                        if (outputText && outputText !== 'ƒêang d·ªãch...') {
                            navigator.clipboard.writeText(outputText).then(() => {
                                const copyBtn = document.getElementById('copyBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '‚úÖ ƒê√£ copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-secondary');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-secondary');
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy: ', err);
                                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
                            });
                        }
                    };

                    document.getElementById('translateBtn').addEventListener('click', async () => {
                        const input = document.getElementById('inputText').value;
                        if (!input) return alert('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!');
                        
                        // Show loading state
                        const outputElement = document.getElementById('outputText');
                        const copyBtn = document.getElementById('copyBtn');
                        outputElement.innerText = 'ƒêang d·ªãch...';
                        copyBtn.style.display = 'none';

                        try {
                            let response;
                            if (isLocal && LOCAL_OPENAI_KEY) {
                                // Local direct call for testing
                                response = await fetch('https://api.openai.com/v1/chat/completions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${LOCAL_OPENAI_KEY}`
                                    },
                                    body: JSON.stringify({
                                        model: 'gpt-3.5-turbo',
                                        messages: [{ role: 'user', content: `D·ªãch vƒÉn b·∫£n sau t·ª´ ti·∫øng ${fromLang} sang ti·∫øng ${toLang}: ${input}` }]
                                    })
                                });
                            } else {
                                // Production: Call serverless endpoint
                                response = await fetch('/api/translate', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ text: input, direction })
                                });
                            }

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const data = await response.json();
                            const translatedText = isLocal ? data.choices[0].message.content : data.translatedText;
                            outputElement.innerText = translatedText;
                            
                            // Show copy button after successful translation
                            if (translatedText && translatedText !== 'ƒêang d·ªãch...') {
                                copyBtn.style.display = 'block';
                            }
                        } catch (error) {
                            console.error(error);
                            outputElement.innerText = 'L·ªói khi d·ªãch. Vui l√≤ng th·ª≠ l·∫°i.';
                            copyBtn.style.display = 'none';
                            alert('L·ªói khi g·ªçi API: ' + error.message + ' (N·∫øu local, ki·ªÉm tra key v√† m·∫°ng)');
                        }
                    });
                } else if (feature === 'spell-check') {
                    content.innerHTML = `
                        <h2>Ki·ªÉm tra l·ªói ch√≠nh t·∫£</h2>
                        <div class="mb-3">
                            <label for="inputText" class="form-label">Nh·∫≠p vƒÉn b·∫£n c·∫ßn ki·ªÉm tra:</label>
                            <textarea class="form-control" id="inputText" rows="5"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <select id="languageSelect" class="form-select mb-3">
                                    <option value="vi">Ti·∫øng Vi·ªát</option>
                                    <option value="en">Ti·∫øng Anh</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select id="modeSelect" class="form-select mb-3">
                                    <option value="conservative">Ch·ªâ l·ªói th·ª±c s·ª±</option>
                                    <option value="comprehensive">G·ª£i √Ω + c·∫£i thi·ªán</option>
                                </select>
                            </div>
                        </div>
                        <button id="checkBtn" class="btn btn-primary">Ki·ªÉm tra</button>
                        
                        <!-- Results Section -->
                        <div class="mt-4" id="resultsSection" style="display: none;">
                            <!-- Status Alert -->
                            <div id="statusAlert" class="alert" role="alert"></div>
                            
                            <!-- Errors Section -->
                            <div id="errorsSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-danger mb-0">üî¥ L·ªói c·∫ßn s·ª≠a:</h5>
                                    <button id="fixAllBtn" class="btn btn-danger btn-sm" onclick="applyAllChanges('error')">
                                        üîß S·ª≠a t·∫•t c·∫£
                                    </button>
                                </div>
                                <div id="errorsList" class="mb-3"></div>
                            </div>
                            
                            <!-- Suggestions Section -->
                            <div id="suggestionsSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-info mb-0">üí° G·ª£i √Ω c·∫£i thi·ªán (t√πy ch·ªçn):</h5>
                                    <button id="applyAllSuggestionsBtn" class="btn btn-info btn-sm" onclick="applyAllChanges('suggestion')">
                                        üí° √Åp d·ª•ng t·∫•t c·∫£
                                    </button>
                                </div>
                                <div id="suggestionsList" class="mb-3"></div>
                            </div>
                            
                            <!-- Preview Section -->
                            <div id="previewSection" style="display: none;">
                                <h5>üìÑ Xem tr∆∞·ªõc k·∫øt qu·∫£:</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">VƒÉn b·∫£n g·ªëc:</label>
                                        <div id="originalText" class="border p-3 bg-light" style="min-height: 100px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label class="form-label">VƒÉn b·∫£n sau khi √°p d·ª•ng:</label>
                                            <button id="copyFinalTextBtn" class="btn btn-sm btn-outline-success" onclick="copyFinalText()" style="display: none;">
                                                üìã Copy k·∫øt qu·∫£
                                            </button>
                                        </div>
                                        <div id="finalText" class="border p-3 bg-light" style="min-height: 100px; position: relative;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Spell Check Logic with new UI
                    window.appliedChanges = new Set();
                    window.allErrors = [];
                    window.allSuggestions = [];
                    window.originalText = '';
                    
                    document.getElementById('checkBtn').addEventListener('click', async () => {
                        const input = document.getElementById('inputText').value;
                        const language = document.getElementById('languageSelect').value;
                        const mode = document.getElementById('modeSelect').value;
                        if (!input) return alert('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!');

                        const checkBtn = document.getElementById('checkBtn');
                        checkBtn.disabled = true;
                        checkBtn.textContent = 'ƒêang ki·ªÉm tra...';

                        try {
                            const response = await fetch('/api/spellcheck', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ text: input, language, mode })
                            });

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const result = await response.json();
                            
                            // Debug logging
                            console.log('Spell check result:', result);
                            
                            // Show results section
                            document.getElementById('resultsSection').style.display = 'block';
                            
                            // Store data globally
                            window.appliedChanges.clear();
                            window.allErrors = result.errors || [];
                            window.allSuggestions = result.suggestions || [];
                            window.originalText = input;
                            
                            // Show status
                            const statusAlert = document.getElementById('statusAlert');
                            if (!result.hasErrors && (!result.suggestions || result.suggestions.length === 0)) {
                                statusAlert.className = 'alert alert-success';
                                statusAlert.innerHTML = '‚úÖ <strong>Tuy·ªát v·ªùi!</strong> Kh√¥ng ph√°t hi·ªán l·ªói ch√≠nh t·∫£ ho·∫∑c ng·ªØ ph√°p n√†o.';
                                document.getElementById('errorsSection').style.display = 'none';
                                document.getElementById('suggestionsSection').style.display = 'none';
                                document.getElementById('previewSection').style.display = 'none';
                            } else {
                                statusAlert.className = 'alert alert-warning';
                                statusAlert.innerHTML = `üìù T√¨m th·∫•y ${result.errors?.length || 0} l·ªói v√† ${result.suggestions?.length || 0} g·ª£i √Ω c·∫£i thi·ªán.`;
                                
                                // Show errors
                                if (result.errors && result.errors.length > 0) {
                                    document.getElementById('errorsSection').style.display = 'block';
                                    displayChanges('errorsList', result.errors, 'error');
                                } else {
                                    document.getElementById('errorsSection').style.display = 'none';
                                }
                                
                                // Show suggestions
                                if (result.suggestions && result.suggestions.length > 0) {
                                    document.getElementById('suggestionsSection').style.display = 'block';
                                    displayChanges('suggestionsList', result.suggestions, 'suggestion');
                                } else {
                                    document.getElementById('suggestionsSection').style.display = 'none';
                                }
                                
                                // Show preview
                                document.getElementById('previewSection').style.display = 'block';
                                updatePreviewFromAppliedChanges();
                            }
                            
                        } catch (error) {
                            console.error(error);
                            document.getElementById('statusAlert').className = 'alert alert-danger';
                            document.getElementById('statusAlert').innerHTML = `‚ùå <strong>L·ªói:</strong> ${error.message}`;
                            document.getElementById('resultsSection').style.display = 'block';
                        } finally {
                            checkBtn.disabled = false;
                            checkBtn.textContent = 'Ki·ªÉm tra';
                        }
                    });

                    function displayChanges(containerId, changes, type) {
                        const container = document.getElementById(containerId);
                        const isError = type === 'error';
                        const bgColor = isError ? 'border-danger' : 'border-info';
                        const textColor = isError ? 'text-danger' : 'text-info';
                        
                        const html = changes.map((change, index) => {
                            const changeId = `${type}_${index}`;
                            return `
                                <div class="card mb-2 ${bgColor}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <span class="text-decoration-line-through text-muted">"${change.from}"</span>
                                                <span class="mx-2">‚Üí</span>
                                                <span class="${textColor} fw-bold">"${change.to}"</span>
                                                <br><small class="text-muted mt-1">
                                                    <span class="badge bg-secondary">${change.type || 'unknown'}</span> 
                                                    ${change.reason}
                                                </small>
                                            </div>
                                            <button class="btn btn-sm ${isError ? 'btn-danger' : 'btn-outline-info'}" 
                                                    onclick="toggleChange('${changeId}', '${change.from}', '${change.to}', this)">
                                                ${isError ? 'üîß S·ª≠a' : 'üí° √Åp d·ª•ng'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = html;
                    }
                    
                    // Apply all changes of a specific type
                    window.applyAllChanges = function(type) {
                        const changes = type === 'error' ? window.allErrors : window.allSuggestions;
                        changes.forEach((change, index) => {
                            const changeId = `${type}_${index}`;
                            window.appliedChanges.add(changeId);
                            
                            // Update button appearance
                            const button = document.querySelector(`[onclick*="${changeId}"]`);
                            if (button) {
                                button.textContent = '‚úÖ ƒê√£ √°p d·ª•ng';
                                button.classList.remove('btn-danger', 'btn-outline-info');
                                button.classList.add('btn-success');
                            }
                        });
                        
                        updatePreviewFromAppliedChanges();
                        
                        // Update the "Apply All" button
                        const applyAllBtn = type === 'error' ? 
                            document.getElementById('fixAllBtn') : 
                            document.getElementById('applyAllSuggestionsBtn');
                        applyAllBtn.textContent = `‚úÖ ƒê√£ √°p d·ª•ng t·∫•t c·∫£`;
                        applyAllBtn.classList.add('btn-success');
                        applyAllBtn.disabled = true;
                    };
                    
                    window.toggleChange = function(changeId, fromText, toText, button) {
                        if (window.appliedChanges.has(changeId)) {
                            window.appliedChanges.delete(changeId);
                            button.textContent = button.textContent.includes('üîß') ? 'üîß S·ª≠a' : 'üí° √Åp d·ª•ng';
                            button.classList.remove('btn-success');
                            button.classList.add(button.textContent.includes('üîß') ? 'btn-danger' : 'btn-outline-info');
                        } else {
                            window.appliedChanges.add(changeId);
                            button.textContent = '‚úÖ ƒê√£ √°p d·ª•ng';
                            button.classList.remove('btn-danger', 'btn-outline-info');
                            button.classList.add('btn-success');
                        }
                        
                        // Update preview
                        updatePreviewFromAppliedChanges();
                        
                        // Update "Apply All" button status
                        updateApplyAllButtonStatus();
                    };
                    
                    function updateApplyAllButtonStatus() {
                        // Check errors
                        const appliedErrors = window.allErrors.filter((_, index) => 
                            window.appliedChanges.has(`error_${index}`)
                        ).length;
                        const fixAllBtn = document.getElementById('fixAllBtn');
                        if (fixAllBtn) {
                            if (appliedErrors === window.allErrors.length && window.allErrors.length > 0) {
                                fixAllBtn.textContent = '‚úÖ ƒê√£ s·ª≠a t·∫•t c·∫£';
                                fixAllBtn.classList.add('btn-success');
                                fixAllBtn.disabled = true;
                            } else {
                                fixAllBtn.textContent = 'üîß S·ª≠a t·∫•t c·∫£';
                                fixAllBtn.classList.remove('btn-success');
                                fixAllBtn.disabled = false;
                            }
                        }
                        
                        // Check suggestions
                        const appliedSuggestions = window.allSuggestions.filter((_, index) => 
                            window.appliedChanges.has(`suggestion_${index}`)
                        ).length;
                        const applyAllBtn = document.getElementById('applyAllSuggestionsBtn');
                        if (applyAllBtn) {
                            if (appliedSuggestions === window.allSuggestions.length && window.allSuggestions.length > 0) {
                                applyAllBtn.textContent = '‚úÖ ƒê√£ √°p d·ª•ng t·∫•t c·∫£';
                                applyAllBtn.classList.add('btn-success');
                                applyAllBtn.disabled = true;
                            } else {
                                applyAllBtn.textContent = 'üí° √Åp d·ª•ng t·∫•t c·∫£';
                                applyAllBtn.classList.remove('btn-success');
                                applyAllBtn.disabled = false;
                            }
                        }
                    }
                    
                    function updatePreviewFromAppliedChanges() {
                        console.log('Updating preview from applied changes...');
                        let originalText = window.originalText;
                        let finalText = window.originalText;
                        
                        console.log('Original text:', originalText);
                        console.log('Applied changes:', Array.from(window.appliedChanges));
                        
                        // Apply all selected changes with highlighting
                        const allChangesToApply = [];
                        
                        // Collect all applied changes
                        window.appliedChanges.forEach(changeId => {
                            const [type, index] = changeId.split('_');
                            const changes = type === 'error' ? window.allErrors : window.allSuggestions;
                            const change = changes[parseInt(index)];
                            if (change) {
                                allChangesToApply.push({...change, type, applied: true});
                            }
                        });
                        
                        // Also collect non-applied changes for highlighting
                        [...window.allErrors, ...window.allSuggestions].forEach((change, globalIndex) => {
                            const type = globalIndex < window.allErrors.length ? 'error' : 'suggestion';
                            const localIndex = type === 'error' ? globalIndex : globalIndex - window.allErrors.length;
                            const changeId = `${type}_${localIndex}`;
                            
                            if (!window.appliedChanges.has(changeId)) {
                                allChangesToApply.push({...change, type, applied: false});
                            }
                        });
                        
                        // Sort changes by position in text (reverse order to avoid position shifts)
                        allChangesToApply.sort((a, b) => {
                            const posA = originalText.indexOf(a.from);
                            const posB = originalText.indexOf(b.from);
                            return posB - posA;
                        });
                        
                        // Apply changes to final text and create highlighted versions
                        let highlightedOriginal = originalText;
                        let highlightedFinal = originalText;
                        
                        allChangesToApply.forEach(change => {
                            // Simple exact match - avoid complex regex for Vietnamese text
                            const exactMatch = new RegExp(escapeRegex(change.from), 'gi');
                            
                            if (change.applied) {
                                // Apply the change to final text
                                finalText = finalText.replace(exactMatch, change.to);
                                
                                // Highlight in original (red = will be changed)
                                highlightedOriginal = highlightedOriginal.replace(exactMatch, 
                                    `<span style="background-color: #ffebee; text-decoration: line-through; color: #c62828;">${change.from}</span>`
                                );
                                
                                // Highlight in final text - need to apply changes first, then highlight
                            } else {
                                // Just highlight as available for change (yellow)
                                const isError = change.type === 'error';
                                const highlightColor = isError ? '#fff3e0' : '#f3e5f5';
                                const borderColor = isError ? '#ff9800' : '#9c27b0';
                                
                                highlightedOriginal = highlightedOriginal.replace(exactMatch, 
                                    `<span style="background-color: ${highlightColor}; border: 1px solid ${borderColor}; border-radius: 2px; padding: 1px 2px;">${change.from}</span>`
                                );
                            }
                        });
                        
                        // Apply highlighting to final text AFTER all changes are made
                        highlightedFinal = finalText;
                        allChangesToApply.forEach(change => {
                            if (change.applied) {
                                const toExactMatch = new RegExp(escapeRegex(change.to), 'gi');
                                highlightedFinal = highlightedFinal.replace(toExactMatch, 
                                    `<span style="background-color: #e8f5e8; font-weight: bold; color: #2e7d32;">${change.to}</span>`
                                );
                            }
                        });
                        
                        // Update the display - use innerHTML for highlighting
                        document.getElementById('originalText').innerHTML = highlightedOriginal || originalText;
                        
                        const hasAppliedChanges = allChangesToApply.some(c => c.applied);
                        if (hasAppliedChanges) {
                            document.getElementById('finalText').innerHTML = highlightedFinal;
                            document.getElementById('copyFinalTextBtn').style.display = 'inline-block';
                            // Store clean text for copying
                            window.finalCleanText = finalText;
                        } else {
                            document.getElementById('finalText').innerHTML = '<em class="text-muted">Ch·ªçn c√°c thay ƒë·ªïi b√™n tr√™n ƒë·ªÉ xem preview...</em>';
                            document.getElementById('copyFinalTextBtn').style.display = 'none';
                            window.finalCleanText = '';
                        }
                    }
                    
                    // Copy final text function
                    window.copyFinalText = function() {
                        const textToCopy = window.finalCleanText || window.originalText;
                        if (textToCopy) {
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                const copyBtn = document.getElementById('copyFinalTextBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '‚úÖ ƒê√£ copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-success');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-success');
                                }, 2000);
                            }).catch(err => {
                                console.error('Failed to copy: ', err);
                                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
                            });
                        }
                    };
                    
                    function escapeRegex(string) {
                        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    }
                    
                    // Debug function
                    function debugPreview() {
                        console.log('Original text:', window.originalText);
                        console.log('Applied changes:', Array.from(window.appliedChanges));
                        console.log('All errors:', window.allErrors);
                        console.log('All suggestions:', window.allSuggestions);
                    }
                } else if (feature === 'translate-url') {
                    content.innerHTML = `
                        <h2>D·ªãch B√†i B√°o T·ª´ URL</h2>
                        <div class="mb-3">
                            <label for="urlInput" class="form-label">Nh·∫≠p URL b√†i b√°o:</label>
                            <input type="url" class="form-control" id="urlInput" placeholder="https://example.com/article">
                        </div>
                        <div class="mb-3">
                            <label for="urlDirection" class="form-label">H∆∞·ªõng d·ªãch:</label>
                            <select id="urlDirection" class="form-select">
                                <option value="en-vi">Anh sang Vi·ªát (VnEconomy style)</option>
                                <option value="vi-en">Vi·ªát sang Anh</option>
                            </select>
                        </div>
                        <button id="translateUrlBtn" class="btn btn-primary">D·ªãch B√†i B√°o</button>
                        <div class="mt-3" id="urlResultSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>B√†i g·ªëc:</h5>
                                    <div class="border p-3 bg-light" style="max-height: 400px; overflow-y: auto;">
                                        <h6 id="originalTitle" class="text-primary"></h6>
                                        <small class="text-muted" id="originalUrl"></small>
                                        <p id="originalPreview" class="mt-2"></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>B√†i ƒë√£ d·ªãch:</h5>
                                    <div class="translation-output border p-3 bg-light" style="max-height: 400px; overflow-y: auto; position: relative;">
                                        <button id="urlCopyBtn" class="btn btn-sm btn-outline-secondary copy-btn" style="display: none;" onclick="copyUrlTranslation()">
                                            üìã Copy
                                        </button>
                                        <h6 id="translatedTitle" class="text-success"></h6>
                                        <div id="translatedContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Copy function for URL translation
                    window.copyUrlTranslation = function() {
                        const title = document.getElementById('translatedTitle').innerText;
                        const content = document.getElementById('translatedContent').innerText;
                        const fullText = title + '\n\n' + content;
                        
                        if (fullText.trim() && title !== 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ' && content !== 'Kh√¥ng c√≥ n·ªôi dung') {
                            navigator.clipboard.writeText(fullText).then(() => {
                                const copyBtn = document.getElementById('urlCopyBtn');
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = '‚úÖ ƒê√£ copy!';
                                copyBtn.classList.add('btn-success');
                                copyBtn.classList.remove('btn-outline-secondary');
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.classList.remove('btn-success');
                                    copyBtn.classList.add('btn-outline-secondary');
                                }, 2000);
                            }).catch(err => {
                                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
                            });
                        }
                    };

                    document.getElementById('translateUrlBtn').addEventListener('click', async () => {
                        const url = document.getElementById('urlInput').value;
                        const direction = document.getElementById('urlDirection').value;
                        
                        if (!url) return alert('Vui l√≤ng nh·∫≠p URL b√†i b√°o!');
                        
                        const btn = document.getElementById('translateUrlBtn');
                        const resultSection = document.getElementById('urlResultSection');
                        
                        btn.innerHTML = 'ƒêang t·∫£i v√† d·ªãch...';
                        btn.disabled = true;
                        resultSection.style.display = 'none';

                        try {
                            const response = await fetch('/api/translate-url', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url, direction })
                            });

                            if (!response.ok) throw new Error('Error: ' + response.statusText);
                            const data = await response.json();

                            // Display results
                            document.getElementById('originalTitle').innerText = data.original?.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                            document.getElementById('originalUrl').innerText = url;
                            document.getElementById('originalPreview').innerText = data.original?.content || 'Kh√¥ng c√≥ n·ªôi dung';
                            
                            document.getElementById('translatedTitle').innerText = data.translated?.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                            document.getElementById('translatedContent').innerText = data.translated?.content || 'Kh√¥ng c√≥ n·ªôi dung';
                            
                            resultSection.style.display = 'block';
                            document.getElementById('urlCopyBtn').style.display = 'block';
                            
                        } catch (error) {
                            console.error(error);
                            
                            // Try to parse error message from response
                            let errorMessage = 'L·ªói khi d·ªãch URL.';
                            if (error.message.includes('400')) {
                                errorMessage = 'Kh√¥ng th·ªÉ tr√≠ch xu·∫•t n·ªôi dung t·ª´ URL n√†y. Vui l√≤ng th·ª≠ URL kh√°c ho·∫∑c ki·ªÉm tra URL c√≥ h·ª£p l·ªá kh√¥ng.';
                            } else if (error.message.includes('500')) {
                                errorMessage = 'L·ªói server khi x·ª≠ l√Ω URL. Vui l√≤ng th·ª≠ l·∫°i sau.';
                            } else {
                                errorMessage = 'L·ªói khi d·ªãch URL: ' + error.message + '\nVui l√≤ng ki·ªÉm tra URL c√≥ h·ª£p l·ªá kh√¥ng.';
                            }
                            
                            alert(errorMessage);
                        } finally {
                            btn.innerHTML = 'D·ªãch B√†i B√°o';
                            btn.disabled = false;
                        }
                    });
                } else if (feature === 'ai-write') {
                    content.innerHTML = `
                        <h2>üìù AI Vi·∫øt B√†i T·ª± ƒê·ªông</h2>
                        <div class="card">
                            <div class="card-body">
                                <!-- Input Method Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-bullseye me-2"></i>Ngu·ªìn n·ªôi dung:</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromTopic" value="topic" checked>
                                                <label class="form-check-label" for="fromTopic">
                                                    <i class="fas fa-lightbulb me-1"></i> T·ª´ ch·ªß ƒë·ªÅ
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromHotTopics" value="hottopics">
                                                <label class="form-check-label" for="fromHotTopics">
                                                    <i class="fas fa-fire me-1"></i> Ch·ªß ƒë·ªÅ Hot
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromArticles" value="articles">
                                                <label class="form-check-label" for="fromArticles">
                                                    <i class="fas fa-newspaper me-1"></i> T·ª´ b√†i b√°o c√≥ s·∫µn
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="inputMethod" id="fromWord" value="word">
                                                <label class="form-check-label" for="fromWord">
                                                    <i class="fas fa-file-word me-1"></i> T·ª´ file Word
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Topic Input -->
                                <div id="topicInput" class="input-section">
                                    <div class="mb-3">
                                        <label for="topicText" class="form-label"><i class="fas fa-lightbulb me-2"></i>Ch·ªß ƒë·ªÅ b√†i vi·∫øt:</label>
                                        <textarea class="form-control" id="topicText" rows="3" placeholder="VD: T√°c ƒë·ªông c·ªßa AI ƒë·ªëi v·ªõi ng√†nh b√°o ch√≠ Vi·ªát Nam, xu h∆∞·ªõng ph√°t tri·ªÉn c√¥ng ngh·ªá blockchain..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="topicContext" class="form-label"><i class="fas fa-edit me-2"></i>B·ªëi c·∫£nh/G√≥c ƒë·ªô (t√πy ch·ªçn):</label>
                                        <textarea class="form-control" id="topicContext" rows="2" placeholder="Th√™m b·ªëi c·∫£nh, g√≥c ƒë·ªô ti·∫øp c·∫≠n, ho·∫∑c th√¥ng tin c·∫ßn l∆∞u √Ω..."></textarea>
                                    </div>
                                </div>

                                <!-- Hot Topics Input -->
                                <div id="hotTopicsInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label"><i class="fas fa-fire me-2"></i>Top 10 Ch·ªß ƒê·ªÅ Hot Hi·ªán T·∫°i:</label>
                                            <button id="refreshHotTopicsBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-sync-alt me-1"></i>Refresh Topics</button>
                                        </div>
                                        <div class="row align-items-center mb-3">
                                            <div class="col-md-4">
                                                <label for="categoryFilter" class="form-label small"><i class="fas fa-folder me-1"></i>Chuy√™n m·ª•c:</label>
                                                <select id="categoryFilter" class="form-select form-select-sm">
                                                    <option value="all">T·∫•t c·∫£ chuy√™n m·ª•c</option>
                                                    <option value="Kinh t·∫ø">Kinh t·∫ø</option>
                                                    <option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá</option>
                                                    <option value="X√£ h·ªôi">X√£ h·ªôi</option>
                                                    <option value="VƒÉn h√≥a">VƒÉn h√≥a</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small"><i class="fas fa-chart-line me-1"></i>Trend Score:</label>
                                                <select id="scoreFilter" class="form-select form-select-sm">
                                                    <option value="all">T·∫•t c·∫£ m·ª©c ƒë·ªô</option>
                                                    <option value="90">Si√™u Hot (90%+)</option>
                                                    <option value="80">Hot (80%+)</option>
                                                    <option value="70">Trending (70%+)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small"><i class="fas fa-rss me-1"></i>Ngu·ªìn:</label>
                                                <select id="sourceFilter" class="form-select form-select-sm">
                                                    <option value="all">T·∫•t c·∫£ ngu·ªìn</option>
                                                    <option value="Current Events">Current Events</option>
                                                    <option value="Tech Trends">Tech Trends</option>
                                                    <option value="Vietnamese">Vietnamese Topics</option>
                                                    <option value="Fallback">General Topics</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="hotTopicsLoading" class="text-center py-3" style="display: none;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                                            </div>
                                            <p class="mt-2">ƒêang l·∫•y trending topics t·ª´ Google Trends & Social Media...</p>
                                        </div>
                                        <div id="hotTopicsList" class="row">
                                            <!-- Hot topics will be populated here -->
                                        </div>
                                        <div class="mt-3">
                                            <label for="selectedTopicDetails" class="form-label"><i class="fas fa-edit me-2"></i>Chi ti·∫øt ch·ªß ƒë·ªÅ ƒë√£ ch·ªçn:</label>
                                            <div id="selectedTopicDisplay" class="alert alert-info" style="display: none;">
                                                <strong id="selectedTopicTitle">Ch∆∞a ch·ªçn ch·ªß ƒë·ªÅ</strong>
                                                <p id="selectedTopicDescription" class="mb-1"></p>
                                                <small class="text-muted">Trend score: <span id="selectedTopicScore">-</span> | Source: <span id="selectedTopicSource">-</span></small>
                                            </div>
                                            <textarea class="form-control" id="selectedTopicDetails" rows="3" placeholder="G√≥c ƒë·ªô v√† b·ªëi c·∫£nh b·ªï sung cho ch·ªß ƒë·ªÅ Hot (t√πy ch·ªçn)..." readonly></textarea>
                                            <div class="form-text"><i class="fas fa-info-circle me-1"></i>Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ Hot ·ªü tr√™n, sau ƒë√≥ c√≥ th·ªÉ th√™m g√≥c ƒë·ªô ri√™ng</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Articles Input -->
                                <div id="articlesInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label"><i class="fas fa-newspaper me-2"></i>B√†i b√°o ngu·ªìn (c√≥ th·ªÉ paste nhi·ªÅu b√†i):</label>
                                        <div id="articlesContainer">
                                            <div class="article-input mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-newspaper me-1"></i>B√†i 1</span>
                                                    <textarea class="form-control article-content" rows="4" placeholder="Paste n·ªôi dung b√†i b√°o th·ª© 1..."></textarea>
                                                    <button class="btn btn-outline-danger remove-article" type="button"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                        <button id="addArticleBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-plus me-1"></i>Th√™m b√†i b√°o</button>
                                    </div>
                                </div>

                                <!-- Word File Input -->
                                <div id="wordInput" class="input-section" style="display: none;">
                                    <div class="mb-3">
                                        <label for="wordFile" class="form-label"><i class="fas fa-file-word me-2"></i>Upload file Word:</label>
                                        <input class="form-control" type="file" id="wordFile" accept=".doc,.docx,.txt">
                                        <div class="form-text">H·ªó tr·ª£: .doc, .docx, .txt (t·ªëi ƒëa 10MB)</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="wordPreview" class="form-label"><i class="fas fa-eye me-2"></i>N·ªôi dung file (preview):</label>
                                        <textarea class="form-control" id="wordPreview" rows="5" placeholder="N·ªôi dung file s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..." readonly></textarea>
                                    </div>
                                </div>

                                <!-- Article Configuration -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="articleType" class="form-label"><i class="fas fa-file-alt me-2"></i>D·∫°ng b√†i b√°o:</label>
                                        <select id="articleType" class="form-select">
                                            <option value="tin-van">Tin v·∫Øn (200-400 t·ª´)</option>
                                            <option value="tin-tong-hop">Tin t·ªïng h·ª£p (400-800 t·ª´)</option>
                                            <option value="phong-su-ngan">Ph√≥ng s·ª± ng·∫Øn (600-1000 t·ª´)</option>
                                            <option value="bai-phan-tich">B√†i ph√¢n t√≠ch (800-1200 t·ª´)</option>
                                            <option value="phong-su-dai">Ph√≥ng s·ª± d√†i (1000-2000 t·ª´)</option>
                                            <option value="bai-binh-luan">B√†i b√¨nh lu·∫≠n (600-1000 t·ª´)</option>
                                            <option value="bao-cao-chuyen-sau">B√°o c√°o chuy√™n s√¢u (1200+ t·ª´)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="outputType" class="form-label"><i class="fas fa-cog me-2"></i>Lo·∫°i output:</label>
                                        <select id="outputType" class="form-select">
                                            <option value="outline">S∆∞·ªùn b√†i b√°o (ƒë·ªÉ editor ho√†n thi·ªán)</option>
                                            <option value="complete">B√†i b√°o ho√†n ch·ªânh</option>
                                            <option value="both">C·∫£ hai (S∆∞·ªùn + B√†i ho√†n ch·ªânh)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Writing Style Options -->
                                <div class="mb-4">
                                    <label class="form-label"><i class="fas fa-palette me-2"></i>Phong c√°ch vi·∫øt:</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <select id="writingTone" class="form-select">
                                                <option value="objective">Kh√°ch quan, trung t√≠nh</option>
                                                <option value="engaging">H·∫•p d·∫´n, thu h√∫t</option>
                                                <option value="formal">Trang tr·ªçng, ch√≠nh th·ª©c</option>
                                                <option value="casual">G·∫ßn g≈©i, d·ªÖ hi·ªÉu</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <select id="targetAudience" class="form-select">
                                                <option value="general">ƒê·ªôc gi·∫£ ƒë·∫°i ch√∫ng</option>
                                                <option value="business">C·ªông ƒë·ªìng doanh nghi·ªáp</option>
                                                <option value="tech">C·ªông ƒë·ªìng c√¥ng ngh·ªá</option>
                                                <option value="youth">Gi·ªõi tr·∫ª, sinh vi√™n</option>
                                                <option value="professional">Chuy√™n gia, chuy√™n ng√†nh</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Generate Button -->
                                <div class="text-center">
                                    <button id="generateArticleBtn" class="btn btn-primary btn-lg">
                                        <i class="fas fa-magic me-2"></i>T·∫°o B√†i B√°o AI
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div class="mt-4" id="aiWriteResults" style="display: none;">
                            <!-- Outline Section -->
                            <div id="outlineSection" class="card mb-4" style="display: none;">
                                <div class="card-header bg-info text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>S∆∞·ªùn B√†i B√°o</h5>
                                        <button class="btn btn-light btn-sm" onclick="copyContent('outlineContent')"><i class="fas fa-copy me-1"></i>Copy S∆∞·ªùn</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="outlineContent" class="content-output"></div>
                                </div>
                            </div>

                            <!-- Complete Article Section -->
                            <div id="articleSection" class="card mb-4" style="display: none;">
                                <div class="card-header bg-success text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>B√†i B√°o Ho√†n Ch·ªânh</h5>
                                        <div>
                                            <button class="btn btn-light btn-sm me-2" onclick="copyContent('articleContent')"><i class="fas fa-copy me-1"></i>Copy B√†i</button>
                                            <button class="btn btn-warning btn-sm" onclick="refineArticle()"><i class="fas fa-edit me-1"></i>Tinh Ch·ªânh</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="articleContent" class="content-output"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    // AI Writing Logic
                    setupAIWritingFeature();
                } else {
                    content.innerHTML = `<h2>${this.textContent}</h2><p>ƒêang ph√°t tri·ªÉn t√≠nh nƒÉng: ${feature}. N·ªôi dung s·∫Ω ƒë∆∞·ª£c th√™m sau.</p>`;
                }
            });
        });

        // AI Writing Feature Setup
        function setupAIWritingFeature() {
            // Input method switching
            document.querySelectorAll('input[name="inputMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.input-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    if (this.value === 'topic') {
                        document.getElementById('topicInput').style.display = 'block';
                    } else if (this.value === 'hottopics') {
                        document.getElementById('hotTopicsInput').style.display = 'block';
                        loadHotTopics(); // Load hot topics when selected
                    } else if (this.value === 'articles') {
                        document.getElementById('articlesInput').style.display = 'block';
                    } else if (this.value === 'word') {
                        document.getElementById('wordInput').style.display = 'block';
                    }
                });
            });

            // Add article functionality
            let articleCount = 1;
            document.getElementById('addArticleBtn').addEventListener('click', function() {
                articleCount++;
                const container = document.getElementById('articlesContainer');
                const newArticle = document.createElement('div');
                newArticle.className = 'article-input mb-3';
                newArticle.innerHTML = `
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-newspaper me-1"></i>B√†i ${articleCount}</span>
                        <textarea class="form-control article-content" rows="4" placeholder="Paste n·ªôi dung b√†i b√°o th·ª© ${articleCount}..."></textarea>
                        <button class="btn btn-outline-danger remove-article" type="button"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(newArticle);
            });

            // Remove article functionality
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-article')) {
                    if (document.querySelectorAll('.article-input').length > 1) {
                        e.target.closest('.article-input').remove();
                        // Renumber articles
                        document.querySelectorAll('.article-input').forEach((article, index) => {
                            article.querySelector('.input-group-text').innerHTML = `<i class="fas fa-newspaper me-1"></i>B√†i ${index + 1}`;
                            article.querySelector('textarea').placeholder = `Paste n·ªôi dung b√†i b√°o th·ª© ${index + 1}...`;
                        });
                        articleCount = document.querySelectorAll('.article-input').length;
                    } else {
                        alert('C·∫ßn √≠t nh·∫•t 1 b√†i b√°o ngu·ªìn!');
                    }
                }
            });

            // Word file upload handling
            document.getElementById('wordFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('wordPreview').value = e.target.result;
                    };
                    reader.readAsText(file);
                }
            });

            // Generate article button
            document.getElementById('generateArticleBtn').addEventListener('click', async function() {
                const btn = this;
                const originalText = btn.innerHTML;
                
                try {
                    // Collect input data
                    const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;
                    const articleType = document.getElementById('articleType').value;
                    const outputType = document.getElementById('outputType').value;
                    const writingTone = document.getElementById('writingTone').value;
                    const targetAudience = document.getElementById('targetAudience').value;

                    let inputContent = '';
                    let inputContext = '';

                    if (inputMethod === 'topic') {
                        inputContent = document.getElementById('topicText').value.trim();
                        inputContext = document.getElementById('topicContext').value.trim();
                        if (!inputContent) {
                            alert('Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ b√†i vi·∫øt!');
                            return;
                        }
                    } else if (inputMethod === 'hottopics') {
                        const selectedTopic = document.querySelector('.hot-topic-card.selected');
                        if (!selectedTopic) {
                            alert('Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ Hot t·ª´ danh s√°ch!');
                            return;
                        }
                        inputContent = selectedTopic.dataset.title;
                        const topicDescription = selectedTopic.dataset.description;
                        const additionalContext = document.getElementById('selectedTopicDetails').value.trim();
                        inputContext = `${topicDescription}${additionalContext ? '\nG√≥c ƒë·ªô b·ªï sung: ' + additionalContext : ''}`;
                        console.log('Hot topic selected:', inputContent, 'Context:', inputContext);
                    } else if (inputMethod === 'articles') {
                        const articles = Array.from(document.querySelectorAll('.article-content'))
                            .map(textarea => textarea.value.trim())
                            .filter(content => content);
                        if (articles.length === 0) {
                            alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 b√†i b√°o ngu·ªìn!');
                            return;
                        }
                                                 inputContent = articles.join('\n\n=== PH√ÇN C√ÅCH B√ÄI ===\n\n');
                    } else if (inputMethod === 'word') {
                        inputContent = document.getElementById('wordPreview').value.trim();
                        if (!inputContent) {
                            alert('Vui l√≤ng upload file Word ho·∫∑c nh·∫≠p n·ªôi dung!');
                            return;
                        }
                    }

                    // Update button state
                    btn.disabled = true;
                    btn.innerHTML = '‚è≥ ƒêang t·∫°o b√†i...';

                    // Call API
                    const response = await fetch('/api/ai-write', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            inputMethod,
                            inputContent,
                            inputContext,
                            articleType,
                            outputType,
                            writingTone,
                            targetAudience
                        })
                    });

                    if (!response.ok) {
                        throw new Error('L·ªói API: ' + response.statusText);
                    }

                    const result = await response.json();
                    
                    // Display results
                    displayAIWritingResults(result, outputType);

                } catch (error) {
                    console.error('AI Writing Error:', error);
                    alert('L·ªói khi t·∫°o b√†i: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });

            // Hot Topics functionality
            document.getElementById('refreshHotTopicsBtn').addEventListener('click', loadHotTopics);
            
            // Filter event listeners
            document.getElementById('categoryFilter').addEventListener('change', applyHotTopicsFilters);
            document.getElementById('scoreFilter').addEventListener('change', applyHotTopicsFilters);
            document.getElementById('sourceFilter').addEventListener('change', applyHotTopicsFilters);
        }

        // Global variable to store all topics
        window.allHotTopics = [];
        
        // Load hot topics from API
        async function loadHotTopics() {
            const loadingDiv = document.getElementById('hotTopicsLoading');
            const topicsList = document.getElementById('hotTopicsList');
            
            try {
                loadingDiv.style.display = 'block';
                topicsList.innerHTML = '';
                
                const response = await fetch('/api/hot-topics', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch hot topics');
                }
                
                const data = await response.json();
                
                // Store all topics globally
                window.allHotTopics = data.topics || [];
                window.categoryStats = data.categoryStats || {};
                
                // Update filter options with counts
                updateFilterOptions(data.categoryStats);
                
                // Reset filters
                document.getElementById('categoryFilter').value = 'all';
                document.getElementById('scoreFilter').value = 'all';
                document.getElementById('sourceFilter').value = 'all';
                
                // Display all topics initially
                displayHotTopics(window.allHotTopics);
                
            } catch (error) {
                console.error('Hot Topics Error:', error);
                topicsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>Kh√¥ng th·ªÉ t·∫£i ch·ªß ƒë·ªÅ Hot. <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadHotTopics()">Th·ª≠ l·∫°i</button>
                        </div>
                    </div>
                `;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Apply filters to hot topics
        function applyHotTopicsFilters() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const scoreFilter = document.getElementById('scoreFilter').value;
            const sourceFilter = document.getElementById('sourceFilter').value;
            
            let filteredTopics = [...window.allHotTopics];
            
            // Filter by category
            if (categoryFilter !== 'all') {
                filteredTopics = filteredTopics.filter(topic => 
                    topic.category === categoryFilter
                );
            }
            
            // Filter by score
            if (scoreFilter !== 'all') {
                const minScore = parseInt(scoreFilter);
                filteredTopics = filteredTopics.filter(topic => 
                    topic.score >= minScore
                );
            }
            
            // Filter by source
            if (sourceFilter !== 'all') {
                filteredTopics = filteredTopics.filter(topic => {
                    if (sourceFilter === 'Current Events') return topic.source === 'Current Events';
                    if (sourceFilter === 'Tech Trends') return topic.source === 'Tech Trends';
                    if (sourceFilter === 'Vietnamese') return topic.source.includes('Vietnamese');
                    if (sourceFilter === 'Fallback') return topic.source === 'Fallback Topics';
                    return true;
                });
            }
            
            // Display filtered topics
            displayHotTopics(filteredTopics, true); // true indicates this is a filtered view
        }

        // Display hot topics in grid
        function displayHotTopics(topics, isFiltered = false) {
            const topicsList = document.getElementById('hotTopicsList');
            
            if (!topics || topics.length === 0) {
                const message = isFiltered ? 
                    '<i class="fas fa-search me-1"></i>Kh√¥ng t√¨m th·∫•y ch·ªß ƒë·ªÅ n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.' :
                    '<i class="fas fa-list me-1"></i>Kh√¥ng c√≥ ch·ªß ƒë·ªÅ Hot n√†o.';
                const buttonText = isFiltered ? 'X√≥a b·ªô l·ªçc' : 'T·∫£i l·∫°i';
                const buttonAction = isFiltered ? 'clearFilters()' : 'loadHotTopics()';
                
                topicsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            ${message} <button class="btn btn-sm btn-outline-primary ms-2" onclick="${buttonAction}">${buttonText}</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Update topics counter
            updateTopicsCounter(topics.length, window.allHotTopics.length, isFiltered);
            
                            const topicsHTML = topics.map((topic, index) => `
                <div class="col-md-6 mb-3">
                    <div class="card hot-topic-card h-100" 
                         data-title="${topic.title}"
                         data-description="${topic.description}"
                         data-score="${topic.score}"
                         data-source="${topic.source}"
                         onclick="selectHotTopic(this)">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge bg-danger">#${index + 1}</span>
                                <small class="text-muted">${topic.source}</small>
                            </div>
                            <h6 class="card-title">${topic.title}</h6>
                            <p class="card-text text-muted small">${topic.description}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-success"><i class="fas fa-fire me-1"></i>Trend: ${topic.score}%</small>
                                <small class="text-muted">${topic.category}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            topicsList.innerHTML = topicsHTML;
        }

        // Select hot topic
        window.selectHotTopic = function(card) {
            // Remove previous selection
            document.querySelectorAll('.hot-topic-card').forEach(c => {
                c.classList.remove('selected', 'border-primary');
            });
            
            // Select current card
            card.classList.add('selected', 'border-primary');
            
            // Update details
            const title = card.dataset.title;
            const description = card.dataset.description;
            const score = card.dataset.score;
            const source = card.dataset.source;
            
            document.getElementById('selectedTopicTitle').textContent = title;
            document.getElementById('selectedTopicDescription').textContent = description;
            document.getElementById('selectedTopicScore').textContent = score + '%';
            document.getElementById('selectedTopicSource').textContent = source;
            document.getElementById('selectedTopicDisplay').style.display = 'block';
            
            // Enable context input
            const contextInput = document.getElementById('selectedTopicDetails');
            contextInput.readOnly = false;
            contextInput.placeholder = 'Th√™m g√≥c ƒë·ªô, b·ªëi c·∫£nh ri√™ng cho ch·ªß ƒë·ªÅ "' + title + '"...';
        }

        // Update topics counter
        function updateTopicsCounter(filteredCount, totalCount, isFiltered) {
            const counterElement = document.getElementById('topicsCounter');
            if (!counterElement) {
                // Create counter element if it doesn't exist
                const labelsRow = document.querySelector('#hotTopicsInput .d-flex.justify-content-between');
                if (labelsRow) {
                    const counter = document.createElement('small');
                    counter.id = 'topicsCounter';
                    counter.className = 'text-muted';
                    labelsRow.appendChild(counter);
                }
            }
            
            const counter = document.getElementById('topicsCounter');
            if (counter) {
                if (isFiltered) {
                    counter.innerHTML = `<i class="fas fa-filter me-1"></i>Hi·ªÉn th·ªã <strong>${filteredCount}</strong>/<strong>${totalCount}</strong> ch·ªß ƒë·ªÅ`;
                    counter.className = 'text-info fw-bold';
                } else {
                    counter.innerHTML = `<i class="fas fa-list-ul me-1"></i>T·ªïng c·ªông <strong>${totalCount}</strong> ch·ªß ƒë·ªÅ Hot`;
                    counter.className = 'text-muted';
                }
            }
        }

                 // Clear all filters
        window.clearFilters = function() {
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('scoreFilter').value = 'all'; 
            document.getElementById('sourceFilter').value = 'all';
            
            // Display all topics
            displayHotTopics(window.allHotTopics);
        }

        // Update filter options with counts
        function updateFilterOptions(stats) {
            if (!stats) return;
            
            // Update category filter options
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = stats.categories || {};
            
            // Reset to default options with counts
            categoryFilter.innerHTML = `
                <option value="all">T·∫•t c·∫£ chuy√™n m·ª•c (${stats.total || 0})</option>
                <option value="Kinh t·∫ø">Kinh t·∫ø (${categories['Kinh t·∫ø'] || 0})</option>
                <option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá (${categories['C√¥ng ngh·ªá'] || 0})</option>
                <option value="X√£ h·ªôi">X√£ h·ªôi (${categories['X√£ h·ªôi'] || 0})</option>
                <option value="VƒÉn h√≥a">VƒÉn h√≥a (${categories['VƒÉn h√≥a'] || 0})</option>
            `;
            
            // Update score filter options
            const scoreFilter = document.getElementById('scoreFilter');
            const scoreRanges = stats.scoreRanges || {};
            scoreFilter.innerHTML = `
                <option value="all">T·∫•t c·∫£ m·ª©c ƒë·ªô (${stats.total || 0})</option>
                <option value="90">Si√™u Hot 90%+ (${scoreRanges.super_hot || 0})</option>
                <option value="80">Hot 80%+ (${(scoreRanges.super_hot || 0) + (scoreRanges.hot || 0)})</option>
                <option value="70">Trending 70%+ (${stats.total || 0})</option>
            `;
            
            // Update source filter options  
            const sourceFilter = document.getElementById('sourceFilter');
            const sources = stats.sources || {};
            const currentEvents = sources['Current Events'] || 0;
            const techTrends = sources['Tech Trends'] || 0;
            const vietnamese = Object.keys(sources).filter(s => s.includes('Vietnamese')).reduce((sum, key) => sum + (sources[key] || 0), 0);
            const fallback = sources['Fallback Topics'] || 0;
            
            sourceFilter.innerHTML = `
                <option value="all">T·∫•t c·∫£ ngu·ªìn (${stats.total || 0})</option>
                <option value="Current Events">Current Events (${currentEvents})</option>
                <option value="Tech Trends">Tech Trends (${techTrends})</option>
                <option value="Vietnamese">Vietnamese Topics (${vietnamese})</option>
                <option value="Fallback">General Topics (${fallback})</option>
            `;
        }

        function displayAIWritingResults(result, outputType) {
            const resultsSection = document.getElementById('aiWriteResults');
            const outlineSection = document.getElementById('outlineSection');
            const articleSection = document.getElementById('articleSection');

            resultsSection.style.display = 'block';

            if (outputType === 'outline' || outputType === 'both') {
                document.getElementById('outlineContent').innerHTML = formatContent(result.outline || result.content);
                outlineSection.style.display = 'block';
            } else {
                outlineSection.style.display = 'none';
            }

            if (outputType === 'complete' || outputType === 'both') {
                document.getElementById('articleContent').innerHTML = formatContent(result.article || result.content);
                articleSection.style.display = 'block';
            } else {
                articleSection.style.display = 'none';
            }

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

                 function formatContent(content) {
             if (!content) return '<em>Kh√¥ng c√≥ n·ªôi dung</em>';
             
             return content
                 .split('\n')
                 .map(line => {
                     line = line.trim();
                     if (!line) return '';
                     
                     // Format headers
                     if (line.startsWith('#')) {
                         const level = line.match(/^#+/)[0].length;
                         const text = line.replace(/^#+\s*/, '');
                         return `<h${level + 2} class="text-primary mt-3 mb-2">${text}</h${level + 2}>`;
                     }
                     
                     // Format bold text
                     line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                     
                     // Format italic text  
                     line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
                     
                     // Regular paragraph
                     return `<p class="mb-2">${line}</p>`;
                 })
                 .filter(line => line) // Remove empty lines
                 .join('');
         }

        // Copy content function
        window.copyContent = function(elementId) {
            const element = document.getElementById(elementId);
            const text = element.innerText || element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ ƒê√£ copy!';
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-light');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
            });
        };

        // Refine article function
        window.refineArticle = function() {
            // TODO: Implement article refinement functionality
            alert('T√≠nh nƒÉng tinh ch·ªânh ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        };
    </script>
</body>
</html> 